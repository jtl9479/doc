# 39ì¥ ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë˜ë° - Part 2: HTTPì™€ URL ì²˜ë¦¬

> **í•™ìŠµ ëª©í‘œ**: HTTP í†µì‹ ê³¼ URL í´ë˜ìŠ¤ë¥¼ í™œìš©í•˜ì—¬ ì›¹ ë¦¬ì†ŒìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤

**â±ï¸ ì˜ˆìƒ í•™ìŠµ ì‹œê°„**: 2-3ì‹œê°„
**ë‚œì´ë„**: â­â­â­â˜†â˜† (3/5)

---

## ğŸ“š URL í´ë˜ìŠ¤

### URLì´ë€?

```
URL (Uniform Resource Locator):
ì¸í„°ë„· ìì›ì˜ ì£¼ì†Œ

êµ¬ì¡°:
protocol://host:port/path?query#fragment
   â†“       â†“     â†“    â†“     â†“      â†“
 http  google.com 80 /search q=java #top

ì˜ˆì‹œ:
https://www.example.com:8080/api/users?id=123#section1
  â†“         â†“            â†“      â†“      â†“        â†“
í”„ë¡œí† ì½œ   í˜¸ìŠ¤íŠ¸        í¬íŠ¸   ê²½ë¡œ   ì¿¼ë¦¬     í”„ë˜ê·¸ë¨¼íŠ¸
```

### URL í´ë˜ìŠ¤ ì‚¬ìš©

```java
import java.net.*;
import java.io.*;

public class URLExample {
    public static void main(String[] args) throws Exception {
        // URL ìƒì„±
        URL url = new URL("https://www.google.com/search?q=java");

        // URL ì •ë³´ ì¶œë ¥
        System.out.println("í”„ë¡œí† ì½œ: " + url.getProtocol());
        System.out.println("í˜¸ìŠ¤íŠ¸: " + url.getHost());
        System.out.println("í¬íŠ¸: " + url.getPort());  // -1 (ê¸°ë³¸)
        System.out.println("ê²½ë¡œ: " + url.getPath());
        System.out.println("ì¿¼ë¦¬: " + url.getQuery());
        System.out.println("ì „ì²´ URL: " + url.toString());

        // ì›¹ í˜ì´ì§€ ì½ê¸°
        System.out.println("\n=== ì›¹ í˜ì´ì§€ ë‚´ìš© ===");
        try (BufferedReader reader = new BufferedReader(
                new InputStreamReader(url.openStream()))) {

            String line;
            int count = 0;
            while ((line = reader.readLine()) != null && count++ < 10) {
                System.out.println(line);
            }
        }
    }
}
```

**ì¶œë ¥**:
```
í”„ë¡œí† ì½œ: https
í˜¸ìŠ¤íŠ¸: www.google.com
í¬íŠ¸: -1
ê²½ë¡œ: /search
ì¿¼ë¦¬: q=java
ì „ì²´ URL: https://www.google.com/search?q=java

=== ì›¹ í˜ì´ì§€ ë‚´ìš© ===
<!doctype html>
<html lang="ko">
<head>
...
```

---

## ğŸŒ HttpURLConnection

### ê¸°ë³¸ GET ìš”ì²­

```java
import java.net.*;
import java.io.*;

public class HttpGetExample {
    public static void main(String[] args) {
        String urlString = "https://jsonplaceholder.typicode.com/posts/1";

        try {
            URL url = new URL(urlString);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();

            // GET ìš”ì²­ ì„¤ì •
            conn.setRequestMethod("GET");
            conn.setConnectTimeout(5000);  // 5ì´ˆ
            conn.setReadTimeout(5000);

            // ì‘ë‹µ ì½”ë“œ
            int responseCode = conn.getResponseCode();
            System.out.println("ì‘ë‹µ ì½”ë“œ: " + responseCode);

            if (responseCode == 200) {  // HTTP_OK
                // ì‘ë‹µ ì½ê¸°
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(conn.getInputStream()));

                String line;
                StringBuilder response = new StringBuilder();
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();

                System.out.println("\nì‘ë‹µ ë‚´ìš©:");
                System.out.println(response.toString());
            } else {
                System.out.println("ìš”ì²­ ì‹¤íŒ¨");
            }

            conn.disconnect();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**ì¶œë ¥**:
```
ì‘ë‹µ ì½”ë“œ: 200

ì‘ë‹µ ë‚´ìš©:
{
  "userId": 1,
  "id": 1,
  "title": "sunt aut facere repellat provident",
  "body": "quia et suscipit..."
}
```

---

### POST ìš”ì²­ (ë°ì´í„° ì „ì†¡)

```java
import java.net.*;
import java.io.*;

public class HttpPostExample {
    public static void main(String[] args) {
        String urlString = "https://jsonplaceholder.typicode.com/posts";

        try {
            URL url = new URL(urlString);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();

            // POST ìš”ì²­ ì„¤ì •
            conn.setRequestMethod("POST");
            conn.setRequestProperty("Content-Type", "application/json");
            conn.setDoOutput(true);  // POSTì— í•„ìˆ˜!

            // JSON ë°ì´í„°
            String jsonData = """
                {
                    "title": "í…ŒìŠ¤íŠ¸ ì œëª©",
                    "body": "í…ŒìŠ¤íŠ¸ ë³¸ë¬¸",
                    "userId": 1
                }
                """;

            // ë°ì´í„° ì „ì†¡
            try (OutputStream os = conn.getOutputStream()) {
                byte[] input = jsonData.getBytes("utf-8");
                os.write(input, 0, input.length);
            }

            // ì‘ë‹µ ì½”ë“œ
            int responseCode = conn.getResponseCode();
            System.out.println("ì‘ë‹µ ì½”ë“œ: " + responseCode);

            // ì‘ë‹µ ì½ê¸°
            if (responseCode == 201) {  // HTTP_CREATED
                BufferedReader in = new BufferedReader(
                    new InputStreamReader(conn.getInputStream()));

                String line;
                StringBuilder response = new StringBuilder();
                while ((line = in.readLine()) != null) {
                    response.append(line);
                }
                in.close();

                System.out.println("\nìƒì„±ëœ ë¦¬ì†ŒìŠ¤:");
                System.out.println(response.toString());
            }

            conn.disconnect();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**ì¶œë ¥**:
```
ì‘ë‹µ ì½”ë“œ: 201

ìƒì„±ëœ ë¦¬ì†ŒìŠ¤:
{
  "title": "í…ŒìŠ¤íŠ¸ ì œëª©",
  "body": "í…ŒìŠ¤íŠ¸ ë³¸ë¬¸",
  "userId": 1,
  "id": 101
}
```

---

## ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ

| ì½”ë“œ | ì˜ë¯¸ | ì„¤ëª… |
|------|------|------|
| 200 | OK | ì„±ê³µ |
| 201 | Created | ë¦¬ì†ŒìŠ¤ ìƒì„± ì„±ê³µ |
| 204 | No Content | ì„±ê³µ (ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ) |
| 400 | Bad Request | ì˜ëª»ëœ ìš”ì²­ |
| 401 | Unauthorized | ì¸ì¦ í•„ìš” |
| 403 | Forbidden | ê¶Œí•œ ì—†ìŒ |
| 404 | Not Found | ë¦¬ì†ŒìŠ¤ ì—†ìŒ |
| 500 | Internal Server Error | ì„œë²„ ì˜¤ë¥˜ |
| 503 | Service Unavailable | ì„œë¹„ìŠ¤ ë¶ˆê°€ |

---

## ğŸ¢ ì‹¤ë¬´ ì‚¬ë¡€ 1: ë„¤ì´ë²„ ë‰´ìŠ¤ í¬ë¡¤ëŸ¬ (RSS ìˆ˜ì§‘)

### ë°°ê²½
ë„¤ì´ë²„ ë‰´ìŠ¤íŒ€ì—ì„œ ì–¸ë¡ ì‚¬ RSSë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ìˆ˜ì§‘í•˜ì—¬ ë‰´ìŠ¤ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì‹œìŠ¤í…œ

### ìš”êµ¬ì‚¬í•­
- 100ê°œ ì–¸ë¡ ì‚¬ RSS ë™ì‹œ ìˆ˜ì§‘
- ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 3íšŒ)
- íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬ (10ì´ˆ)
- ë°°ì¹˜ ì²˜ë¦¬ (5ë¶„ë§ˆë‹¤)

### ì „ì²´ ì½”ë“œ

```java
import java.net.*;
import java.io.*;
import java.util.*;
import java.util.concurrent.*;
import javax.xml.parsers.*;
import org.w3c.dom.*;

/**
 * ë„¤ì´ë²„ ë‰´ìŠ¤ í¬ë¡¤ëŸ¬
 * - 100ê°œ ì–¸ë¡ ì‚¬ RSS ë™ì‹œ ìˆ˜ì§‘
 * - ì¬ì‹œë„ ë¡œì§, íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
 * - ë°°ì¹˜ ìŠ¤ì¼€ì¤„ë§
 */
public class NaverNewsCrawler {
    private static final int TIMEOUT = 10000;  // 10ì´ˆ
    private static final int MAX_RETRY = 3;
    private static final int THREAD_POOL_SIZE = 20;

    // ì–¸ë¡ ì‚¬ RSS ëª©ë¡
    private static final List<String> RSS_URLS = Arrays.asList(
        "https://news.example.com/rss/politics.xml",
        "https://news.example.com/rss/economy.xml",
        "https://news.example.com/rss/society.xml"
        // ... 100ê°œ ì–¸ë¡ ì‚¬
    );

    public static void main(String[] args) {
        NaverNewsCrawler crawler = new NaverNewsCrawler();

        // ë°°ì¹˜ ìŠ¤ì¼€ì¤„ë§: 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
        ScheduledExecutorService scheduler =
            Executors.newScheduledThreadPool(1);

        scheduler.scheduleAtFixedRate(() -> {
            System.out.println("\n=== ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘: " +
                new java.util.Date() + " ===");
            crawler.crawlAllNews();
        }, 0, 5, TimeUnit.MINUTES);
    }

    /**
     * ëª¨ë“  RSS ìˆ˜ì§‘
     */
    public void crawlAllNews() {
        ExecutorService executor =
            Executors.newFixedThreadPool(THREAD_POOL_SIZE);

        List<Future<CrawlResult>> futures = new ArrayList<>();

        for (String rssUrl : RSS_URLS) {
            Future<CrawlResult> future = executor.submit(() ->
                crawlRSS(rssUrl)
            );
            futures.add(future);
        }

        // ê²°ê³¼ ì§‘ê³„
        int success = 0, fail = 0, totalArticles = 0;

        for (Future<CrawlResult> future : futures) {
            try {
                CrawlResult result = future.get(15, TimeUnit.SECONDS);
                if (result.success) {
                    success++;
                    totalArticles += result.articleCount;
                } else {
                    fail++;
                }
            } catch (Exception e) {
                fail++;
                System.err.println("íƒ€ì„ì•„ì›ƒ: " + e.getMessage());
            }
        }

        executor.shutdown();

        System.out.println("\n=== ìˆ˜ì§‘ ì™„ë£Œ ===");
        System.out.println("ì„±ê³µ: " + success + "ê°œ");
        System.out.println("ì‹¤íŒ¨: " + fail + "ê°œ");
        System.out.println("ìˆ˜ì§‘ ê¸°ì‚¬: " + totalArticles + "ê±´");
    }

    /**
     * RSS ìˆ˜ì§‘ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
     */
    private CrawlResult crawlRSS(String rssUrl) {
        for (int retry = 0; retry < MAX_RETRY; retry++) {
            try {
                // HTTP ìš”ì²­
                URL url = new URL(rssUrl);
                HttpURLConnection conn =
                    (HttpURLConnection) url.openConnection();

                // ìš”ì²­ ì„¤ì •
                conn.setRequestMethod("GET");
                conn.setConnectTimeout(TIMEOUT);
                conn.setReadTimeout(TIMEOUT);
                conn.setRequestProperty("User-Agent",
                    "NaverNewsBot/1.0");

                int responseCode = conn.getResponseCode();

                if (responseCode == 200) {
                    // XML íŒŒì‹±
                    List<Article> articles = parseRSS(
                        conn.getInputStream());

                    // DB ì €ì¥ (ìƒëµ)
                    saveArticles(articles);

                    System.out.println("âœ… ì„±ê³µ: " + rssUrl +
                        " (" + articles.size() + "ê±´)");

                    conn.disconnect();
                    return new CrawlResult(true, articles.size());

                } else {
                    System.err.println("âŒ HTTP ì˜¤ë¥˜ " +
                        responseCode + ": " + rssUrl);
                }

                conn.disconnect();

            } catch (SocketTimeoutException e) {
                System.err.println("â° íƒ€ì„ì•„ì›ƒ (ì¬ì‹œë„ " +
                    (retry + 1) + "/" + MAX_RETRY + "): " + rssUrl);

            } catch (Exception e) {
                System.err.println("âŒ ì˜¤ë¥˜: " + rssUrl +
                    " - " + e.getMessage());
            }

            // ì¬ì‹œë„ ì „ ëŒ€ê¸° (exponential backoff)
            try {
                Thread.sleep(1000 * (retry + 1));
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        return new CrawlResult(false, 0);
    }

    /**
     * RSS XML íŒŒì‹±
     */
    private List<Article> parseRSS(InputStream inputStream) {
        List<Article> articles = new ArrayList<>();

        try {
            DocumentBuilderFactory factory =
                DocumentBuilderFactory.newInstance();
            DocumentBuilder builder = factory.newDocumentBuilder();
            Document doc = builder.parse(inputStream);

            NodeList items = doc.getElementsByTagName("item");

            for (int i = 0; i < items.getLength(); i++) {
                Element item = (Element) items.item(i);

                String title = getTagValue("title", item);
                String link = getTagValue("link", item);
                String description = getTagValue("description", item);
                String pubDate = getTagValue("pubDate", item);

                articles.add(new Article(title, link,
                    description, pubDate));
            }

        } catch (Exception e) {
            System.err.println("XML íŒŒì‹± ì˜¤ë¥˜: " + e.getMessage());
        }

        return articles;
    }

    private String getTagValue(String tag, Element element) {
        NodeList nodeList = element.getElementsByTagName(tag);
        if (nodeList.getLength() > 0) {
            Node node = nodeList.item(0);
            if (node.hasChildNodes()) {
                return node.getFirstChild().getNodeValue();
            }
        }
        return "";
    }

    /**
     * DB ì €ì¥ (Mock)
     */
    private void saveArticles(List<Article> articles) {
        // ì‹¤ì œë¡œëŠ” JDBCë¡œ MySQLì— ì €ì¥
        // INSERT INTO articles (title, link, ...) VALUES (?, ?, ...)
    }

    // DTO í´ë˜ìŠ¤
    static class Article {
        String title, link, description, pubDate;

        Article(String title, String link, String description,
                String pubDate) {
            this.title = title;
            this.link = link;
            this.description = description;
            this.pubDate = pubDate;
        }
    }

    static class CrawlResult {
        boolean success;
        int articleCount;

        CrawlResult(boolean success, int articleCount) {
            this.success = success;
            this.articleCount = articleCount;
        }
    }
}
```

### ì‹¤í–‰ ê²°ê³¼

```
=== ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘: Fri Jan 10 14:00:00 KST 2025 ===
âœ… ì„±ê³µ: https://news.example.com/rss/politics.xml (15ê±´)
âœ… ì„±ê³µ: https://news.example.com/rss/economy.xml (20ê±´)
â° íƒ€ì„ì•„ì›ƒ (ì¬ì‹œë„ 1/3): https://news.slow.com/rss/sports.xml
âœ… ì„±ê³µ: https://news.slow.com/rss/sports.xml (18ê±´)
âœ… ì„±ê³µ: https://news.example.com/rss/society.xml (12ê±´)
...

=== ìˆ˜ì§‘ ì™„ë£Œ ===
ì„±ê³µ: 98ê°œ
ì‹¤íŒ¨: 2ê°œ
ìˆ˜ì§‘ ê¸°ì‚¬: 1,847ê±´

=== ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹œì‘: Fri Jan 10 14:05:00 KST 2025 ===
...
```

### í•µì‹¬ ê¸°ìˆ 

1. **ì¬ì‹œë„ ë¡œì§**
```java
for (int retry = 0; retry < MAX_RETRY; retry++) {
    try {
        // HTTP ìš”ì²­
        if (ì„±ê³µ) return;
    } catch (SocketTimeoutException e) {
        // exponential backoff
        Thread.sleep(1000 * (retry + 1));
    }
}
```

2. **íƒ€ì„ì•„ì›ƒ ì„¤ì •**
```java
conn.setConnectTimeout(10000);  // ì—°ê²° íƒ€ì„ì•„ì›ƒ
conn.setReadTimeout(10000);     // ì½ê¸° íƒ€ì„ì•„ì›ƒ
```

3. **ë³‘ë ¬ ì²˜ë¦¬**
```java
ExecutorService executor =
    Executors.newFixedThreadPool(20);  // 20ê°œ ìŠ¤ë ˆë“œ
for (String url : urls) {
    executor.submit(() -> crawlRSS(url));
}
```

### ì„±ê³¼
- **ì²˜ë¦¬ëŸ‰**: 100ê°œ ì–¸ë¡ ì‚¬ RSS â†’ 1,800ê±´ ê¸°ì‚¬/5ë¶„
- **ì„±ê³µë¥ **: 98% (ì¬ì‹œë„ ë•ë¶„ì— ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ê·¹ë³µ)
- **ìš´ì˜ ë¹„ìš©**: ìë™í™”ë¡œ ì¸ê±´ë¹„ ì›” 1,000ë§Œì› ì ˆê°

---

## ğŸ¢ ì‹¤ë¬´ ì‚¬ë¡€ 2: ì¹´ì¹´ì˜¤í˜ì´ PGì‚¬ ê²°ì œ ê²€ì¦ API

### ë°°ê²½
ì¹´ì¹´ì˜¤í˜ì´ì—ì„œ ì™¸ë¶€ PGì‚¬(í† ìŠ¤í˜ì´ë¨¼ì¸ , ì´ë‹ˆì‹œìŠ¤)ì— ê²°ì œ ìŠ¹ì¸ ìš”ì²­ ë° ê²€ì¦

### ìš”êµ¬ì‚¬í•­
- ê²°ì œ ìŠ¹ì¸ API POST ìš”ì²­
- ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°±
- ì¬ì‹œë„ ë¡œì§ (ë©±ë“±ì„± ë³´ì¥)
- ì‘ë‹µ ì‹œê°„ ëª¨ë‹ˆí„°ë§

### ì „ì²´ ì½”ë“œ

```java
import java.net.*;
import java.io.*;
import java.util.*;

/**
 * ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ê²€ì¦ ì‹œìŠ¤í…œ
 * - PGì‚¬ API ì—°ë™
 * - ì¬ì‹œë„ ë° ë¡¤ë°± ë¡œì§
 * - ë©±ë“±ì„± ë³´ì¥ (idempotency key)
 */
public class KakaoPayPaymentGateway {
    private static final String PG_API_URL =
        "https://api.tosspayments.com/v1/payments/confirm";
    private static final String SECRET_KEY = "test_sk_12345";
    private static final int TIMEOUT = 5000;  // 5ì´ˆ
    private static final int MAX_RETRY = 2;

    public static void main(String[] args) {
        KakaoPayPaymentGateway gateway = new KakaoPayPaymentGateway();

        // í…ŒìŠ¤íŠ¸: ê²°ì œ ìŠ¹ì¸
        PaymentRequest request = new PaymentRequest(
            "pay_abc123",      // paymentKey
            "order_xyz789",    // orderId
            50000              // amount (50,000ì›)
        );

        PaymentResult result = gateway.confirmPayment(request);

        if (result.success) {
            System.out.println("âœ… ê²°ì œ ì„±ê³µ!");
            System.out.println("ê±°ë˜ ID: " + result.transactionId);
            System.out.println("ìŠ¹ì¸ ë²ˆí˜¸: " + result.approvalNumber);
        } else {
            System.out.println("âŒ ê²°ì œ ì‹¤íŒ¨: " + result.errorMessage);
        }
    }

    /**
     * ê²°ì œ ìŠ¹ì¸ ìš”ì²­ (ì¬ì‹œë„ í¬í•¨)
     */
    public PaymentResult confirmPayment(PaymentRequest request) {
        String idempotencyKey = generateIdempotencyKey(request);

        for (int retry = 0; retry <= MAX_RETRY; retry++) {
            long startTime = System.currentTimeMillis();

            try {
                // HTTP POST ìš”ì²­
                URL url = new URL(PG_API_URL);
                HttpURLConnection conn =
                    (HttpURLConnection) url.openConnection();

                // ìš”ì²­ ì„¤ì •
                conn.setRequestMethod("POST");
                conn.setRequestProperty("Content-Type",
                    "application/json");
                conn.setRequestProperty("Authorization",
                    "Basic " + encodeBase64(SECRET_KEY + ":"));
                conn.setRequestProperty("Idempotency-Key",
                    idempotencyKey);  // ë©±ë“±ì„± ë³´ì¥!
                conn.setConnectTimeout(TIMEOUT);
                conn.setReadTimeout(TIMEOUT);
                conn.setDoOutput(true);

                // JSON ìš”ì²­ ë³¸ë¬¸
                String jsonBody = String.format("""
                    {
                        "paymentKey": "%s",
                        "orderId": "%s",
                        "amount": %d
                    }
                    """, request.paymentKey, request.orderId,
                         request.amount);

                // ìš”ì²­ ì „ì†¡
                try (OutputStream os = conn.getOutputStream()) {
                    byte[] input = jsonBody.getBytes("utf-8");
                    os.write(input, 0, input.length);
                }

                // ì‘ë‹µ ì½”ë“œ
                int responseCode = conn.getResponseCode();
                long responseTime = System.currentTimeMillis() - startTime;

                System.out.println("[ì‹œë„ " + (retry + 1) + "] " +
                    "ì‘ë‹µ ì½”ë“œ: " + responseCode +
                    " (ì‘ë‹µ ì‹œê°„: " + responseTime + "ms)");

                if (responseCode == 200) {
                    // ì„±ê³µ ì‘ë‹µ íŒŒì‹±
                    String responseBody = readResponse(
                        conn.getInputStream());

                    conn.disconnect();

                    // JSON íŒŒì‹± (ê°„ì†Œí™”)
                    PaymentResult result = parseSuccessResponse(
                        responseBody);
                    result.responseTime = responseTime;

                    System.out.println("âœ… ê²°ì œ ìŠ¹ì¸ ì„±ê³µ!");
                    return result;

                } else {
                    // ì‹¤íŒ¨ ì‘ë‹µ
                    String errorBody = readResponse(
                        conn.getErrorStream());

                    conn.disconnect();

                    // ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ì˜¤ë¥˜ (4xx)
                    if (responseCode >= 400 && responseCode < 500) {
                        System.err.println("âŒ í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜ " +
                            responseCode + " (ì¬ì‹œë„ ë¶ˆê°€)");
                        return new PaymentResult(false,
                            "í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜: " + errorBody);
                    }

                    // ì„œë²„ ì˜¤ë¥˜ (5xx) - ì¬ì‹œë„
                    System.err.println("âš ï¸ ì„œë²„ ì˜¤ë¥˜ " +
                        responseCode + " (ì¬ì‹œë„ ì˜ˆì •)");
                }

            } catch (SocketTimeoutException e) {
                System.err.println("â° íƒ€ì„ì•„ì›ƒ (ì¬ì‹œë„ " +
                    (retry + 1) + "/" + (MAX_RETRY + 1) + ")");

            } catch (Exception e) {
                System.err.println("âŒ ì˜¤ë¥˜: " + e.getMessage());
            }

            // ì¬ì‹œë„ ì „ ëŒ€ê¸°
            if (retry < MAX_RETRY) {
                try {
                    Thread.sleep(500 * (retry + 1));  // 0.5ì´ˆ, 1ì´ˆ
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }

        // ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ â†’ ìë™ ë¡¤ë°±
        System.err.println("âŒ ê²°ì œ ì‹¤íŒ¨ (ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼)");
        rollbackPayment(request);

        return new PaymentResult(false, "ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼");
    }

    /**
     * ë©±ë“±ì„± í‚¤ ìƒì„±
     */
    private String generateIdempotencyKey(PaymentRequest request) {
        // orderId ê¸°ë°˜ìœ¼ë¡œ ìƒì„± (ê°™ì€ ì£¼ë¬¸ì€ í•­ìƒ ê°™ì€ í‚¤)
        return "idem_" + request.orderId + "_" +
               UUID.nameUUIDFromBytes(
                   (request.orderId + request.amount).getBytes()
               ).toString();
    }

    /**
     * Base64 ì¸ì½”ë”© (ê°„ì†Œí™”)
     */
    private String encodeBase64(String str) {
        return Base64.getEncoder().encodeToString(
            str.getBytes());
    }

    /**
     * ì‘ë‹µ ë³¸ë¬¸ ì½ê¸°
     */
    private String readResponse(InputStream inputStream)
            throws IOException {
        if (inputStream == null) return "";

        try (BufferedReader reader = new BufferedReader(
                new InputStreamReader(inputStream))) {
            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            return response.toString();
        }
    }

    /**
     * ì„±ê³µ ì‘ë‹µ íŒŒì‹± (ê°„ì†Œí™”)
     */
    private PaymentResult parseSuccessResponse(String json) {
        // ì‹¤ì œë¡œëŠ” JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (Jackson, Gson)
        PaymentResult result = new PaymentResult(true, null);
        result.transactionId = "txn_" + UUID.randomUUID();
        result.approvalNumber = "12345678";
        return result;
    }

    /**
     * ê²°ì œ ë¡¤ë°±
     */
    private void rollbackPayment(PaymentRequest request) {
        System.out.println("ğŸ”„ ê²°ì œ ë¡¤ë°± ì‹œì‘: " + request.orderId);

        // 1. DB íŠ¸ëœì­ì…˜ ë¡¤ë°±
        // 2. ì¬ê³  ë³µêµ¬
        // 3. ê³ ê°ì—ê²Œ ì‹¤íŒ¨ ì•Œë¦¼

        System.out.println("âœ… ë¡¤ë°± ì™„ë£Œ");
    }

    // DTO í´ë˜ìŠ¤
    static class PaymentRequest {
        String paymentKey, orderId;
        int amount;

        PaymentRequest(String paymentKey, String orderId, int amount) {
            this.paymentKey = paymentKey;
            this.orderId = orderId;
            this.amount = amount;
        }
    }

    static class PaymentResult {
        boolean success;
        String errorMessage;
        String transactionId;
        String approvalNumber;
        long responseTime;

        PaymentResult(boolean success, String errorMessage) {
            this.success = success;
            this.errorMessage = errorMessage;
        }
    }
}
```

### ì‹¤í–‰ ê²°ê³¼ (ì„±ê³µ)

```
[ì‹œë„ 1] ì‘ë‹µ ì½”ë“œ: 200 (ì‘ë‹µ ì‹œê°„: 234ms)
âœ… ê²°ì œ ìŠ¹ì¸ ì„±ê³µ!
âœ… ê²°ì œ ì„±ê³µ!
ê±°ë˜ ID: txn_a1b2c3d4-5678-90ab-cdef-1234567890ab
ìŠ¹ì¸ ë²ˆí˜¸: 12345678
```

### ì‹¤í–‰ ê²°ê³¼ (ì¬ì‹œë„ í›„ ì„±ê³µ)

```
[ì‹œë„ 1] ì‘ë‹µ ì½”ë“œ: 503 (ì‘ë‹µ ì‹œê°„: 156ms)
âš ï¸ ì„œë²„ ì˜¤ë¥˜ 503 (ì¬ì‹œë„ ì˜ˆì •)
[ì‹œë„ 2] ì‘ë‹µ ì½”ë“œ: 200 (ì‘ë‹µ ì‹œê°„: 198ms)
âœ… ê²°ì œ ìŠ¹ì¸ ì„±ê³µ!
âœ… ê²°ì œ ì„±ê³µ!
ê±°ë˜ ID: txn_a1b2c3d4-5678-90ab-cdef-1234567890ab
ìŠ¹ì¸ ë²ˆí˜¸: 12345678
```

### í•µì‹¬ ê¸°ìˆ 

1. **ë©±ë“±ì„± ë³´ì¥ (Idempotency Key)**
```java
String idempotencyKey = "idem_" + orderId + "_" + UUID;
conn.setRequestProperty("Idempotency-Key", idempotencyKey);

// ê°™ì€ ì£¼ë¬¸ì„ ì—¬ëŸ¬ ë²ˆ ìš”ì²­í•´ë„ PGì‚¬ì—ì„œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€!
```

2. **ì¬ì‹œë„ ì „ëµ**
```java
// 4xx (í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜) â†’ ì¬ì‹œë„ ë¶ˆê°€
if (responseCode >= 400 && responseCode < 500) {
    return fail;
}

// 5xx (ì„œë²„ ì˜¤ë¥˜) ë˜ëŠ” íƒ€ì„ì•„ì›ƒ â†’ ì¬ì‹œë„
```

3. **ìë™ ë¡¤ë°±**
```java
if (ëª¨ë“ _ì¬ì‹œë„_ì‹¤íŒ¨) {
    rollbackPayment();  // DB ë¡¤ë°±, ì¬ê³  ë³µêµ¬
}
```

### ì„±ê³¼
- **ì„±ê³µë¥ **: 99.8% (ì¬ì‹œë„ ë•ë¶„ì— ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ê·¹ë³µ)
- **í‰ê·  ì‘ë‹µ ì‹œê°„**: 210ms
- **ë©±ë“±ì„± ë³´ì¥**: ì¤‘ë³µ ê²°ì œ 0ê±´ (Idempotency Key ë•ë¶„)

---

## ğŸ¢ ì‹¤ë¬´ ì‚¬ë¡€ 3: ì¿ íŒ¡ ìƒí’ˆ ê°€ê²© ëª¨ë‹ˆí„°ë§ (Rate Limiting)

### ë°°ê²½
ì¿ íŒ¡ ë¡œì¼“ë°°ì†¡ ìš´ì˜íŒ€ì—ì„œ ê²½ìŸì‚¬ ê°€ê²©ì„ ì£¼ê¸°ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ìë™ìœ¼ë¡œ ê°€ê²© ì¡°ì •

### ìš”êµ¬ì‚¬í•­
- ê²½ìŸì‚¬ API ì£¼ê¸°ì  í˜¸ì¶œ (1ë¶„ë§ˆë‹¤)
- Rate Limiting ì¤€ìˆ˜ (ë¶„ë‹¹ 100ê±´)
- ê°€ê²© ë³€ë™ ê°ì§€ ì‹œ ì•Œë¦¼
- API í‚¤ ê´€ë¦¬

### ì „ì²´ ì½”ë“œ

```java
import java.net.*;
import java.io.*;
import java.util.*;
import java.util.concurrent.*;

/**
 * ì¿ íŒ¡ ìƒí’ˆ ê°€ê²© ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
 * - ê²½ìŸì‚¬ API ì£¼ê¸°ì  í˜¸ì¶œ
 * - Rate Limiting (ë¶„ë‹¹ 100ê±´)
 * - ê°€ê²© ë³€ë™ ì•Œë¦¼
 */
public class CoupangPriceMonitor {
    private static final String COMPETITOR_API_URL =
        "https://api.competitor.com/products";
    private static final String API_KEY = "coupang_api_key_12345";
    private static final int RATE_LIMIT = 100;  // ë¶„ë‹¹ 100ê±´

    // Rate Limiter (Guava ë¼ì´ë¸ŒëŸ¬ë¦¬ ëŒ€ì‹  ê°„ë‹¨í•œ êµ¬í˜„)
    private final Semaphore rateLimiter =
        new Semaphore(RATE_LIMIT);

    // ê°€ê²© ìºì‹œ (ì´ì „ ê°€ê²© ì €ì¥)
    private final ConcurrentHashMap<String, Integer> priceCache =
        new ConcurrentHashMap<>();

    public static void main(String[] args) {
        CoupangPriceMonitor monitor = new CoupangPriceMonitor();

        // ëª¨ë‹ˆí„°ë§í•  ìƒí’ˆ ëª©ë¡
        List<String> productIds = Arrays.asList(
            "PROD001", "PROD002", "PROD003"
            // ... 1,000ê°œ ìƒí’ˆ
        );

        // 1ë¶„ë§ˆë‹¤ ê°€ê²© ëª¨ë‹ˆí„°ë§
        ScheduledExecutorService scheduler =
            Executors.newScheduledThreadPool(1);

        scheduler.scheduleAtFixedRate(() -> {
            System.out.println("\n=== ê°€ê²© ëª¨ë‹ˆí„°ë§ ì‹œì‘: " +
                new Date() + " ===");
            monitor.monitorPrices(productIds);
        }, 0, 1, TimeUnit.MINUTES);

        // Rate Limiter ì´ˆê¸°í™” (1ë¶„ë§ˆë‹¤ ì„¸ë§ˆí¬ì–´ ë¦¬ì…‹)
        scheduler.scheduleAtFixedRate(() -> {
            monitor.resetRateLimiter();
        }, 1, 1, TimeUnit.MINUTES);
    }

    /**
     * ìƒí’ˆ ê°€ê²© ëª¨ë‹ˆí„°ë§
     */
    public void monitorPrices(List<String> productIds) {
        ExecutorService executor =
            Executors.newFixedThreadPool(10);

        List<Future<PriceResult>> futures = new ArrayList<>();

        for (String productId : productIds) {
            Future<PriceResult> future = executor.submit(() ->
                checkPrice(productId)
            );
            futures.add(future);
        }

        // ê²°ê³¼ ì§‘ê³„
        int totalChecked = 0, priceChanged = 0;

        for (Future<PriceResult> future : futures) {
            try {
                PriceResult result = future.get(10, TimeUnit.SECONDS);
                if (result != null) {
                    totalChecked++;

                    if (result.priceChanged) {
                        priceChanged++;
                        handlePriceChange(result);
                    }
                }
            } catch (Exception e) {
                System.err.println("ì˜¤ë¥˜: " + e.getMessage());
            }
        }

        executor.shutdown();

        System.out.println("\n=== ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ===");
        System.out.println("í™•ì¸í•œ ìƒí’ˆ: " + totalChecked + "ê°œ");
        System.out.println("ê°€ê²© ë³€ë™: " + priceChanged + "ê°œ");
    }

    /**
     * ìƒí’ˆ ê°€ê²© í™•ì¸ (Rate Limiting ì ìš©)
     */
    private PriceResult checkPrice(String productId) {
        try {
            // Rate Limiting: ì„¸ë§ˆí¬ì–´ íšë“
            if (!rateLimiter.tryAcquire(100, TimeUnit.MILLISECONDS)) {
                System.err.println("âš ï¸ Rate Limit ì´ˆê³¼: " + productId);
                return null;
            }

            // API í˜¸ì¶œ
            String urlString = COMPETITOR_API_URL + "/" + productId;
            URL url = new URL(urlString);
            HttpURLConnection conn =
                (HttpURLConnection) url.openConnection();

            // ìš”ì²­ ì„¤ì •
            conn.setRequestMethod("GET");
            conn.setRequestProperty("Authorization",
                "Bearer " + API_KEY);
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(5000);

            int responseCode = conn.getResponseCode();

            if (responseCode == 200) {
                // ì‘ë‹µ íŒŒì‹±
                String responseBody = readResponse(
                    conn.getInputStream());

                conn.disconnect();

                // ê°€ê²© ì¶”ì¶œ (JSON íŒŒì‹± ê°„ì†Œí™”)
                int currentPrice = parsePrice(responseBody);

                // ê°€ê²© ë³€ë™ ê°ì§€
                Integer previousPrice = priceCache.get(productId);
                boolean priceChanged = false;

                if (previousPrice != null &&
                    previousPrice != currentPrice) {
                    priceChanged = true;
                    System.out.println("ğŸ’° ê°€ê²© ë³€ë™ ê°ì§€: " +
                        productId + " (" + previousPrice + "ì› â†’ " +
                        currentPrice + "ì›)");
                }

                // ìºì‹œ ì—…ë°ì´íŠ¸
                priceCache.put(productId, currentPrice);

                return new PriceResult(productId, currentPrice,
                    previousPrice, priceChanged);

            } else if (responseCode == 429) {
                // Too Many Requests
                System.err.println("âš ï¸ API Rate Limit ì´ˆê³¼ (429)");

            } else {
                System.err.println("âŒ API ì˜¤ë¥˜ " + responseCode +
                    ": " + productId);
            }

            conn.disconnect();

        } catch (Exception e) {
            System.err.println("âŒ ì˜¤ë¥˜: " + productId +
                " - " + e.getMessage());
        }

        return null;
    }

    /**
     * ì‘ë‹µ ë³¸ë¬¸ ì½ê¸°
     */
    private String readResponse(InputStream inputStream)
            throws IOException {
        try (BufferedReader reader = new BufferedReader(
                new InputStreamReader(inputStream))) {
            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            return response.toString();
        }
    }

    /**
     * ê°€ê²© íŒŒì‹± (ê°„ì†Œí™”)
     */
    private int parsePrice(String json) {
        // ì‹¤ì œë¡œëŠ” JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
        // {"productId": "PROD001", "price": 29900}
        return 29900 + (int)(Math.random() * 5000);  // Mock
    }

    /**
     * ê°€ê²© ë³€ë™ ì²˜ë¦¬
     */
    private void handlePriceChange(PriceResult result) {
        int diff = result.currentPrice - result.previousPrice;
        double changePercent = (double) diff / result.previousPrice * 100;

        System.out.println("ğŸ“Š ê°€ê²© ë³€ë™ ë¶„ì„:");
        System.out.println("  ìƒí’ˆ ID: " + result.productId);
        System.out.println("  ì´ì „ ê°€ê²©: " + result.previousPrice + "ì›");
        System.out.println("  í˜„ì¬ ê°€ê²©: " + result.currentPrice + "ì›");
        System.out.println("  ë³€ë™: " + diff + "ì› (" +
            String.format("%.2f", changePercent) + "%)");

        // ê°€ê²© ì¸í•˜ (5% ì´ìƒ)
        if (changePercent <= -5.0) {
            System.out.println("âœ… ê²½ìŸì‚¬ ê°€ê²© ì¸í•˜ â†’ ìë™ ê°€ê²© ì¡°ì • í•„ìš”!");
            adjustCoupangPrice(result.productId, result.currentPrice);
        }

        // ê°€ê²© ì¸ìƒ (10% ì´ìƒ)
        if (changePercent >= 10.0) {
            System.out.println("âœ… ê²½ìŸì‚¬ ê°€ê²© ì¸ìƒ â†’ ìš°ë¦¬ ê°€ê²© ê²½ìŸë ¥ í™•ë³´!");
        }

        // Slack ì•Œë¦¼ (ìƒëµ)
        sendSlackNotification(result);
    }

    /**
     * ì¿ íŒ¡ ê°€ê²© ìë™ ì¡°ì •
     */
    private void adjustCoupangPrice(String productId, int competitorPrice) {
        // ê²½ìŸì‚¬ë³´ë‹¤ 500ì› ì €ë ´í•˜ê²Œ ì„¤ì •
        int newPrice = competitorPrice - 500;

        System.out.println("ğŸ”„ ê°€ê²© ìë™ ì¡°ì •: " + productId +
            " â†’ " + newPrice + "ì›");

        // DB ì—…ë°ì´íŠ¸ (ìƒëµ)
        // UPDATE products SET price = ? WHERE product_id = ?
    }

    /**
     * Slack ì•Œë¦¼ ì „ì†¡
     */
    private void sendSlackNotification(PriceResult result) {
        // Slack Webhook API í˜¸ì¶œ (ìƒëµ)
    }

    /**
     * Rate Limiter ì´ˆê¸°í™”
     */
    private void resetRateLimiter() {
        int available = rateLimiter.availablePermits();
        int released = RATE_LIMIT - available;

        if (released > 0) {
            rateLimiter.release(released);
            System.out.println("ğŸ”„ Rate Limiter ë¦¬ì…‹: " +
                released + "ê°œ ë³µêµ¬");
        }
    }

    // DTO í´ë˜ìŠ¤
    static class PriceResult {
        String productId;
        int currentPrice;
        Integer previousPrice;
        boolean priceChanged;

        PriceResult(String productId, int currentPrice,
                    Integer previousPrice, boolean priceChanged) {
            this.productId = productId;
            this.currentPrice = currentPrice;
            this.previousPrice = previousPrice;
            this.priceChanged = priceChanged;
        }
    }
}
```

### ì‹¤í–‰ ê²°ê³¼

```
=== ê°€ê²© ëª¨ë‹ˆí„°ë§ ì‹œì‘: Fri Jan 10 14:00:00 KST 2025 ===
ğŸ’° ê°€ê²© ë³€ë™ ê°ì§€: PROD001 (29900ì› â†’ 27900ì›)
ğŸ“Š ê°€ê²© ë³€ë™ ë¶„ì„:
  ìƒí’ˆ ID: PROD001
  ì´ì „ ê°€ê²©: 29900ì›
  í˜„ì¬ ê°€ê²©: 27900ì›
  ë³€ë™: -2000ì› (-6.69%)
âœ… ê²½ìŸì‚¬ ê°€ê²© ì¸í•˜ â†’ ìë™ ê°€ê²© ì¡°ì • í•„ìš”!
ğŸ”„ ê°€ê²© ìë™ ì¡°ì •: PROD001 â†’ 27400ì›

ğŸ’° ê°€ê²© ë³€ë™ ê°ì§€: PROD002 (49000ì› â†’ 54000ì›)
ğŸ“Š ê°€ê²© ë³€ë™ ë¶„ì„:
  ìƒí’ˆ ID: PROD002
  ì´ì „ ê°€ê²©: 49000ì›
  í˜„ì¬ ê°€ê²©: 54000ì›
  ë³€ë™: 5000ì› (+10.20%)
âœ… ê²½ìŸì‚¬ ê°€ê²© ì¸ìƒ â†’ ìš°ë¦¬ ê°€ê²© ê²½ìŸë ¥ í™•ë³´!

=== ëª¨ë‹ˆí„°ë§ ì™„ë£Œ ===
í™•ì¸í•œ ìƒí’ˆ: 1000ê°œ
ê°€ê²© ë³€ë™: 47ê°œ

=== ê°€ê²© ëª¨ë‹ˆí„°ë§ ì‹œì‘: Fri Jan 10 14:01:00 KST 2025 ===
ğŸ”„ Rate Limiter ë¦¬ì…‹: 100ê°œ ë³µêµ¬
...
```

### í•µì‹¬ ê¸°ìˆ 

1. **Rate Limiting (ì„¸ë§ˆí¬ì–´ ì‚¬ìš©)**
```java
Semaphore rateLimiter = new Semaphore(100);  // ë¶„ë‹¹ 100ê±´

// API í˜¸ì¶œ ì „
if (!rateLimiter.tryAcquire(100, TimeUnit.MILLISECONDS)) {
    System.err.println("Rate Limit ì´ˆê³¼");
    return;
}

// 1ë¶„ë§ˆë‹¤ ë¦¬ì…‹
scheduler.scheduleAtFixedRate(() -> {
    rateLimiter.release(released);
}, 1, 1, TimeUnit.MINUTES);
```

2. **ê°€ê²© ë³€ë™ ê°ì§€**
```java
ConcurrentHashMap<String, Integer> priceCache;

Integer previousPrice = priceCache.get(productId);
if (previousPrice != null && previousPrice != currentPrice) {
    handlePriceChange();  // ì•Œë¦¼ + ìë™ ì¡°ì •
}
```

3. **ìë™ ê°€ê²© ì¡°ì •**
```java
if (ê²½ìŸì‚¬_ê°€ê²©_ì¸í•˜ >= 5%) {
    int newPrice = competitorPrice - 500;  // 500ì› ì €ë ´í•˜ê²Œ
    updateCoupangPrice(newPrice);
}
```

### ì„±ê³¼
- **ëª¨ë‹ˆí„°ë§ ìƒí’ˆ**: 1,000ê°œ
- **ê°€ê²© ë³€ë™ ê°ì§€**: í‰ê·  47ê°œ/ë¶„
- **ìë™ ì¡°ì •**: 10ê°œ/ë¶„ (ìˆ˜ë™ ëŒ€ë¹„ 10ë°° ë¹ ë¦„)
- **ë§¤ì¶œ ì¦ê°€**: ê²½ìŸë ¥ ìˆëŠ” ê°€ê²©ìœ¼ë¡œ ì›” ë§¤ì¶œ 5% ì¦ê°€

---

## ğŸ‘¶ ì£¼ë‹ˆì–´ ê°œë°œì ì‹œë‚˜ë¦¬ì˜¤ 1: Connection Timeout ë¯¸ì„¤ì •

### ìƒí™©
ì…ì‚¬ 1ê°œì›” ì°¨ ì‹ ì… ê°œë°œìê°€ ì™¸ë¶€ API í˜¸ì¶œ ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

```java
public class WeatherAPI {
    public String getWeather(String city) throws Exception {
        String url = "http://slow-weather-api.com/weather?city=" + city;

        URL apiUrl = new URL(url);
        HttpURLConnection conn =
            (HttpURLConnection) apiUrl.openConnection();

        conn.setRequestMethod("GET");
        // âŒ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì—†ìŒ!

        BufferedReader reader = new BufferedReader(
            new InputStreamReader(conn.getInputStream()));

        String line;
        StringBuilder response = new StringBuilder();
        while ((line = reader.readLine()) != null) {
            response.append(line);
        }

        reader.close();
        conn.disconnect();

        return response.toString();
    }
}
```

### ë¬¸ì œ ë°œìƒ

```
ì‚¬ìš©ì ìš”ì²­ â†’ ë‚ ì”¨ API í˜¸ì¶œ â†’ ì‘ë‹µ ì—†ìŒ (ì„œë²„ ëŠë¦¼)
                        â†“
                   ë¬´í•œ ëŒ€ê¸°! â°
                        â†“
            ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ (CPU 100%)
                        â†“
        ì„œë²„ ì „ì²´ ë‹¤ìš´ (OOM) ğŸ’¥
```

**ë¡œê·¸**:
```
14:32:15 INFO  - ë‚ ì”¨ ì¡°íšŒ ìš”ì²­: Seoul
14:32:15 INFO  - API í˜¸ì¶œ ì¤‘...
(30ë¶„ ê²½ê³¼)
15:02:15 ERROR - OutOfMemoryError: unable to create new native thread
```

### í•´ê²° ë°©ë²•

```java
public class WeatherAPI {
    private static final int CONNECT_TIMEOUT = 5000;  // 5ì´ˆ
    private static final int READ_TIMEOUT = 10000;    // 10ì´ˆ

    public String getWeather(String city) throws Exception {
        String url = "http://slow-weather-api.com/weather?city=" + city;

        URL apiUrl = new URL(url);
        HttpURLConnection conn =
            (HttpURLConnection) apiUrl.openConnection();

        conn.setRequestMethod("GET");

        // âœ… íƒ€ì„ì•„ì›ƒ ì„¤ì •!
        conn.setConnectTimeout(CONNECT_TIMEOUT);  // ì—°ê²° íƒ€ì„ì•„ì›ƒ
        conn.setReadTimeout(READ_TIMEOUT);        // ì½ê¸° íƒ€ì„ì•„ì›ƒ

        try {
            BufferedReader reader = new BufferedReader(
                new InputStreamReader(conn.getInputStream()));

            String line;
            StringBuilder response = new StringBuilder();
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }

            reader.close();
            return response.toString();

        } catch (SocketTimeoutException e) {
            // âœ… íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
            System.err.println("API íƒ€ì„ì•„ì›ƒ: " + e.getMessage());
            throw new RuntimeException("ë‚ ì”¨ API ì‘ë‹µ ì‹œê°„ ì´ˆê³¼", e);

        } finally {
            conn.disconnect();
        }
    }
}
```

### ë°°ìš´ ì 

1. **íƒ€ì„ì•„ì›ƒì€ í•„ìˆ˜**
   - `setConnectTimeout()`: ì„œë²„ ì—°ê²° ì‹œê°„ ì œí•œ
   - `setReadTimeout()`: ì‘ë‹µ ì½ê¸° ì‹œê°„ ì œí•œ

2. **ê¶Œì¥ ì‹œê°„**
   - ì—°ê²° íƒ€ì„ì•„ì›ƒ: 5ì´ˆ
   - ì½ê¸° íƒ€ì„ì•„ì›ƒ: 10-30ì´ˆ (API íŠ¹ì„±ì— ë”°ë¼)

3. **ì˜ˆì™¸ ì²˜ë¦¬**
   - `SocketTimeoutException` catch â†’ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€
   - ë¬´í•œ ëŒ€ê¸° ë°©ì§€ â†’ ì„œë²„ ì•ˆì •ì„± í™•ë³´

---

## ğŸ‘¶ ì£¼ë‹ˆì–´ ê°œë°œì ì‹œë‚˜ë¦¬ì˜¤ 2: HttpURLConnection ì¬ì‚¬ìš© ì‹œë„

### ìƒí™©
ì…ì‚¬ 2ê°œì›” ì°¨ ê°œë°œìê°€ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ HttpURLConnectionì„ ì¬ì‚¬ìš©í•˜ë ¤ê³  í–ˆìŠµë‹ˆë‹¤.

```java
public class ProductAPI {
    private HttpURLConnection conn;  // âŒ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ì¬ì‚¬ìš© ì‹œë„

    public ProductAPI() throws Exception {
        URL url = new URL("https://api.example.com/products");
        conn = (HttpURLConnection) url.openConnection();
        conn.setRequestMethod("GET");
    }

    public String getProduct(String productId) throws Exception {
        // âŒ ì¬ì‚¬ìš© ì‹œë„!
        BufferedReader reader = new BufferedReader(
            new InputStreamReader(conn.getInputStream()));

        String line;
        StringBuilder response = new StringBuilder();
        while ((line = reader.readLine()) != null) {
            response.append(line);
        }

        reader.close();
        return response.toString();
    }

    public static void main(String[] args) throws Exception {
        ProductAPI api = new ProductAPI();

        // ì²« ë²ˆì§¸ í˜¸ì¶œ: ì„±ê³µ âœ…
        System.out.println(api.getProduct("PROD001"));

        // ë‘ ë²ˆì§¸ í˜¸ì¶œ: ì‹¤íŒ¨! âŒ
        System.out.println(api.getProduct("PROD002"));
    }
}
```

### ë¬¸ì œ ë°œìƒ

```
Exception in thread "main" java.net.ProtocolException:
    Cannot write output after reading input.
```

**ì´ìœ **:
- HttpURLConnectionì€ **1íšŒìš© ê°ì²´**
- `getInputStream()` í˜¸ì¶œ í›„ ì¬ì‚¬ìš© ë¶ˆê°€
- ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ê°ì²´ ìƒì„± í•„ìš”

### í•´ê²° ë°©ë²•

```java
public class ProductAPI {
    private static final String BASE_URL =
        "https://api.example.com/products";

    // âœ… ë©”ì„œë“œë§ˆë‹¤ ìƒˆë¡œìš´ ì—°ê²° ìƒì„±
    public String getProduct(String productId) throws Exception {
        String urlString = BASE_URL + "/" + productId;
        URL url = new URL(urlString);

        // âœ… ë§¤ë²ˆ ìƒˆë¡œìš´ HttpURLConnection ìƒì„±!
        HttpURLConnection conn =
            (HttpURLConnection) url.openConnection();

        conn.setRequestMethod("GET");
        conn.setConnectTimeout(5000);
        conn.setReadTimeout(5000);

        try {
            int responseCode = conn.getResponseCode();

            if (responseCode == 200) {
                BufferedReader reader = new BufferedReader(
                    new InputStreamReader(conn.getInputStream()));

                String line;
                StringBuilder response = new StringBuilder();
                while ((line = reader.readLine()) != null) {
                    response.append(line);
                }

                reader.close();
                return response.toString();
            } else {
                throw new RuntimeException("API ì˜¤ë¥˜: " + responseCode);
            }

        } finally {
            conn.disconnect();  // âœ… ì—°ê²° ì¢…ë£Œ
        }
    }

    public static void main(String[] args) throws Exception {
        ProductAPI api = new ProductAPI();

        // ëª¨ë“  í˜¸ì¶œ ì„±ê³µ! âœ…
        System.out.println(api.getProduct("PROD001"));
        System.out.println(api.getProduct("PROD002"));
        System.out.println(api.getProduct("PROD003"));
    }
}
```

### ë°°ìš´ ì 

1. **HttpURLConnectionì€ 1íšŒìš©**
   - ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ê°ì²´ ìƒì„±
   - `disconnect()` í›„ ì¬ì‚¬ìš© ë¶ˆê°€

2. **Connection Poolì´ í•„ìš”í•˜ë‹¤ë©´?**
   - Apache HttpClient ì‚¬ìš©
   - OkHttp ì‚¬ìš©
   - RestTemplate (Spring) ì‚¬ìš©

3. **ì˜¬ë°”ë¥¸ íŒ¨í„´**
```java
// âŒ ì˜ëª»ëœ íŒ¨í„´
HttpURLConnection conn;  // ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜

// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
public String request() {
    HttpURLConnection conn = ...;  // ë©”ì„œë“œ ë‚´ ìƒì„±
    try {
        // ìš”ì²­ ì²˜ë¦¬
    } finally {
        conn.disconnect();
    }
}
```

---

## ğŸ‘¶ ì£¼ë‹ˆì–´ ê°œë°œì ì‹œë‚˜ë¦¬ì˜¤ 3: POST ìš”ì²­ ì‹œ setDoOutput() ëˆ„ë½

### ìƒí™©
ì…ì‚¬ 3ê°œì›” ì°¨ ê°œë°œìê°€ íšŒì›ê°€ì… APIë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

```java
public class UserAPI {
    public String registerUser(String username, String email)
            throws Exception {
        String urlString = "https://api.example.com/users";
        URL url = new URL(urlString);

        HttpURLConnection conn =
            (HttpURLConnection) url.openConnection();

        conn.setRequestMethod("POST");
        conn.setRequestProperty("Content-Type", "application/json");
        // âŒ setDoOutput(true) ëˆ„ë½!

        // JSON ë°ì´í„°
        String jsonData = String.format(
            "{\"username\":\"%s\",\"email\":\"%s\"}",
            username, email);

        // ë°ì´í„° ì „ì†¡ ì‹œë„
        OutputStream os = conn.getOutputStream();  // âŒ ì˜ˆì™¸ ë°œìƒ!
        os.write(jsonData.getBytes());
        os.close();

        // ì‘ë‹µ ì½ê¸°
        int responseCode = conn.getResponseCode();
        return "Success: " + responseCode;
    }
}
```

### ë¬¸ì œ ë°œìƒ

```
Exception in thread "main" java.net.ProtocolException:
    cannot write to a URLConnection if doOutput=false -
    call setDoOutput(true)
```

**ì´ìœ **:
- HttpURLConnectionì€ ê¸°ë³¸ì ìœ¼ë¡œ **ì½ê¸° ì „ìš©** (GET)
- POSTë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ë ¤ë©´ `setDoOutput(true)` í•„ìˆ˜
- ì´ë¥¼ ì„¤ì •í•´ì•¼ `getOutputStream()` ì‚¬ìš© ê°€ëŠ¥

### í•´ê²° ë°©ë²•

```java
public class UserAPI {
    public String registerUser(String username, String email)
            throws Exception {
        String urlString = "https://api.example.com/users";
        URL url = new URL(urlString);

        HttpURLConnection conn =
            (HttpURLConnection) url.openConnection();

        conn.setRequestMethod("POST");
        conn.setRequestProperty("Content-Type", "application/json");
        conn.setDoOutput(true);  // âœ… POST ìš”ì²­ì— í•„ìˆ˜!
        conn.setConnectTimeout(5000);
        conn.setReadTimeout(5000);

        // JSON ë°ì´í„°
        String jsonData = String.format(
            "{\"username\":\"%s\",\"email\":\"%s\"}",
            username, email);

        // âœ… ë°ì´í„° ì „ì†¡ (try-with-resources)
        try (OutputStream os = conn.getOutputStream()) {
            byte[] input = jsonData.getBytes("utf-8");
            os.write(input, 0, input.length);
        }

        // ì‘ë‹µ ì½ê¸°
        int responseCode = conn.getResponseCode();

        if (responseCode == 201) {  // HTTP_CREATED
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(conn.getInputStream()))) {

                String line;
                StringBuilder response = new StringBuilder();
                while ((line = reader.readLine()) != null) {
                    response.append(line);
                }

                return response.toString();
            }
        } else {
            throw new RuntimeException("API ì˜¤ë¥˜: " + responseCode);
        }
    }

    public static void main(String[] args) throws Exception {
        UserAPI api = new UserAPI();

        String result = api.registerUser("john_doe", "john@example.com");
        System.out.println("âœ… íšŒì›ê°€ì… ì„±ê³µ:");
        System.out.println(result);
    }
}
```

### ë°°ìš´ ì 

1. **POST/PUT ìš”ì²­ ì‹œ í•„ìˆ˜ ì„¤ì •**
```java
conn.setRequestMethod("POST");
conn.setDoOutput(true);  // âœ… í•„ìˆ˜!
```

2. **GET vs POST ì°¨ì´**
```java
// GET (ë°ì´í„° ì½ê¸° only)
conn.setRequestMethod("GET");
// setDoOutput() ë¶ˆí•„ìš”

// POST (ë°ì´í„° ì“°ê¸°)
conn.setRequestMethod("POST");
conn.setDoOutput(true);  // âœ… í•„ìˆ˜!
```

3. **OutputStream ì˜¬ë°”ë¥¸ ì‚¬ìš©**
```java
// âœ… try-with-resources (ìë™ close)
try (OutputStream os = conn.getOutputStream()) {
    os.write(data);
}

// âŒ ìˆ˜ë™ close (ëˆ„ë½ ìœ„í—˜)
OutputStream os = conn.getOutputStream();
os.write(data);
os.close();  // ì˜ˆì™¸ ë°œìƒ ì‹œ ëˆ„ë½ ìœ„í—˜!
```

---

## ğŸ‘¶ ì£¼ë‹ˆì–´ ê°œë°œì ì‹œë‚˜ë¦¬ì˜¤ 4: InputStream ë‹«ì§€ ì•Šì•„ ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜

### ìƒí™©
ì…ì‚¬ 4ê°œì›” ì°¨ ê°œë°œìê°€ API í˜¸ì¶œì„ ë°˜ë³µí•˜ëŠ” ë°°ì¹˜ ì‘ì—…ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

```java
public class DataSyncBatch {
    public void syncData() {
        List<String> urls = getUrls();  // 1,000ê°œ URL

        for (String urlString : urls) {
            try {
                URL url = new URL(urlString);
                HttpURLConnection conn =
                    (HttpURLConnection) url.openConnection();

                conn.setRequestMethod("GET");

                // âŒ InputStreamì„ ë‹«ì§€ ì•ŠìŒ!
                InputStream is = conn.getInputStream();
                BufferedReader reader = new BufferedReader(
                    new InputStreamReader(is));

                String line;
                while ((line = reader.readLine()) != null) {
                    processLine(line);
                }

                // âŒ close() ëˆ„ë½!

                conn.disconnect();

            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    private List<String> getUrls() {
        // 1,000ê°œ URL ë°˜í™˜
        return Arrays.asList("url1", "url2", ...);
    }

    private void processLine(String line) {
        // ë°ì´í„° ì²˜ë¦¬
    }
}
```

### ë¬¸ì œ ë°œìƒ

**ì²˜ìŒì—ëŠ” ì •ìƒ ë™ì‘**:
```
ì²˜ë¦¬ ì¤‘: 1/1000
ì²˜ë¦¬ ì¤‘: 2/1000
ì²˜ë¦¬ ì¤‘: 3/1000
...
```

**500ë²ˆì§¸ ìš”ì²­ ì¦ˆìŒ**:
```
ì²˜ë¦¬ ì¤‘: 498/1000
ì²˜ë¦¬ ì¤‘: 499/1000
ì²˜ë¦¬ ì¤‘: 500/1000
java.io.IOException: Too many open files
```

**ì‹œìŠ¤í…œ ìƒíƒœ**:
```bash
$ lsof -p <pid> | wc -l
1024  # âŒ íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° í•œê³„ ë„ë‹¬!
```

### í•´ê²° ë°©ë²•

```java
public class DataSyncBatch {
    public void syncData() {
        List<String> urls = getUrls();  // 1,000ê°œ URL

        int success = 0, fail = 0;

        for (String urlString : urls) {
            HttpURLConnection conn = null;

            try {
                URL url = new URL(urlString);
                conn = (HttpURLConnection) url.openConnection();

                conn.setRequestMethod("GET");
                conn.setConnectTimeout(5000);
                conn.setReadTimeout(5000);

                // âœ… try-with-resourcesë¡œ ìë™ close
                try (InputStream is = conn.getInputStream();
                     BufferedReader reader = new BufferedReader(
                         new InputStreamReader(is))) {

                    String line;
                    while ((line = reader.readLine()) != null) {
                        processLine(line);
                    }
                }

                success++;
                System.out.println("âœ… ì²˜ë¦¬ ì™„ë£Œ: " + success +
                    "/" + urls.size());

            } catch (Exception e) {
                fail++;
                System.err.println("âŒ ì˜¤ë¥˜: " + urlString);

            } finally {
                // âœ… ì—°ê²° ì¢…ë£Œ
                if (conn != null) {
                    conn.disconnect();
                }
            }
        }

        System.out.println("\n=== ë°°ì¹˜ ì™„ë£Œ ===");
        System.out.println("ì„±ê³µ: " + success + "ê°œ");
        System.out.println("ì‹¤íŒ¨: " + fail + "ê°œ");
    }

    private List<String> getUrls() {
        // 1,000ê°œ URL ë°˜í™˜
        List<String> urls = new ArrayList<>();
        for (int i = 1; i <= 1000; i++) {
            urls.add("https://api.example.com/data/" + i);
        }
        return urls;
    }

    private void processLine(String line) {
        // ë°ì´í„° ì²˜ë¦¬
    }

    public static void main(String[] args) {
        DataSyncBatch batch = new DataSyncBatch();
        batch.syncData();
    }
}
```

### ë°°ìš´ ì 

1. **ë¦¬ì†ŒìŠ¤ëŠ” ë°˜ë“œì‹œ ë‹«ì•„ì•¼ í•œë‹¤**
   - InputStream
   - OutputStream
   - Reader/Writer
   - HttpURLConnection

2. **try-with-resources ì‚¬ìš©**
```java
// âœ… ìë™ close (ê¶Œì¥)
try (InputStream is = conn.getInputStream();
     BufferedReader reader = new BufferedReader(
         new InputStreamReader(is))) {
    // ì‚¬ìš©
}  // â† ìë™ìœ¼ë¡œ close() í˜¸ì¶œ

// âŒ ìˆ˜ë™ close (ìœ„í—˜)
InputStream is = conn.getInputStream();
BufferedReader reader = new BufferedReader(...);
// ì‚¬ìš©
is.close();   // ì˜ˆì™¸ ë°œìƒ ì‹œ ëˆ„ë½ ìœ„í—˜!
reader.close();
```

3. **finally ë¸”ë¡ í™œìš©**
```java
HttpURLConnection conn = null;
try {
    conn = (HttpURLConnection) url.openConnection();
    // ì‚¬ìš©
} finally {
    if (conn != null) {
        conn.disconnect();  // âœ… ë°˜ë“œì‹œ ì‹¤í–‰
    }
}
```

4. **ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ í™•ì¸ ë°©ë²•**
```bash
# ì—´ë¦° íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° í™•ì¸
$ lsof -p <pid> | wc -l

# ì‹œìŠ¤í…œ í•œê³„ í™•ì¸
$ ulimit -n
1024
```

---

## ğŸ¯ í•µì‹¬ ì •ë¦¬

### HTTP í†µì‹  í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

```java
// âœ… ì™„ë²½í•œ HTTP ìš”ì²­ í…œí”Œë¦¿
public String httpRequest(String urlString, String method,
                          String jsonData) throws Exception {
    URL url = new URL(urlString);
    HttpURLConnection conn =
        (HttpURLConnection) url.openConnection();

    // 1. ê¸°ë³¸ ì„¤ì •
    conn.setRequestMethod(method);
    conn.setConnectTimeout(5000);   // âœ… íƒ€ì„ì•„ì›ƒ
    conn.setReadTimeout(10000);

    // 2. í—¤ë” ì„¤ì •
    conn.setRequestProperty("Content-Type", "application/json");
    conn.setRequestProperty("User-Agent", "MyApp/1.0");

    // 3. POST ìš”ì²­ ì‹œ
    if ("POST".equals(method) || "PUT".equals(method)) {
        conn.setDoOutput(true);  // âœ… í•„ìˆ˜!

        try (OutputStream os = conn.getOutputStream()) {  // âœ… try-with-resources
            byte[] input = jsonData.getBytes("utf-8");
            os.write(input, 0, input.length);
        }
    }

    // 4. ì‘ë‹µ ì²˜ë¦¬
    int responseCode = conn.getResponseCode();

    try (BufferedReader reader = new BufferedReader(  // âœ… try-with-resources
            new InputStreamReader(
                responseCode == 200 ?
                    conn.getInputStream() :
                    conn.getErrorStream()))) {

        String line;
        StringBuilder response = new StringBuilder();
        while ((line = reader.readLine()) != null) {
            response.append(line);
        }

        return response.toString();

    } finally {
        conn.disconnect();  // âœ… ì—°ê²° ì¢…ë£Œ
    }
}
```

### ì‹¤ë¬´ íŒ¨í„´

| ìƒí™© | í•´ê²°ì±… |
|------|--------|
| íƒ€ì„ì•„ì›ƒ | `setConnectTimeout(5000)`, `setReadTimeout(10000)` |
| POST ìš”ì²­ | `setDoOutput(true)` í•„ìˆ˜ |
| ì¬ì‚¬ìš© ë¶ˆê°€ | ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆ HttpURLConnection |
| ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ | try-with-resources ì‚¬ìš© |
| ì¬ì‹œë„ | for ë£¨í”„ + exponential backoff |
| Rate Limiting | Semaphore ë˜ëŠ” Guava RateLimiter |
| ë©±ë“±ì„± ë³´ì¥ | Idempotency-Key í—¤ë” |

---

**ë‹¤ìŒ Partì—ì„œ ê³„ì†**: [39-3: ë©´ì ‘ ì§ˆë¬¸ ë° ì±„íŒ… í”„ë¡œì íŠ¸ â†’](39-3-ë„¤íŠ¸ì›Œí¬-í”„ë¡œê·¸ë˜ë°-Part3.md)

**ì´ì „ Part**: [â† 39-1: Socket ê¸°ì´ˆ](39-1-ë„¤íŠ¸ì›Œí¬-í”„ë¡œê·¸ë˜ë°-Part1.md)

**ëª©ì°¨ë¡œ ëŒì•„ê°€ê¸°**: [ğŸ“š ì „ì²´ ëª©ì°¨](README.md)
