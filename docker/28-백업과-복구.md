# ì„¹ì…˜ 28: ë°±ì—…ê³¼ ë³µêµ¬

## ë¹„ìœ ë¡œ ì‹œì‘í•˜ê¸°

ë°±ì—…ì€ **ë³´í—˜**ê³¼ ê°™ìŠµë‹ˆë‹¤.

```
ì‹¤ìƒí™œ ë³´í—˜                          Docker ë°±ì—…
===========                          ===========
ğŸ  í™”ì¬ ë³´í—˜                    â†’    ë°ì´í„° ì†ì‹¤ ëŒ€ë¹„
ğŸ’¾ ìë™ì°¨ ë¸”ë™ë°•ìŠ¤              â†’    ìë™ ë°±ì—… ì‹œìŠ¤í…œ
ğŸ—„ï¸ ì¤‘ìš” ì„œë¥˜ ì‚¬ë³¸              â†’    ë³¼ë¥¨ ë°±ì—…
ğŸ“¸ ì‚¬ì§„ í´ë¼ìš°ë“œ ë°±ì—…           â†’    ì›ê²© ë°±ì—… ì €ì¥ì†Œ
â° ì •ê¸° ê±´ê°•ê²€ì§„                â†’    ì •ê¸° ë°±ì—… ìŠ¤ì¼€ì¤„
ğŸ”„ ë³´í—˜ê¸ˆ ì²­êµ¬ ì—°ìŠµ             â†’    ë³µêµ¬ í…ŒìŠ¤íŠ¸
```

ë³´í—˜ ì—†ì´ ì‚¬ê³  ë‚˜ë©´ í° ì†í•´ë¥¼ ë³´ë“¯ì´, ë°±ì—… ì—†ì´ ë°ì´í„° ì†ì‹¤ë˜ë©´ ë³µêµ¬ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## ì™œ ë°±ì—…ì´ ì¤‘ìš”í•œê°€?

### 1. ë°ì´í„° ì†ì‹¤ ì‹œë‚˜ë¦¬ì˜¤

```
ì‹¤ì œ ì‚¬ê³  ì‚¬ë¡€
=============

âŒ ì‚¬ë¡€ 1: ê°œë°œì ì‹¤ìˆ˜
------------------------
ê°œë°œì: "docker volume prune -f"
ì‹œìŠ¤í…œ: "3ë…„ì¹˜ ê±°ë˜ ë°ì´í„° ì‚­ì œ ì™„ë£Œ"
ê°œë°œì: "...!!! ğŸ˜±"
íšŒì‚¬: "ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤"
ê²°ê³¼: íì—…


âŒ ì‚¬ë¡€ 2: í•˜ë“œì›¨ì–´ ì¥ì• 
------------------------
03:00 AM - ì„œë²„ ë””ìŠ¤í¬ ë¬¼ë¦¬ì  ê³ ì¥
03:15 AM - ëª¨ë“  ì»¨í…Œì´ë„ˆ ì¤‘ë‹¨
03:30 AM - ë°ì´í„° ë³µêµ¬ ì‹œë„ ì‹¤íŒ¨
ê²°ê³¼: ë¹„ì¦ˆë‹ˆìŠ¤ ì¤‘ë‹¨, ê³ ê° ì´íƒˆ


âŒ ì‚¬ë¡€ 3: ëœì„¬ì›¨ì–´ ê³µê²©
------------------------
í•´ì»¤: ì•”í˜¸í™” ì™„ë£Œ, ë¹„íŠ¸ì½”ì¸ ìš”êµ¬
íšŒì‚¬: ë°±ì—…ë„ í•¨ê»˜ ì•”í˜¸í™”ë¨ (ì˜¤í”„ë¼ì¸ ë°±ì—… ì—†ìŒ)
ê²°ê³¼: í˜‘ìƒ or ë°ì´í„° í¬ê¸°


âœ… ë°±ì—…ì´ ìˆì—ˆë‹¤ë©´:
------------------
10:00 AM - ë°ì´í„° ì†ì‹¤ ë°œê²¬
10:05 AM - ë°±ì—… í™•ì¸ (ì–´ì œ ìì • ë°±ì—… ì¡´ì¬)
10:10 AM - ë³µêµ¬ ì‹œì‘
10:30 AM - ë³µêµ¬ ì™„ë£Œ, ì„œë¹„ìŠ¤ ì¬ê°œ
ê²°ê³¼: 30ë¶„ ë‹¤ìš´íƒ€ì„, ë°ì´í„° ì†ì‹¤ ìµœì†Œí™” âœ¨
```

### 2. ë°±ì—…ì˜ 3-2-1 ê·œì¹™

```
3-2-1 ë°±ì—… ì „ëµ
===============

3ê°œì˜ ë³µì‚¬ë³¸
    â”œâ”€â”€ ì›ë³¸ (ìš´ì˜ ì„œë²„)
    â”œâ”€â”€ ë°±ì—… 1 (ê°™ì€ ì„œë²„)
    â””â”€â”€ ë°±ì—… 2 (ë‹¤ë¥¸ ì„œë²„)

2ê°€ì§€ ë‹¤ë¥¸ ë§¤ì²´
    â”œâ”€â”€ SSD/HDD
    â””â”€â”€ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€

1ê°œì˜ ì˜¤í”„ì‚¬ì´íŠ¸ ë°±ì—…
    â””â”€â”€ ë‹¤ë¥¸ ì§€ì—­/í´ë¼ìš°ë“œ

ì˜ˆì‹œ:
-----
ì›ë³¸: ì„œìš¸ ë°ì´í„°ì„¼í„° SSD
ë°±ì—…1: ê°™ì€ ì„œë²„ HDD
ë°±ì—…2: AWS S3 (ì„œìš¸ ë¦¬ì „)
ë°±ì—…3: AWS S3 (ë„ì¿„ ë¦¬ì „) â† ì˜¤í”„ì‚¬ì´íŠ¸
```

---

## Docker ë°±ì—…ì˜ ì¢…ë¥˜

### 1. ë°±ì—… ëŒ€ìƒ

```
ë°±ì—…í•´ì•¼ í•  ê²ƒë“¤
===============

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ë°ì´í„° ë³¼ë¥¨                              â”‚
â”‚    - ë°ì´í„°ë² ì´ìŠ¤ ë°ì´í„°                    â”‚
â”‚    - ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼                     â”‚
â”‚    - ë¡œê·¸ íŒŒì¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. ë°”ì¸ë“œ ë§ˆìš´íŠ¸                            â”‚
â”‚    - ì„¤ì • íŒŒì¼ (.env, config/)              â”‚
â”‚    - ì¸ì¦ì„œ (SSL certificates)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€                          â”‚
â”‚    - ì»¤ìŠ¤í…€ ë¹Œë“œ ì´ë¯¸ì§€                     â”‚
â”‚    - íŠ¹ì • ë²„ì „ ì´ë¯¸ì§€                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Docker ì„¤ì •                              â”‚
â”‚    - docker-compose.yml                     â”‚
â”‚    - Dockerfile                             â”‚
â”‚    - í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. ë°ì´í„° ë³¼ë¥¨ ë°±ì—…

### 1.1 ìˆ˜ë™ ë°±ì—… (tar ì•„ì¹´ì´ë¸Œ)

```bash
# ë³¼ë¥¨ ëª©ë¡ í™•ì¸
docker volume ls

# ì¶œë ¥:
DRIVER    VOLUME NAME
local     backend1_postgres-data
local     backend1_redis-data
local     backend1_elasticsearch-data

# ë°©ë²• 1: ì„ì‹œ ì»¨í…Œì´ë„ˆë¥¼ ì´ìš©í•œ ë°±ì—…
docker run --rm \
  -v backend1_postgres-data:/data \
  -v $(pwd)/backups:/backup \
  alpine \
  tar czf /backup/postgres-data-$(date +%Y%m%d-%H%M%S).tar.gz -C /data .

# ì¶œë ¥: backups/postgres-data-20250930-103000.tar.gz ìƒì„±ë¨

# ë°©ë²• 2: ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆë¥¼ ì¼ì‹œ ì¤‘ì§€í•˜ê³  ë°±ì—…
docker-compose stop postgres
docker run --rm \
  -v backend1_postgres-data:/data \
  -v $(pwd)/backups:/backup \
  alpine \
  tar czf /backup/postgres-data-stopped-$(date +%Y%m%d-%H%M%S).tar.gz -C /data .
docker-compose start postgres

# ë°±ì—… íŒŒì¼ í™•ì¸
ls -lh backups/
# -rw-r--r-- 1 user user 1.2G Sep 30 10:30 postgres-data-20250930-103000.tar.gz
```

### 1.2 ë³¼ë¥¨ ë³µêµ¬

```bash
# ë°©ë²• 1: ìƒˆ ë³¼ë¥¨ì— ë³µêµ¬
docker volume create backend1_postgres-data-restored

docker run --rm \
  -v backend1_postgres-data-restored:/data \
  -v $(pwd)/backups:/backup \
  alpine \
  tar xzf /backup/postgres-data-20250930-103000.tar.gz -C /data

# ë°©ë²• 2: ê¸°ì¡´ ë³¼ë¥¨ êµì²´ (ì£¼ì˜: ê¸°ì¡´ ë°ì´í„° ì‚­ì œë¨!)
docker-compose stop postgres
docker run --rm \
  -v backend1_postgres-data:/data \
  alpine \
  sh -c "rm -rf /data/* && mkdir -p /data"
docker run --rm \
  -v backend1_postgres-data:/data \
  -v $(pwd)/backups:/backup \
  alpine \
  tar xzf /backup/postgres-data-20250930-103000.tar.gz -C /data
docker-compose start postgres
```

### 1.3 ìë™í™”ëœ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/backup-volumes.sh

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

# ì„¤ì •
BACKUP_DIR="./backups/volumes"
RETENTION_DAYS=30  # 30ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
DATE=$(date +%Y%m%d-%H%M%S)

# ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p "$BACKUP_DIR"

# ë°±ì—…í•  ë³¼ë¥¨ ëª©ë¡
VOLUMES=(
    "backend1_postgres-data"
    "backend1_redis-data"
    "backend1_elasticsearch-data"
)

echo "ğŸ”„ Starting volume backup at $(date)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for VOLUME in "${VOLUMES[@]}"; do
    echo "ğŸ“¦ Backing up volume: $VOLUME"

    # ë³¼ë¥¨ ì¡´ì¬ í™•ì¸
    if ! docker volume inspect "$VOLUME" > /dev/null 2>&1; then
        echo "  âš ï¸  Volume not found, skipping..."
        continue
    fi

    # ë°±ì—… íŒŒì¼ëª…
    BACKUP_FILE="$BACKUP_DIR/${VOLUME}-${DATE}.tar.gz"

    # ë°±ì—… ì‹¤í–‰
    docker run --rm \
        -v "$VOLUME:/data:ro" \
        -v "$(pwd)/$BACKUP_DIR:/backup" \
        alpine \
        tar czf "/backup/$(basename $BACKUP_FILE)" -C /data .

    # ë°±ì—… í¬ê¸° í™•ì¸
    SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
    echo "  âœ… Backup completed: $(basename $BACKUP_FILE) ($SIZE)"
done

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ§¹ Cleaning up old backups (older than $RETENTION_DAYS days)..."

# ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "âœ… Backup completed successfully at $(date)"
echo ""
echo "ğŸ“Š Backup Summary:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
du -sh "$BACKUP_DIR"
ls -lh "$BACKUP_DIR" | tail -n +2 | wc -l | xargs echo "Total backups:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
```

ì‹¤í–‰:

```bash
# ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
chmod +x scripts/backup-volumes.sh

# ë°±ì—… ì‹¤í–‰
bash scripts/backup-volumes.sh

# ì¶œë ¥:
ğŸ”„ Starting volume backup at Mon Sep 30 10:30:00 KST 2025
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ Backing up volume: backend1_postgres-data
  âœ… Backup completed: backend1_postgres-data-20250930-103000.tar.gz (1.2G)
ğŸ“¦ Backing up volume: backend1_redis-data
  âœ… Backup completed: backend1_redis-data-20250930-103000.tar.gz (256M)
ğŸ“¦ Backing up volume: backend1_elasticsearch-data
  âœ… Backup completed: backend1_elasticsearch-data-20250930-103000.tar.gz (3.5G)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ§¹ Cleaning up old backups (older than 30 days)...
âœ… Backup completed successfully at Mon Sep 30 10:35:00 KST 2025

ğŸ“Š Backup Summary:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4.9G    ./backups/volumes
Total backups: 90
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…

íŒŒì¼ ì‹œìŠ¤í…œ ë°±ì—…ë³´ë‹¤ **ë°ì´í„°ë² ì´ìŠ¤ ë„¤ì´í‹°ë¸Œ ë°±ì—…**ì´ ë” ì•ˆì „í•©ë‹ˆë‹¤.

### 2.1 PostgreSQL ë°±ì—…

```bash
#!/bin/bash
# scripts/backup-postgres.sh

set -e

BACKUP_DIR="./backups/postgres"
DATE=$(date +%Y%m%d-%H%M%S)
RETENTION_DAYS=30

mkdir -p "$BACKUP_DIR"

echo "ğŸ˜ Starting PostgreSQL backup..."

# pg_dumpë¥¼ ì´ìš©í•œ ë…¼ë¦¬ì  ë°±ì—…
docker exec lk-postgres pg_dump -U lk_admin lk_trade | gzip > "$BACKUP_DIR/lk_trade-${DATE}.sql.gz"

# ë˜ëŠ” pg_dumpall (ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ + ì—­í• /ê¶Œí•œ)
docker exec lk-postgres pg_dumpall -U lk_admin | gzip > "$BACKUP_DIR/lk_trade-all-${DATE}.sql.gz"

# ì»¤ìŠ¤í…€ í¬ë§· (ë” ë¹ ë¥¸ ë³µêµ¬, ì„ íƒì  ë³µêµ¬ ê°€ëŠ¥)
docker exec lk-postgres pg_dump -U lk_admin -Fc lk_trade > "$BACKUP_DIR/lk_trade-${DATE}.dump"

SIZE=$(du -h "$BACKUP_DIR/lk_trade-${DATE}.sql.gz" | cut -f1)
echo "âœ… PostgreSQL backup completed: lk_trade-${DATE}.sql.gz ($SIZE)"

# ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "*.dump" -mtime +$RETENTION_DAYS -delete

echo "âœ… Backup completed successfully"
```

### 2.2 PostgreSQL ë³µêµ¬

```bash
#!/bin/bash
# scripts/restore-postgres.sh

set -e

if [ -z "$1" ]; then
    echo "Usage: $0 <backup-file>"
    echo "Example: $0 ./backups/postgres/lk_trade-20250930-103000.sql.gz"
    exit 1
fi

BACKUP_FILE=$1

echo "âš ï¸  WARNING: This will overwrite the current database!"
echo "Backup file: $BACKUP_FILE"
read -p "Are you sure? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Restore cancelled."
    exit 0
fi

echo "ğŸ”„ Stopping services..."
docker-compose stop user-service trade-service account-service strategy-service

echo "ğŸ—„ï¸ Dropping and recreating database..."
docker exec lk-postgres psql -U lk_admin -c "DROP DATABASE IF EXISTS lk_trade;"
docker exec lk-postgres psql -U lk_admin -c "CREATE DATABASE lk_trade;"

echo "ğŸ“¥ Restoring database..."
if [[ "$BACKUP_FILE" == *.sql.gz ]]; then
    # gzip ì••ì¶• íŒŒì¼ ë³µêµ¬
    gunzip -c "$BACKUP_FILE" | docker exec -i lk-postgres psql -U lk_admin lk_trade
elif [[ "$BACKUP_FILE" == *.dump ]]; then
    # ì»¤ìŠ¤í…€ í¬ë§· ë³µêµ¬
    docker exec -i lk-postgres pg_restore -U lk_admin -d lk_trade < "$BACKUP_FILE"
else
    echo "âŒ Unsupported backup format"
    exit 1
fi

echo "ğŸš€ Starting services..."
docker-compose start user-service trade-service account-service strategy-service

echo "âœ… Database restored successfully!"
```

### 2.3 Redis ë°±ì—…

```bash
#!/bin/bash
# scripts/backup-redis.sh

set -e

BACKUP_DIR="./backups/redis"
DATE=$(date +%Y%m%d-%H%M%S)
RETENTION_DAYS=30

mkdir -p "$BACKUP_DIR"

echo "ğŸ“¦ Starting Redis backup..."

# Redis BGSAVE (ë°±ê·¸ë¼ìš´ë“œ ì €ì¥)
docker exec lk-redis redis-cli BGSAVE

# BGSAVE ì™„ë£Œ ëŒ€ê¸°
echo "â³ Waiting for BGSAVE to complete..."
while [ "$(docker exec lk-redis redis-cli LASTSAVE)" = "$(docker exec lk-redis redis-cli LASTSAVE)" ]; do
    sleep 1
done

# dump.rdb íŒŒì¼ ë³µì‚¬
docker cp lk-redis:/data/dump.rdb "$BACKUP_DIR/dump-${DATE}.rdb"

# ì••ì¶•
gzip "$BACKUP_DIR/dump-${DATE}.rdb"

SIZE=$(du -h "$BACKUP_DIR/dump-${DATE}.rdb.gz" | cut -f1)
echo "âœ… Redis backup completed: dump-${DATE}.rdb.gz ($SIZE)"

# ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ
find "$BACKUP_DIR" -name "*.rdb.gz" -mtime +$RETENTION_DAYS -delete

echo "âœ… Backup completed successfully"
```

### 2.4 Redis ë³µêµ¬

```bash
#!/bin/bash
# scripts/restore-redis.sh

set -e

if [ -z "$1" ]; then
    echo "Usage: $0 <backup-file>"
    echo "Example: $0 ./backups/redis/dump-20250930-103000.rdb.gz"
    exit 1
fi

BACKUP_FILE=$1

echo "âš ï¸  WARNING: This will overwrite the current Redis data!"
echo "Backup file: $BACKUP_FILE"
read -p "Are you sure? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Restore cancelled."
    exit 0
fi

echo "ğŸ”„ Stopping Redis..."
docker-compose stop redis

# ì••ì¶• í•´ì œ
TEMP_FILE="/tmp/dump.rdb"
gunzip -c "$BACKUP_FILE" > "$TEMP_FILE"

# Redis ë°ì´í„° ë””ë ‰í† ë¦¬ì— ë³µì‚¬
docker cp "$TEMP_FILE" lk-redis:/data/dump.rdb

# ê¶Œí•œ ì„¤ì •
docker run --rm -v backend1_redis-data:/data alpine chown redis:redis /data/dump.rdb

echo "ğŸš€ Starting Redis..."
docker-compose start redis

# ì •ë¦¬
rm "$TEMP_FILE"

echo "âœ… Redis restored successfully!"
```

---

## 3. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë°±ì—…

### 3.1 ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° (export)

```bash
# ë‹¨ì¼ ì´ë¯¸ì§€ ì €ì¥
docker save lk-trade/user-service:latest | gzip > backups/images/user-service-latest.tar.gz

# ì—¬ëŸ¬ ì´ë¯¸ì§€ í•œ ë²ˆì— ì €ì¥
docker save \
    lk-trade/user-service:latest \
    lk-trade/trade-service:latest \
    lk-trade/account-service:latest \
    lk-trade/strategy-service:latest \
    | gzip > backups/images/lk-trade-all-$(date +%Y%m%d).tar.gz

# ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
ls -lh backups/images/
```

### 3.2 ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° (import)

```bash
# ì••ì¶• í•´ì œí•˜ë©´ì„œ ë¡œë“œ
gunzip -c backups/images/user-service-latest.tar.gz | docker load

# ë˜ëŠ”
docker load < backups/images/user-service-latest.tar.gz

# ë¡œë“œëœ ì´ë¯¸ì§€ í™•ì¸
docker images | grep lk-trade
```

### 3.3 ì´ë¯¸ì§€ ë°±ì—… ìë™í™”

```bash
#!/bin/bash
# scripts/backup-images.sh

set -e

BACKUP_DIR="./backups/images"
DATE=$(date +%Y%m%d-%H%M%S)

mkdir -p "$BACKUP_DIR"

echo "ğŸ–¼ï¸  Starting image backup..."

# LK-Trade ì´ë¯¸ì§€ ëª©ë¡
IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^lk-trade/")

if [ -z "$IMAGES" ]; then
    echo "âš ï¸  No LK-Trade images found"
    exit 1
fi

echo "Found images:"
echo "$IMAGES"
echo ""

# ë°±ì—… íŒŒì¼ëª…
BACKUP_FILE="$BACKUP_DIR/lk-trade-images-${DATE}.tar.gz"

echo "ğŸ“¦ Saving images to: $BACKUP_FILE"
docker save $IMAGES | gzip > "$BACKUP_FILE"

SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
echo "âœ… Image backup completed: $(basename $BACKUP_FILE) ($SIZE)"
```

---

## 4. ì„¤ì • íŒŒì¼ ë°±ì—…

```bash
#!/bin/bash
# scripts/backup-configs.sh

set -e

BACKUP_DIR="./backups/configs"
DATE=$(date +%Y%m%d-%H%M%S)
RETENTION_DAYS=90  # ì„¤ì •ì€ ì˜¤ë˜ ë³´ê´€

mkdir -p "$BACKUP_DIR"

echo "âš™ï¸  Starting configuration backup..."

# ë°±ì—…í•  íŒŒì¼/ë””ë ‰í† ë¦¬ ëª©ë¡
CONFIG_FILES=(
    "docker-compose.yml"
    "docker-compose.prod.yml"
    "docker-compose.dev.yml"
    ".env.example"
    "Makefile"
    "modules/*/api/Dockerfile"
    "modules/*/api/src/main/resources/application*.yml"
    "elk/"
    "scripts/"
)

BACKUP_FILE="$BACKUP_DIR/configs-${DATE}.tar.gz"

echo "ğŸ“¦ Creating backup archive..."
tar czf "$BACKUP_FILE" \
    --exclude="*.log" \
    --exclude=".env" \
    --exclude="secrets/" \
    "${CONFIG_FILES[@]}"

SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
echo "âœ… Configuration backup completed: $(basename $BACKUP_FILE) ($SIZE)"

# ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "âœ… Backup completed successfully"
```

---

## 5. ì „ì²´ ì‹œìŠ¤í…œ ë°±ì—…

ëª¨ë“  ê²ƒì„ í•œ ë²ˆì— ë°±ì—…í•©ë‹ˆë‹¤.

```bash
#!/bin/bash
# scripts/backup-all.sh

set -e

echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LK-Trade Full System Backup              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

DATE=$(date +%Y%m%d-%H%M%S)
BACKUP_ROOT="./backups/full-backup-${DATE}"

mkdir -p "$BACKUP_ROOT"

# 1. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  Database Backup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
mkdir -p "$BACKUP_ROOT/database"

echo "ğŸ˜ PostgreSQL..."
docker exec lk-postgres pg_dumpall -U lk_admin | gzip > "$BACKUP_ROOT/database/postgres.sql.gz"

echo "ğŸ“¦ Redis..."
docker exec lk-redis redis-cli BGSAVE > /dev/null
sleep 2
docker cp lk-redis:/data/dump.rdb "$BACKUP_ROOT/database/redis.rdb"
gzip "$BACKUP_ROOT/database/redis.rdb"

echo "âœ… Database backup completed"
echo ""

# 2. ë³¼ë¥¨ ë°±ì—…
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  Volume Backup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
mkdir -p "$BACKUP_ROOT/volumes"

VOLUMES=$(docker volume ls --format "{{.Name}}" | grep "^backend1_")
for VOLUME in $VOLUMES; do
    echo "ğŸ“¦ $VOLUME..."
    docker run --rm \
        -v "$VOLUME:/data:ro" \
        -v "$(pwd)/$BACKUP_ROOT/volumes:/backup" \
        alpine \
        tar czf "/backup/${VOLUME}.tar.gz" -C /data .
done

echo "âœ… Volume backup completed"
echo ""

# 3. ì´ë¯¸ì§€ ë°±ì—…
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  Image Backup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
mkdir -p "$BACKUP_ROOT/images"

IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^lk-trade/")
if [ ! -z "$IMAGES" ]; then
    echo "ğŸ–¼ï¸  Saving images..."
    docker save $IMAGES | gzip > "$BACKUP_ROOT/images/lk-trade-images.tar.gz"
    echo "âœ… Image backup completed"
else
    echo "âš ï¸  No LK-Trade images found"
fi
echo ""

# 4. ì„¤ì • íŒŒì¼ ë°±ì—…
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  Configuration Backup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
mkdir -p "$BACKUP_ROOT/configs"

echo "âš™ï¸  Copying configuration files..."
tar czf "$BACKUP_ROOT/configs/configs.tar.gz" \
    --exclude="*.log" \
    --exclude=".env" \
    --exclude="secrets/" \
    --exclude="backups/" \
    --exclude="build/" \
    --exclude="node_modules/" \
    --exclude=".git/" \
    .

echo "âœ… Configuration backup completed"
echo ""

# 5. ë°±ì—… ì •ë³´ íŒŒì¼ ìƒì„±
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  Backup Metadata"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cat > "$BACKUP_ROOT/backup-info.txt" <<EOF
LK-Trade System Backup
======================

Backup Date: $(date)
Hostname: $(hostname)
Docker Version: $(docker --version)
Docker Compose Version: $(docker-compose --version)

Containers at backup time:
--------------------------
$(docker ps --format "{{.Names}}: {{.Image}}")

Volumes at backup time:
-----------------------
$(docker volume ls)

Images at backup time:
----------------------
$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^lk-trade/")

Git Information:
----------------
Branch: $(git branch --show-current 2>/dev/null || echo "N/A")
Commit: $(git rev-parse HEAD 2>/dev/null || echo "N/A")
EOF

echo "âœ… Metadata created"
echo ""

# 6. ë°±ì—… ìš”ì•½
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Backup Summary"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
du -sh "$BACKUP_ROOT"
du -sh "$BACKUP_ROOT"/* | sort -h

echo ""
echo "âœ… Full system backup completed successfully!"
echo ""
echo "Backup location: $BACKUP_ROOT"
echo ""
echo "To restore this backup, use:"
echo "  bash scripts/restore-all.sh $BACKUP_ROOT"
```

ì‹¤í–‰ ê²°ê³¼:

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LK-Trade Full System Backup              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1ï¸âƒ£  Database Backup
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ˜ PostgreSQL...
ğŸ“¦ Redis...
âœ… Database backup completed

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2ï¸âƒ£  Volume Backup
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ backend1_postgres-data...
ğŸ“¦ backend1_redis-data...
ğŸ“¦ backend1_elasticsearch-data...
âœ… Volume backup completed

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3ï¸âƒ£  Image Backup
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ–¼ï¸  Saving images...
âœ… Image backup completed

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4ï¸âƒ£  Configuration Backup
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš™ï¸  Copying configuration files...
âœ… Configuration backup completed

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
5ï¸âƒ£  Backup Metadata
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Metadata created

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Backup Summary
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
8.5G    ./backups/full-backup-20250930-103000
256K    ./backups/full-backup-20250930-103000/configs
1.5G    ./backups/full-backup-20250930-103000/database
2.8G    ./backups/full-backup-20250930-103000/images
4.2G    ./backups/full-backup-20250930-103000/volumes

âœ… Full system backup completed successfully!

Backup location: ./backups/full-backup-20250930-103000

To restore this backup, use:
  bash scripts/restore-all.sh ./backups/full-backup-20250930-103000
```

---

## 6. ì „ì²´ ì‹œìŠ¤í…œ ë³µêµ¬

```bash
#!/bin/bash
# scripts/restore-all.sh

set -e

if [ -z "$1" ]; then
    echo "Usage: $0 <backup-directory>"
    echo "Example: $0 ./backups/full-backup-20250930-103000"
    exit 1
fi

BACKUP_DIR=$1

if [ ! -d "$BACKUP_DIR" ]; then
    echo "âŒ Backup directory not found: $BACKUP_DIR"
    exit 1
fi

echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LK-Trade Full System Restore             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

echo "âš ï¸  WARNING: This will OVERWRITE all current data!"
echo "Backup directory: $BACKUP_DIR"
echo ""
cat "$BACKUP_DIR/backup-info.txt"
echo ""
read -p "Are you absolutely sure? Type 'RESTORE' to continue: " CONFIRM

if [ "$CONFIRM" != "RESTORE" ]; then
    echo "Restore cancelled."
    exit 0
fi

# 1. ëª¨ë“  ì»¨í…Œì´ë„ˆ ì¤‘ì§€
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  Stopping all containers"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose down
echo "âœ… Containers stopped"
echo ""

# 2. ì´ë¯¸ì§€ ë³µêµ¬
if [ -f "$BACKUP_DIR/images/lk-trade-images.tar.gz" ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "2ï¸âƒ£  Restoring images"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    gunzip -c "$BACKUP_DIR/images/lk-trade-images.tar.gz" | docker load
    echo "âœ… Images restored"
    echo ""
fi

# 3. ë³¼ë¥¨ ë³µêµ¬
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  Restoring volumes"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
for BACKUP_FILE in "$BACKUP_DIR/volumes"/*.tar.gz; do
    VOLUME=$(basename "$BACKUP_FILE" .tar.gz)
    echo "ğŸ“¦ Restoring $VOLUME..."

    # ë³¼ë¥¨ ì¬ìƒì„±
    docker volume rm "$VOLUME" 2>/dev/null || true
    docker volume create "$VOLUME"

    # ë°ì´í„° ë³µêµ¬
    docker run --rm \
        -v "$VOLUME:/data" \
        -v "$(pwd)/$BACKUP_DIR/volumes:/backup" \
        alpine \
        tar xzf "/backup/$(basename $BACKUP_FILE)" -C /data
done
echo "âœ… Volumes restored"
echo ""

# 4. ì»¨í…Œì´ë„ˆ ì‹œì‘
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  Starting containers"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose up -d
echo "â³ Waiting for containers to be healthy..."
sleep 30
echo "âœ… Containers started"
echo ""

# 5. ë°ì´í„°ë² ì´ìŠ¤ ë³µêµ¬
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  Restoring databases"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ -f "$BACKUP_DIR/database/postgres.sql.gz" ]; then
    echo "ğŸ˜ PostgreSQL..."
    docker-compose stop user-service trade-service account-service strategy-service
    gunzip -c "$BACKUP_DIR/database/postgres.sql.gz" | docker exec -i lk-postgres psql -U lk_admin
    docker-compose start user-service trade-service account-service strategy-service
fi

if [ -f "$BACKUP_DIR/database/redis.rdb.gz" ]; then
    echo "ğŸ“¦ Redis..."
    docker-compose stop redis
    gunzip -c "$BACKUP_DIR/database/redis.rdb.gz" > /tmp/dump.rdb
    docker cp /tmp/dump.rdb lk-redis:/data/dump.rdb
    rm /tmp/dump.rdb
    docker-compose start redis
fi

echo "âœ… Databases restored"
echo ""

# 6. í—¬ìŠ¤ ì²´í¬
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "6ï¸âƒ£  Health Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose ps

echo ""
echo "âœ… Full system restore completed successfully!"
echo ""
echo "Next steps:"
echo "1. Verify data integrity"
echo "2. Check application logs"
echo "3. Test critical functionality"
```

---

## 7. ìë™í™”ëœ ë°±ì—… ìŠ¤ì¼€ì¤„ë§

### 7.1 Cron ì‘ì—… (Linux/Mac)

```bash
# crontab í¸ì§‘
crontab -e

# ì¶”ê°€í•  ë‚´ìš©:
# ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ì „ì²´ ë°±ì—…
0 2 * * * cd /home/user/trade/backend1 && bash scripts/backup-all.sh >> logs/backup.log 2>&1

# ë§¤ 6ì‹œê°„ë§ˆë‹¤ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
0 */6 * * * cd /home/user/trade/backend1 && bash scripts/backup-postgres.sh >> logs/backup-db.log 2>&1

# ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 3ì‹œì— ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬
0 3 * * 0 find /home/user/trade/backend1/backups -name "*.tar.gz" -mtime +30 -delete
```

### 7.2 Windows ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬

```powershell
# PowerShellë¡œ ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡
$action = New-ScheduledTaskAction -Execute "bash.exe" -Argument "scripts/backup-all.sh" -WorkingDirectory "C:\trade\backend1"
$trigger = New-ScheduledTaskTrigger -Daily -At 2am
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask -TaskName "LK-Trade Daily Backup" -Action $action -Trigger $trigger -Principal $principal
```

### 7.3 Docker ì»¨í…Œì´ë„ˆë¡œ ë°±ì—… ìë™í™”

```yaml
# docker-compose.backup.yml
version: '3.8'

services:
  backup-service:
    build:
      context: ./backup-service
      dockerfile: Dockerfile
    container_name: lk-backup-service
    environment:
      - BACKUP_SCHEDULE=0 2 * * *  # cron í‘œí˜„ì‹: ë§¤ì¼ ìƒˆë²½ 2ì‹œ
      - RETENTION_DAYS=30
      - S3_BUCKET=lk-trade-backups
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./backups:/backups
      - backend1_postgres-data:/volumes/postgres:ro
      - backend1_redis-data:/volumes/redis:ro
    networks:
      - lk-trade-network
    depends_on:
      - postgres
      - redis

networks:
  lk-trade-network:
    external: true
```

```dockerfile
# backup-service/Dockerfile
FROM alpine:3.18

RUN apk add --no-cache \
    docker-cli \
    postgresql-client \
    redis \
    aws-cli \
    dcron \
    bash \
    curl

COPY backup-entrypoint.sh /backup-entrypoint.sh
COPY backup-script.sh /backup-script.sh
RUN chmod +x /backup-entrypoint.sh /backup-script.sh

ENTRYPOINT ["/backup-entrypoint.sh"]
```

```bash
#!/bin/bash
# backup-service/backup-entrypoint.sh

# Cron ì‘ì—… ì¶”ê°€
echo "$BACKUP_SCHEDULE /backup-script.sh >> /var/log/backup.log 2>&1" > /etc/crontabs/root

# Cron ì‹œì‘
crond -f -l 2
```

---

## 8. ì›ê²© ë°±ì—… (í´ë¼ìš°ë“œ)

### 8.1 AWS S3ë¡œ ë°±ì—…

```bash
#!/bin/bash
# scripts/backup-to-s3.sh

set -e

S3_BUCKET="s3://lk-trade-backups"
LOCAL_BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d)

echo "â˜ï¸  Starting S3 backup..."

# AWS CLI ì„¤ì¹˜ í™•ì¸
if ! command -v aws &> /dev/null; then
    echo "âŒ AWS CLI not found. Install it first."
    exit 1
fi

# ë¡œì»¬ ë°±ì—… ì‹¤í–‰
echo "ğŸ“¦ Creating local backup..."
bash scripts/backup-all.sh

# S3ë¡œ ì—…ë¡œë“œ
echo "â˜ï¸  Uploading to S3..."
aws s3 sync "$LOCAL_BACKUP_DIR" "$S3_BUCKET/$DATE/" \
    --exclude "*.tmp" \
    --storage-class STANDARD_IA \
    --no-progress

echo "âœ… S3 backup completed"

# ì˜¤ë˜ëœ S3 ë°±ì—… ì‚­ì œ (90ì¼ ì´ìƒ)
echo "ğŸ§¹ Cleaning up old S3 backups..."
aws s3 ls "$S3_BUCKET/" | awk '{print $2}' | while read folder; do
    folder_date=$(echo $folder | tr -d '/')
    if [ $(date -d "$folder_date" +%s 2>/dev/null || echo 0) -lt $(date -d "90 days ago" +%s) ]; then
        echo "Deleting old backup: $folder"
        aws s3 rm "$S3_BUCKET/$folder" --recursive
    fi
done

echo "âœ… S3 backup completed successfully"
```

### 8.2 S3ì—ì„œ ë³µêµ¬

```bash
#!/bin/bash
# scripts/restore-from-s3.sh

set -e

S3_BUCKET="s3://lk-trade-backups"

if [ -z "$1" ]; then
    echo "Available backups:"
    aws s3 ls "$S3_BUCKET/"
    echo ""
    echo "Usage: $0 <backup-date>"
    echo "Example: $0 20250930"
    exit 1
fi

BACKUP_DATE=$1
LOCAL_RESTORE_DIR="./backups/restore-from-s3-$BACKUP_DATE"

echo "â˜ï¸  Downloading backup from S3..."
mkdir -p "$LOCAL_RESTORE_DIR"
aws s3 sync "$S3_BUCKET/$BACKUP_DATE/" "$LOCAL_RESTORE_DIR/" --no-progress

echo "âœ… Download completed"
echo ""
echo "Now run restore:"
echo "  bash scripts/restore-all.sh $LOCAL_RESTORE_DIR/full-backup-*"
```

---

## 9. ì¬í•´ ë³µêµ¬ ê³„íš (Disaster Recovery)

### 9.1 RPOì™€ RTO

```
RPO (Recovery Point Objective)
= ìµœëŒ€ í—ˆìš© ê°€ëŠ¥í•œ ë°ì´í„° ì†ì‹¤ ì‹œê°„
================================

ì˜ˆì‹œ: RPO = 1ì‹œê°„
â†’ 1ì‹œê°„ë§ˆë‹¤ ë°±ì—… í•„ìš”
â†’ ìµœì•…ì˜ ê²½ìš° 1ì‹œê°„ì¹˜ ë°ì´í„° ì†ì‹¤ í—ˆìš©

RTO (Recovery Time Objective)
= ìµœëŒ€ í—ˆìš© ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì‹œê°„
==================================

ì˜ˆì‹œ: RTO = 30ë¶„
â†’ ì¥ì•  ë°œìƒ í›„ 30ë¶„ ë‚´ ë³µêµ¬ ì™„ë£Œ
â†’ ë¹ ë¥¸ ë³µêµ¬ë¥¼ ìœ„í•œ ì¤€ë¹„ í•„ìš”
```

### 9.2 LK-Trade ì¬í•´ ë³µêµ¬ ê³„íš

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì¬í•´ ë³µêµ¬ ë‹¨ê³„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ê°ì§€ (0-5ë¶„)                                 â”‚
â”‚    - ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ ìˆ˜ì‹                          â”‚
â”‚    - ì¥ì•  ìœ í˜• íŒŒì•…                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. í‰ê°€ (5-10ë¶„)                                â”‚
â”‚    - ì˜í–¥ ë²”ìœ„ í™•ì¸                             â”‚
â”‚    - ë³µêµ¬ ë°©ë²• ê²°ì •                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ë³µêµ¬ (10-30ë¶„)                               â”‚
â”‚    - ë°±ì—…ì—ì„œ ë°ì´í„° ë³µêµ¬                       â”‚
â”‚    - ì„œë¹„ìŠ¤ ì¬ì‹œì‘                              â”‚
â”‚    - í—¬ìŠ¤ ì²´í¬                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. ê²€ì¦ (30-40ë¶„)                               â”‚
â”‚    - ë°ì´í„° ë¬´ê²°ì„± í™•ì¸                         â”‚
â”‚    - ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. ì‚¬í›„ ì¡°ì¹˜ (40-60ë¶„)                          â”‚
â”‚    - ì›ì¸ ë¶„ì„                                  â”‚
â”‚    - ì¬ë°œ ë°©ì§€ ëŒ€ì±…                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 ì¬í•´ ë³µêµ¬ ë§¤ë‰´ì–¼

```bash
#!/bin/bash
# scripts/disaster-recovery.sh

cat <<'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   LK-Trade Disaster Recovery Manual               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš¨ DISASTER RECOVERY PROCEDURE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ Pre-Recovery Checklist:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ ] Identify the disaster type:
    - Hardware failure
    - Data corruption
    - Security breach
    - Human error
    - Natural disaster

[ ] Assess the impact:
    - Which services are affected?
    - How much data is lost?
    - Are backups accessible?

[ ] Notify stakeholders:
    - Development team
    - Management
    - Customers (if necessary)

ğŸ”§ Recovery Steps:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Step 1: Stop all services
--------------------------
$ cd /path/to/backend1
$ docker-compose down

Step 2: Identify the latest good backup
---------------------------------------
$ ls -lht backups/
$ ls -lht backups/full-backup-*/

Or check S3:
$ aws s3 ls s3://lk-trade-backups/

Step 3: Restore from backup
----------------------------
Local backup:
$ bash scripts/restore-all.sh ./backups/full-backup-YYYYMMDD-HHMMSS

S3 backup:
$ bash scripts/restore-from-s3.sh YYYYMMDD
$ bash scripts/restore-all.sh ./backups/restore-from-s3-YYYYMMDD/full-backup-*

Step 4: Verify data integrity
------------------------------
$ docker-compose ps
$ docker-compose logs -f

Check databases:
$ docker exec lk-postgres psql -U lk_admin -d lk_trade -c "SELECT COUNT(*) FROM users;"
$ docker exec lk-redis redis-cli DBSIZE

Step 5: Test critical functionality
------------------------------------
[ ] User login
[ ] Place order
[ ] Check account balance
[ ] View trading history

Step 6: Resume normal operations
---------------------------------
$ docker-compose ps
(All containers should be "Up (healthy)")

Step 7: Post-recovery actions
------------------------------
[ ] Document the incident
[ ] Analyze root cause
[ ] Implement preventive measures
[ ] Update disaster recovery plan
[ ] Conduct post-mortem meeting

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ Emergency Contacts:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DevOps Team:    +82-10-XXXX-XXXX
Database Admin: +82-10-YYYY-YYYY
Security Team:  +82-10-ZZZZ-ZZZZ
AWS Support:    +1-XXX-XXX-XXXX

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EOF
```

---

## 10. Makefile í†µí•©

```makefile
# Makefileì— ë°±ì—…/ë³µêµ¬ ëª…ë ¹ ì¶”ê°€

.PHONY: backup backup-all backup-db backup-volumes backup-images restore restore-all backup-s3 restore-s3

# ì „ì²´ ë°±ì—…
backup-all:
	@bash scripts/backup-all.sh

# ë°ì´í„°ë² ì´ìŠ¤ë§Œ ë°±ì—…
backup-db:
	@bash scripts/backup-postgres.sh
	@bash scripts/backup-redis.sh

# ë³¼ë¥¨ë§Œ ë°±ì—…
backup-volumes:
	@bash scripts/backup-volumes.sh

# ì´ë¯¸ì§€ë§Œ ë°±ì—…
backup-images:
	@bash scripts/backup-images.sh

# ì„¤ì •ë§Œ ë°±ì—…
backup-configs:
	@bash scripts/backup-configs.sh

# ì „ì²´ ë³µêµ¬
restore-all:
	@echo "Available backups:"
	@ls -lht backups/full-backup-*/
	@echo ""
	@read -p "Enter backup directory: " dir; \
	bash scripts/restore-all.sh $$dir

# S3 ë°±ì—…
backup-s3:
	@bash scripts/backup-to-s3.sh

# S3ì—ì„œ ë³µêµ¬
restore-s3:
	@bash scripts/restore-from-s3.sh

# ë°±ì—… ëª©ë¡ ë³´ê¸°
backup-list:
	@echo "Local Backups:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@du -sh backups/*/ | sort -h
	@echo ""
	@echo "S3 Backups:"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@aws s3 ls s3://lk-trade-backups/ 2>/dev/null || echo "AWS CLI not configured"

# ì¬í•´ ë³µêµ¬ ë§¤ë‰´ì–¼
disaster-recovery:
	@bash scripts/disaster-recovery.sh
```

ì‚¬ìš© ì˜ˆì‹œ:

```bash
# ì „ì²´ ë°±ì—…
make backup-all

# ë°ì´í„°ë² ì´ìŠ¤ë§Œ ë°±ì—…
make backup-db

# ë°±ì—… ëª©ë¡ ë³´ê¸°
make backup-list

# S3ë¡œ ë°±ì—…
make backup-s3

# ë³µêµ¬
make restore-all

# ì¬í•´ ë³µêµ¬ ë§¤ë‰´ì–¼ ë³´ê¸°
make disaster-recovery
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: ë°±ì—…ì´ ë„ˆë¬´ ëŠë¦¼

```bash
# ì›ì¸: ì••ì¶•ì— ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¼

# í•´ê²°ì±… 1: pigz (ë³‘ë ¬ gzip) ì‚¬ìš©
# ì„¤ì¹˜
sudo apt install pigz  # Ubuntu/Debian
brew install pigz      # Mac

# ì‚¬ìš©
tar cf - data/ | pigz > backup.tar.gz
# ì••ì¶• í•´ì œ
pigz -dc backup.tar.gz | tar xf -

# í•´ê²°ì±… 2: ì••ì¶• ë ˆë²¨ ì¡°ì • (ì†ë„ ìš°ì„ )
tar czf backup.tar.gz --use-compress-program="gzip -1" data/
```

### ë¬¸ì œ 2: ë°±ì—… ì¤‘ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±

```bash
# ì¦ìƒ
tar: Error writing to archive: No space left on device

# í•´ê²°ì±… 1: ì˜¤ë˜ëœ ë°±ì—… ë¨¼ì € ì‚­ì œ
find backups/ -name "*.tar.gz" -mtime +7 -delete

# í•´ê²°ì±… 2: ë‹¤ë¥¸ ë””ìŠ¤í¬ë¡œ ë°±ì—…
tar czf /mnt/backup-disk/backup.tar.gz data/

# í•´ê²°ì±… 3: ìŠ¤íŠ¸ë¦¬ë° ë°±ì—… (ì¤‘ê°„ íŒŒì¼ ìƒì„± ì—†ì´ S3ë¡œ ì§ì ‘)
tar czf - data/ | aws s3 cp - s3://bucket/backup.tar.gz
```

### ë¬¸ì œ 3: ë³µêµ¬ í›„ ê¶Œí•œ ë¬¸ì œ

```bash
# ì¦ìƒ
Permission denied: /data/file.db

# ì›ì¸: ë°±ì—… ì‹œ ê¶Œí•œ ì •ë³´ê°€ ë³´ì¡´ë˜ì§€ ì•ŠìŒ

# í•´ê²°ì±…: ê¶Œí•œ ìˆ˜ì •
docker exec lk-postgres chown -R postgres:postgres /var/lib/postgresql/data
docker exec lk-redis chown -R redis:redis /data
```

---

## ë‹¤ìŒ ë‹¨ê³„

ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰ Docker ë°±ì—…ê³¼ ë³µêµ¬ë¥¼ ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤.

### ì´ë²ˆ ì„¹ì…˜ì—ì„œ ë°°ìš´ ê²ƒ

âœ… ë°±ì—…ì˜ ì¤‘ìš”ì„± ë° 3-2-1 ê·œì¹™
âœ… ë°ì´í„° ë³¼ë¥¨ ë°±ì—… ë° ë³µêµ¬
âœ… ë°ì´í„°ë² ì´ìŠ¤ ë„¤ì´í‹°ë¸Œ ë°±ì—… (PostgreSQL, Redis)
âœ… ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë°±ì—…
âœ… ì „ì²´ ì‹œìŠ¤í…œ ë°±ì—… ë° ë³µêµ¬
âœ… ìë™í™”ëœ ë°±ì—… ìŠ¤ì¼€ì¤„ë§
âœ… í´ë¼ìš°ë“œ ë°±ì—… (AWS S3)
âœ… ì¬í•´ ë³µêµ¬ ê³„íš (DR Plan)

### ë‹¤ìŒì— ë°°ìš¸ ê²ƒ

**ì„¹ì…˜ 29: í”„ë¡œë•ì…˜ ë°°í¬ ì „ëµ**ì—ì„œëŠ”:
- Blue-Green ë°°í¬
- Rolling ì—…ë°ì´íŠ¸
- Canary ë°°í¬
- ë¬´ì¤‘ë‹¨ ë°°í¬ ì „ëµ
- ë¡¤ë°± ì „ëµ

### ì¶”ê°€ í•™ìŠµ ìë£Œ

**ê³µì‹ ë¬¸ì„œ:**
- [Docker Volume Backup](https://docs.docker.com/storage/volumes/#back-up-restore-or-migrate-data-volumes)
- [PostgreSQL Backup](https://www.postgresql.org/docs/current/backup.html)
- [Redis Persistence](https://redis.io/docs/management/persistence/)

**ë„êµ¬:**
- [Restic](https://restic.net/) - íš¨ìœ¨ì ì¸ ë°±ì—… ë„êµ¬
- [Duplicati](https://www.duplicati.com/) - ì•”í˜¸í™”ëœ ë°±ì—…
- [Velero](https://velero.io/) - Kubernetes ë°±ì—… (ì°¸ê³ ìš©)

**ì‹¬í™” í•™ìŠµ:**
- [Disaster Recovery Best Practices](https://aws.amazon.com/disaster-recovery/)
- [Backup Strategies](https://www.backblaze.com/blog/the-3-2-1-backup-strategy/)

---

**ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ë§Œë‚˜ìš”!** ğŸš€