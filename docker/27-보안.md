# ì„¹ì…˜ 27: ë³´ì•ˆ (Security)

## ë¹„ìœ ë¡œ ì‹œì‘í•˜ê¸°

Docker ë³´ì•ˆì€ **ì•„íŒŒíŠ¸ ë³´ì•ˆ ì‹œìŠ¤í…œ**ê³¼ ê°™ìŠµë‹ˆë‹¤.

```
ì•„íŒŒíŠ¸ ë³´ì•ˆ                          Docker ë³´ì•ˆ
===========                          ===========
ğŸ¢ ì™¸ë¶€ ë‹´ì¥                    â†’    ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬
ğŸšª í˜„ê´€ë¬¸ ë³´ì•ˆì¹´ë“œ              â†’    ì»¨í…Œì´ë„ˆ ê²©ë¦¬
ğŸ“¹ CCTV ê°ì‹œ                    â†’    ë¡œê·¸ ëª¨ë‹ˆí„°ë§
ğŸ‘® ê²½ë¹„ì› ìˆœì°°                  â†’    ë³´ì•ˆ ìŠ¤ìºë„ˆ
ğŸ”’ ê° ì„¸ëŒ€ ë„ì–´ë½               â†’    ì»¨í…Œì´ë„ˆ ê¶Œí•œ ì œí•œ
ğŸ—ï¸ ë§ˆìŠ¤í„°í‚¤ ê´€ë¦¬               â†’    Secrets ê´€ë¦¬
ğŸš¨ í™”ì¬ ê²½ë³´ê¸°                  â†’     ë³´ì•ˆ ì´ë²¤íŠ¸ ì•Œë¦¼
ğŸ“‹ ë°©ë¬¸ì ëª…ë¶€                  â†’     ê°ì‚¬ ë¡œê·¸ (Audit Log)
```

ì•„íŒŒíŠ¸ ë³´ì•ˆì´ í—ˆìˆ í•˜ë©´ ë„ë‘‘ì´ ë“¤ë“¯ì´, Docker ë³´ì•ˆì´ í—ˆìˆ í•˜ë©´ í•´ì»¤ê°€ ì‹œìŠ¤í…œì„ ì¥ì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ì™œ Docker ë³´ì•ˆì´ ì¤‘ìš”í•œê°€?

### 1. ë³´ì•ˆ ì‚¬ê³  ì‹œë‚˜ë¦¬ì˜¤

```
âŒ ë³´ì•ˆ ì·¨ì•½ ì‹œìŠ¤í…œ
=================

í•´ì»¤ì˜ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ì·¨ì•½í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°œê²¬
   â†“
2. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ì¹¨íˆ¬ (RCE)
   â†“
3. root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ ì¤‘ â†’ ì»¨í…Œì´ë„ˆ ì™„ì „ ì¥ì•…
   â†“
4. Docker ì†Œì¼“ ë§ˆìš´íŠ¸ ë°œê²¬ â†’ í˜¸ìŠ¤íŠ¸ ì¥ì•…
   â†“
5. ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë„ ëª¨ë‘ ì¥ì•…
   â†“
6. ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ â†’ ê³ ê° ì •ë³´ ìœ ì¶œ
   â†“
7. ëœì„¬ì›¨ì–´ ì„¤ì¹˜ â†’ ì‹œìŠ¤í…œ ì•”í˜¸í™”
   â†“
ğŸ’€ íšŒì‚¬ íŒŒì‚°


âœ… ë³´ì•ˆ ê°•í™” ì‹œìŠ¤í…œ
=================

ê°™ì€ ê³µê²© ì‹œë„:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ì·¨ì•½í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°œê²¬
   â†“
2. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ì¹¨íˆ¬ ì‹œë„
   â†“ ğŸ›¡ï¸ ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ë¡œ ì°¨ë‹¨

2-1. ë‹¤ë¥¸ ê²½ë¡œë¡œ ì¹¨íˆ¬ ì„±ê³µ
   â†“
3. íŒŒì¼ ì‹œìŠ¤í…œ ì¡°ì‘ ì‹œë„
   â†“ ğŸ›¡ï¸ Read-only íŒŒì¼ ì‹œìŠ¤í…œìœ¼ë¡œ ì°¨ë‹¨

3-1. ë©”ëª¨ë¦¬ì—ë§Œ ì•…ì„±ì½”ë“œ ë¡œë“œ
   â†“
4. ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ ê³µê²© ì‹œë„
   â†“ ğŸ›¡ï¸ ì»¨í…Œì´ë„ˆ ê²©ë¦¬ë¡œ ì°¨ë‹¨

4-1. í˜¸ìŠ¤íŠ¸ ê³µê²© ì‹œë„
   â†“ ğŸ›¡ï¸ ê¶Œí•œ ì œí•œìœ¼ë¡œ ì°¨ë‹¨

5. ë¹„ì •ìƒ í™œë™ ê°ì§€
   â†“ ğŸš¨ ì•Œë¦¼ ë°œì†¡

6. ê´€ë¦¬ìê°€ í•´ë‹¹ ì»¨í…Œì´ë„ˆ ê²©ë¦¬/ì¤‘ì§€
   â†“
âœ… í”¼í•´ ìµœì†Œí™”, ì‹œìŠ¤í…œ ë³´í˜¸
```

### 2. Docker ë³´ì•ˆì˜ ì¤‘ìš”ì„±

| ìœ„í˜‘ | ë³´ì•ˆ ì—†ì´ | ë³´ì•ˆ ì ìš© ì‹œ |
|------|----------|------------|
| ğŸ› ì·¨ì•½ì  ê³µê²© | ì‹œìŠ¤í…œ ì „ì²´ ì¥ì•… | ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë§Œ í”¼í•´ |
| ğŸ”“ ê¶Œí•œ ìƒìŠ¹ | root ê¶Œí•œ íšë“ | ì œí•œëœ ê¶Œí•œë§Œ íšë“ |
| ğŸ“¦ ì•…ì„± ì´ë¯¸ì§€ | ë°±ë„ì–´ ì„¤ì¹˜ | ì´ë¯¸ì§€ ìŠ¤ìº”ìœ¼ë¡œ ì°¨ë‹¨ |
| ğŸ”‘ ë¹„ë°€ ì •ë³´ ë…¸ì¶œ | ì½”ë“œì— í•˜ë“œì½”ë”©ëœ ì•”í˜¸ ìœ ì¶œ | Secretsë¡œ ì•ˆì „í•˜ê²Œ ê´€ë¦¬ |
| ğŸŒ ë„¤íŠ¸ì›Œí¬ ê³µê²© | ëª¨ë“  ì»¨í…Œì´ë„ˆ ì ‘ê·¼ ê°€ëŠ¥ | ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ |

---

## Docker ë³´ì•ˆì˜ í•µì‹¬ ì›ì¹™

### 1. ì‹¬ì¸µ ë°©ì–´ (Defense in Depth)

ì—¬ëŸ¬ ê³„ì¸µì˜ ë³´ì•ˆì„ ì ìš©í•˜ì—¬, í•˜ë‚˜ê°€ ëš«ë ¤ë„ ë‹¤ë¥¸ ê³„ì¸µì—ì„œ ë°©ì–´í•©ë‹ˆë‹¤.

```
ë³´ì•ˆ ê³„ì¸µ êµ¬ì¡°
=============

                    ì™¸ë¶€ ê³µê²©
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 1: ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ            â”‚ â† ë°©í™”ë²½, ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 2: ì´ë¯¸ì§€ ë³´ì•ˆ              â”‚ â† ì´ë¯¸ì§€ ìŠ¤ìº”, ì„œëª… ê²€ì¦
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 3: ì»¨í…Œì´ë„ˆ ê²©ë¦¬            â”‚ â† namespace, cgroup
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 4: ê¶Œí•œ ì œí•œ                â”‚ â† non-root, capabilities
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 5: íŒŒì¼ ì‹œìŠ¤í…œ ë³´í˜¸         â”‚ â† read-only, ë³¼ë¥¨ ì œí•œ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 6: Secrets ê´€ë¦¬             â”‚ â† ì•”í˜¸í™”ëœ ë¹„ë°€ ì •ë³´
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ê³„ì¸µ 7: ëª¨ë‹ˆí„°ë§ & ê°ì‚¬          â”‚ â† ë¡œê·¸, ì•Œë¦¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
                  í•µì‹¬ ìì‚°
```

### 2. ìµœì†Œ ê¶Œí•œ ì›ì¹™ (Principle of Least Privilege)

í•„ìš”í•œ ìµœì†Œí•œì˜ ê¶Œí•œë§Œ ë¶€ì—¬í•©ë‹ˆë‹¤.

```
âŒ ë‚˜ìœ ì˜ˆ: ëª¨ë“  ê¶Œí•œ ë¶€ì—¬
docker run --privileged \
  -v /:/host \
  --net=host \
  --pid=host \
  myapp

â†’ ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ê¶Œí•œ (ìœ„í—˜!)


âœ… ì¢‹ì€ ì˜ˆ: ìµœì†Œ ê¶Œí•œë§Œ ë¶€ì—¬
docker run \
  --read-only \
  --user 1000:1000 \
  --cap-drop=ALL \
  --cap-add=NET_BIND_SERVICE \
  --security-opt=no-new-privileges \
  myapp

â†’ ê¼­ í•„ìš”í•œ ê¶Œí•œë§Œ ë¶€ì—¬ (ì•ˆì „)
```

---

## 1. ì´ë¯¸ì§€ ë³´ì•ˆ

### 1.1 ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì‚¬ìš©

```dockerfile
# âŒ ë‚˜ìœ ì˜ˆ: ì¶œì²˜ ë¶ˆëª… ì´ë¯¸ì§€
FROM random-user/ubuntu

# âŒ ë‚˜ìœ ì˜ˆ: latest íƒœê·¸ (ì¬í˜„ì„± ì—†ìŒ)
FROM ubuntu:latest

# âœ… ì¢‹ì€ ì˜ˆ: ê³µì‹ ì´ë¯¸ì§€ + íŠ¹ì • ë²„ì „
FROM ubuntu:22.04

# âœ… ë” ì¢‹ì€ ì˜ˆ: Distroless ì´ë¯¸ì§€ (ìµœì†Œ ì´ë¯¸ì§€)
FROM gcr.io/distroless/java17-debian11

# âœ… ìµœì„ ì˜ ì˜ˆ: ê³µì‹ ì´ë¯¸ì§€ + SHA256 í•´ì‹œ
FROM ubuntu:22.04@sha256:ac58ff7fe25edc58bdf0067ca99df00014dbd032e2246d30a722fa348fd799a5
```

### 1.2 ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ ìµœì†Œí™”

```dockerfile
# âŒ ë‚˜ìœ ì˜ˆ: ë¹Œë“œ ë„êµ¬ê°€ í¬í•¨ëœ í° ì´ë¯¸ì§€
FROM openjdk:17
WORKDIR /app
COPY . .
RUN ./gradlew build
CMD ["java", "-jar", "app.jar"]
# ê²°ê³¼: ì´ë¯¸ì§€ í¬ê¸° ~800MB, ë¹Œë“œ ë„êµ¬ í¬í•¨ (ê³µê²© í‘œë©´ ë„“ìŒ)


# âœ… ì¢‹ì€ ì˜ˆ: ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œ
# Stage 1: ë¹Œë“œ
FROM gradle:8.5-jdk17 AS builder
WORKDIR /app
COPY . .
RUN gradle build --no-daemon

# Stage 2: ì‹¤í–‰ (ìµœì†Œ ì´ë¯¸ì§€)
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# non-root ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

# íŒŒì¼ ë³µì‚¬ ë° ê¶Œí•œ ì„¤ì •
COPY --from=builder /app/build/libs/*.jar app.jar
RUN chown appuser:appuser app.jar

# non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER appuser

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
# ê²°ê³¼: ì´ë¯¸ì§€ í¬ê¸° ~200MB, ë¹Œë“œ ë„êµ¬ ì—†ìŒ (ê³µê²© í‘œë©´ ì¢ìŒ)
```

### 1.3 ì·¨ì•½ì  ìŠ¤ìºë‹

Docker ì´ë¯¸ì§€ì˜ ë³´ì•ˆ ì·¨ì•½ì ì„ ìë™ìœ¼ë¡œ ê²€ì‚¬í•©ë‹ˆë‹¤.

#### Trivy ì‚¬ìš©

```bash
# Trivy ì„¤ì¹˜ (Linux/Mac)
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# Trivy ì„¤ì¹˜ (Docker)
docker pull aquasec/trivy:latest

# ì´ë¯¸ì§€ ìŠ¤ìº”
trivy image lk-trade/user-service:latest

# ì¶œë ¥ ì˜ˆì‹œ:
lk-trade/user-service:latest (alpine 3.18.4)
=========================================

Total: 23 (UNKNOWN: 0, LOW: 12, MEDIUM: 8, HIGH: 3, CRITICAL: 0)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Library     â”‚ Vulnerabilityâ”‚ Severity â”‚ Installed Ver. â”‚   Fixed Version   â”‚            Title              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ openssl        â”‚ CVE-2023-1234â”‚ HIGH     â”‚ 3.1.1          â”‚ 3.1.4             â”‚ OpenSSL: Buffer overflow      â”‚
â”‚ curl           â”‚ CVE-2023-5678â”‚ MEDIUM   â”‚ 8.3.0          â”‚ 8.4.0             â”‚ curl: Cookie injection        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# ì‹¬ê°ë„ë³„ í•„í„°ë§ (HIGH, CRITICALë§Œ)
trivy image --severity HIGH,CRITICAL lk-trade/user-service:latest

# JSON ì¶œë ¥ (CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ í™œìš©)
trivy image --format json --output results.json lk-trade/user-service:latest

# ì·¨ì•½ì  ë°œê²¬ ì‹œ ë¹Œë“œ ì‹¤íŒ¨ (CI/CD)
trivy image --exit-code 1 --severity HIGH,CRITICAL lk-trade/user-service:latest
```

#### Docker Scout ì‚¬ìš© (Docker Desktop ë‚´ì¥)

```bash
# Docker Scout í™œì„±í™”
docker scout --help

# ì´ë¯¸ì§€ ë¶„ì„
docker scout cves lk-trade/user-service:latest

# ê¶Œì¥ ì‚¬í•­ ë³´ê¸°
docker scout recommendations lk-trade/user-service:latest

# ë¹„êµ ë¶„ì„ (ì´ì „ ë²„ì „ê³¼ ë¹„êµ)
docker scout compare lk-trade/user-service:v1.0 --to lk-trade/user-service:v2.0
```

#### CI/CDì— í†µí•©

```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t lk-trade/user-service:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'lk-trade/user-service:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'  # HIGH/CRITICAL ë°œê²¬ ì‹œ ë¹Œë“œ ì‹¤íŒ¨

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
```

### 1.4 ì´ë¯¸ì§€ ì„œëª… ë° ê²€ì¦ (Docker Content Trust)

ì´ë¯¸ì§€ê°€ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ì—ì„œ ì™”ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```bash
# Docker Content Trust í™œì„±í™”
export DOCKER_CONTENT_TRUST=1

# ì´ë¯¸ì§€ push (ìë™ìœ¼ë¡œ ì„œëª…ë¨)
docker push lk-trade/user-service:latest

# ì´ë¯¸ì§€ pull (ì„œëª… ê²€ì¦)
docker pull lk-trade/user-service:latest
# ì„œëª…ì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨

# íŠ¹ì • ì´ë¯¸ì§€ì˜ ì„œëª… ì •ë³´ í™•ì¸
docker trust inspect --pretty lk-trade/user-service:latest
```

---

## 2. ì»¨í…Œì´ë„ˆ ê²©ë¦¬ ë° ê¶Œí•œ ê´€ë¦¬

### 2.1 Non-root ì‚¬ìš©ìë¡œ ì‹¤í–‰

```dockerfile
# âœ… ê¶Œì¥: non-root ì‚¬ìš©ì ìƒì„± ë° ì‚¬ìš©
FROM eclipse-temurin:17-jre-alpine

# ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
WORKDIR /app
COPY --chown=appuser:appuser app.jar app.jar

# non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER appuser

# ì´ì œ ì´ ì»¨í…Œì´ë„ˆëŠ” appuser ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë¨
CMD ["java", "-jar", "app.jar"]
```

```yaml
# docker-compose.yml
services:
  user-service:
    image: lk-trade/user-service:latest
    user: "1000:1000"  # UID:GID ëª…ì‹œ
    # ë˜ëŠ”
    # user: appuser
```

#### ê²€ì¦

```bash
# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì‚¬ìš©ì í™•ì¸
docker exec user-service whoami
# ì¶œë ¥: appuser (âœ…)
# ì¶œë ¥: root (âŒ ìœ„í—˜!)

# í”„ë¡œì„¸ìŠ¤ í™•ì¸
docker exec user-service ps aux
# UIDê°€ 1000ì´ì–´ì•¼ í•¨
```

### 2.2 Linux Capabilities ì œí•œ

Linux CapabilitiesëŠ” root ê¶Œí•œì„ ì„¸ë°€í•˜ê²Œ ë¶„í• í•œ ê²ƒì…ë‹ˆë‹¤.

```yaml
# docker-compose.yml
services:
  user-service:
    image: lk-trade/user-service:latest
    cap_drop:
      - ALL  # ëª¨ë“  capabilities ì œê±°
    cap_add:
      - NET_BIND_SERVICE  # 1024 ì´í•˜ í¬íŠ¸ ë°”ì¸ë”©ë§Œ í—ˆìš©
    security_opt:
      - no-new-privileges:true  # ê¶Œí•œ ìƒìŠ¹ ë°©ì§€
```

ì£¼ìš” Capabilities:

| Capability | ì„¤ëª… | í•„ìš” ì‹œë‚˜ë¦¬ì˜¤ |
|-----------|------|-------------|
| **CAP_NET_BIND_SERVICE** | 1024 ì´í•˜ í¬íŠ¸ ë°”ì¸ë”© | ì›¹ ì„œë²„ (80, 443 í¬íŠ¸) |
| **CAP_NET_ADMIN** | ë„¤íŠ¸ì›Œí¬ ì„¤ì • ë³€ê²½ | VPN, í”„ë¡ì‹œ |
| **CAP_SYS_ADMIN** | ì‹œìŠ¤í…œ ê´€ë¦¬ ì‘ì—… | íŒŒì¼ ì‹œìŠ¤í…œ ë§ˆìš´íŠ¸ |
| **CAP_CHOWN** | íŒŒì¼ ì†Œìœ ê¶Œ ë³€ê²½ | íŒŒì¼ ê¶Œí•œ ë³€ê²½ í•„ìš” ì‹œ |
| **CAP_DAC_OVERRIDE** | íŒŒì¼ ê¶Œí•œ ë¬´ì‹œ | root íŒŒì¼ ì ‘ê·¼ í•„ìš” ì‹œ |

```bash
# í˜„ì¬ ì»¨í…Œì´ë„ˆì˜ capabilities í™•ì¸
docker exec user-service cat /proc/1/status | grep Cap

# ì¶œë ¥ ì˜ˆì‹œ:
CapInh: 0000000000000000
CapPrm: 0000000000000400  # NET_BIND_SERVICEë§Œ ìˆìŒ
CapEff: 0000000000000400
```

### 2.3 AppArmor / SELinux í”„ë¡œíŒŒì¼

ì¶”ê°€ì ì¸ ê°•ì œ ì ‘ê·¼ ì œì–´(MAC)ë¥¼ ì ìš©í•©ë‹ˆë‹¤.

```yaml
# docker-compose.yml (AppArmor)
services:
  user-service:
    image: lk-trade/user-service:latest
    security_opt:
      - apparmor=docker-default  # Dockerì˜ ê¸°ë³¸ AppArmor í”„ë¡œíŒŒì¼
      # ë˜ëŠ” ì»¤ìŠ¤í…€ í”„ë¡œíŒŒì¼
      - apparmor=my-custom-profile
```

```yaml
# docker-compose.yml (SELinux)
services:
  user-service:
    image: lk-trade/user-service:latest
    security_opt:
      - label=type:container_runtime_t
```

### 2.4 Read-only íŒŒì¼ ì‹œìŠ¤í…œ

ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ íŒŒì¼ ìˆ˜ì •ì„ ë°©ì§€í•©ë‹ˆë‹¤.

```yaml
# docker-compose.yml
services:
  user-service:
    image: lk-trade/user-service:latest
    read_only: true  # íŒŒì¼ ì‹œìŠ¤í…œ ì½ê¸° ì „ìš©
    tmpfs:
      - /tmp  # /tmpë§Œ ì“°ê¸° ê°€ëŠ¥ (ë©”ëª¨ë¦¬)
      - /app/logs  # ë¡œê·¸ ë””ë ‰í† ë¦¬ë§Œ ì“°ê¸° ê°€ëŠ¥
```

```bash
# í…ŒìŠ¤íŠ¸
docker exec user-service touch /test.txt
# ì¶œë ¥: touch: cannot touch '/test.txt': Read-only file system (âœ…)

docker exec user-service touch /tmp/test.txt
# ì¶œë ¥: (ì„±ê³µ) (âœ…)
```

### 2.5 PID ì œí•œ

Fork bomb ê³µê²©ì„ ë°©ì–´í•©ë‹ˆë‹¤.

```yaml
# docker-compose.yml
services:
  user-service:
    image: lk-trade/user-service:latest
    pids_limit: 100  # ìµœëŒ€ 100ê°œ í”„ë¡œì„¸ìŠ¤
```

---

## 3. ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ

### 3.1 ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬

```yaml
# docker-compose.yml
version: '3.8'

services:
  # í”„ë¡ íŠ¸ì—”ë“œ (ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥)
  frontend:
    image: lk-trade/frontend:latest
    networks:
      - public
    ports:
      - "80:80"
      - "443:443"

  # API Gateway (ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥)
  api-gateway:
    image: lk-trade/api-gateway:latest
    networks:
      - public
      - internal
    ports:
      - "8080:8080"

  # ë‚´ë¶€ ì„œë¹„ìŠ¤ (ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€)
  user-service:
    image: lk-trade/user-service:latest
    networks:
      - internal
    # ports ì—†ìŒ â†’ ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€

  trade-service:
    image: lk-trade/trade-service:latest
    networks:
      - internal

  # ë°ì´í„°ë² ì´ìŠ¤ (ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€)
  postgres:
    image: postgres:16-alpine
    networks:
      - database
    # ports ì—†ìŒ â†’ ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€

  # ë°±ì—… ì„œë¹„ìŠ¤ (DBë§Œ ì ‘ê·¼ ê°€ëŠ¥)
  backup-service:
    image: lk-trade/backup:latest
    networks:
      - database

networks:
  public:        # ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥
    driver: bridge
  internal:      # API Gateway â†” ë‚´ë¶€ ì„œë¹„ìŠ¤
    driver: bridge
    internal: true  # ì™¸ë¶€ ì¸í„°ë„· ì ‘ê·¼ ë¶ˆê°€
  database:      # ë°ì´í„°ë² ì´ìŠ¤ ì „ìš©
    driver: bridge
    internal: true
```

ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ íš¨ê³¼:

```
ì¸í„°ë„·
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  frontend     â”‚ (public)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api-gateway  â”‚ (public + internal)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user-service, trade-service    â”‚ (internal)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†•ï¸ (ë„¤íŠ¸ì›Œí¬ ë¶„ë¦¬ë¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  postgres, backup-service       â”‚ (database)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

user-service â†’ postgres âŒ (ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬)
backup-service â†’ postgres âœ… (ê°™ì€ ë„¤íŠ¸ì›Œí¬)
ì™¸ë¶€ â†’ user-service âŒ (í¬íŠ¸ ë…¸ì¶œ ì—†ìŒ)
```

### 3.2 ë°©í™”ë²½ ê·œì¹™ (iptables)

```bash
# í˜¸ìŠ¤íŠ¸ ë ˆë²¨ ë°©í™”ë²½ ì„¤ì • (Ubuntu/Debian)
sudo apt install ufw

# ê¸°ë³¸ ì •ì±…: ëª¨ë“  incoming ì°¨ë‹¨, outgoing í—ˆìš©
sudo ufw default deny incoming
sudo ufw default allow outgoing

# í•„ìš”í•œ í¬íŠ¸ë§Œ í—ˆìš©
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# íŠ¹ì • IPì—ì„œë§Œ ì ‘ê·¼ í—ˆìš© (ê´€ë¦¬ì IP)
sudo ufw allow from 203.0.113.10 to any port 22

# ë°©í™”ë²½ í™œì„±í™”
sudo ufw enable

# ìƒíƒœ í™•ì¸
sudo ufw status verbose
```

---

## 4. Secrets ê´€ë¦¬

**ì ˆëŒ€ë¡œ í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒ:**

```dockerfile
# âŒ Dockerfileì— ë¹„ë°€ ì •ë³´ í•˜ë“œì½”ë”©
ENV DB_PASSWORD=super_secret_password

# âŒ ì´ë¯¸ì§€ì— ë¹„ë°€ ì •ë³´ ë³µì‚¬
COPY database.env /app/
```

```yaml
# âŒ docker-compose.ymlì— í‰ë¬¸ ì €ì¥
environment:
  - DB_PASSWORD=super_secret_password
```

ì´ëŸ¬í•œ ë°©ë²•ì€ ì´ë¯¸ì§€ë¥¼ pullí•œ ëˆ„êµ¬ë‚˜ ë¹„ë°€ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

```bash
# ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆìŒ
docker inspect user-service | grep PASSWORD
docker history user-service
```

### 4.1 Docker Secrets (Swarm ëª¨ë“œ)

```bash
# Swarm ì´ˆê¸°í™”
docker swarm init

# Secret ìƒì„±
echo "super_secret_password" | docker secret create db_password -

# ë˜ëŠ” íŒŒì¼ì—ì„œ ìƒì„±
docker secret create db_password ./secrets/db_password.txt

# Secret ëª©ë¡ í™•ì¸
docker secret ls

# Secret ì‚¬ìš©
docker service create \
  --name user-service \
  --secret db_password \
  lk-trade/user-service:latest

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ Secretì€ íŒŒì¼ë¡œ ë§ˆìš´íŠ¸ë¨
# /run/secrets/db_password
```

```yaml
# docker-stack.yml (Swarm)
version: '3.8'

services:
  user-service:
    image: lk-trade/user-service:latest
    secrets:
      - db_password
      - jwt_secret
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - JWT_SECRET_FILE=/run/secrets/jwt_secret

secrets:
  db_password:
    external: true
  jwt_secret:
    external: true
```

ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ Secret ì½ê¸°:

```kotlin
// application.yml
spring:
  datasource:
    password: ${DB_PASSWORD}  # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ì½ê¸°

// or íŒŒì¼ì—ì„œ ì§ì ‘ ì½ê¸°
import java.nio.file.Files
import java.nio.file.Paths

class DatabaseConfig {
    fun getDatabasePassword(): String {
        val secretFile = Paths.get("/run/secrets/db_password")
        return if (Files.exists(secretFile)) {
            Files.readString(secretFile).trim()
        } else {
            System.getenv("DB_PASSWORD") ?: throw IllegalStateException("No DB password")
        }
    }
}
```

### 4.2 í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ (ê°œë°œ í™˜ê²½)

```bash
# .env.example (Gitì— ì»¤ë°‹)
DB_HOST=postgres
DB_PORT=5432
DB_NAME=lk_trade
DB_USER=lk_admin
DB_PASSWORD=CHANGE_ME
JWT_SECRET=CHANGE_ME

# .env (Gitì— ì»¤ë°‹í•˜ì§€ ì•ŠìŒ, .gitignoreì— ì¶”ê°€)
DB_HOST=postgres
DB_PORT=5432
DB_NAME=lk_trade
DB_USER=lk_admin
DB_PASSWORD=actual_secure_password_here
JWT_SECRET=actual_jwt_secret_here
```

```yaml
# docker-compose.yml
services:
  user-service:
    image: lk-trade/user-service:latest
    env_file:
      - .env  # .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
```

```bash
# .gitignore
.env
.env.local
.env.production
secrets/
```

### 4.3 ì™¸ë¶€ Secrets ê´€ë¦¬ ì‹œìŠ¤í…œ

#### HashiCorp Vault

```yaml
# docker-compose.yml
services:
  vault:
    image: vault:1.15
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=myroot
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    cap_add:
      - IPC_LOCK

  user-service:
    image: lk-trade/user-service:latest
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=myroot
    depends_on:
      - vault
```

```kotlin
// Vaultì—ì„œ Secret ì½ê¸°
import com.bettercloud.vault.Vault
import com.bettercloud.vault.VaultConfig

class VaultSecretManager {
    private val vault: Vault

    init {
        val config = VaultConfig()
            .address(System.getenv("VAULT_ADDR"))
            .token(System.getenv("VAULT_TOKEN"))
            .build()
        vault = Vault(config)
    }

    fun getDatabasePassword(): String {
        val response = vault.logical().read("secret/data/database")
        return response.data["password"] as String
    }
}
```

#### AWS Secrets Manager

```kotlin
// AWS Secrets Managerì—ì„œ Secret ì½ê¸°
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueRequest

class AwsSecretManager {
    private val client = SecretsManagerClient.create()

    fun getSecret(secretName: String): String {
        val request = GetSecretValueRequest.builder()
            .secretId(secretName)
            .build()
        val response = client.getSecretValue(request)
        return response.secretString()
    }
}
```

---

## 5. Docker Daemon ë³´ì•ˆ

### 5.1 Docker ì†Œì¼“ ë³´í˜¸

```bash
# âŒ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ: Docker ì†Œì¼“ì„ ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸
docker run -v /var/run/docker.sock:/var/run/docker.sock myapp
# ì´ë ‡ê²Œ í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ í˜¸ìŠ¤íŠ¸ì˜ Dockerë¥¼ ì™„ì „íˆ ì œì–´í•  ìˆ˜ ìˆìŒ!

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ:
docker run --privileged -v /:/host alpine chroot /host
# â†’ í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œ ì™„ì „ ì¥ì•…!
```

Docker ì†Œì¼“ì„ ê¼­ ë§ˆìš´íŠ¸í•´ì•¼ í•œë‹¤ë©´:

```yaml
# docker-compose.yml
services:
  # CI/CD runner ë“± Docker ì œì–´ê°€ í•„ìš”í•œ ê²½ìš°
  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # ì½ê¸° ì „ìš©
    # ì¶”ê°€ ë³´ì•ˆ ì„¤ì •
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
```

### 5.2 TLSë¡œ Docker Daemon ë³´í˜¸

ì›ê²©ì—ì„œ Docker Daemonì— ì ‘ê·¼í•  ë•Œ TLS í•„ìˆ˜:

```bash
# ì¸ì¦ì„œ ìƒì„±
openssl genrsa -out ca-key.pem 4096
openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem

# Docker Daemon ì„¤ì •
# /etc/docker/daemon.json
{
  "hosts": ["unix:///var/run/docker.sock", "tcp://0.0.0.0:2376"],
  "tls": true,
  "tlsverify": true,
  "tlscacert": "/etc/docker/certs/ca.pem",
  "tlscert": "/etc/docker/certs/server-cert.pem",
  "tlskey": "/etc/docker/certs/server-key.pem"
}

# Docker Daemon ì¬ì‹œì‘
sudo systemctl restart docker

# í´ë¼ì´ì–¸íŠ¸ì—ì„œ TLSë¡œ ì—°ê²°
docker --tlsverify \
  --tlscacert=ca.pem \
  --tlscert=cert.pem \
  --tlskey=key.pem \
  -H=tcp://docker-host:2376 ps
```

### 5.3 User Namespace ê²©ë¦¬

ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ rootë¥¼ í˜¸ìŠ¤íŠ¸ì˜ ì¼ë°˜ ì‚¬ìš©ìë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.

```json
// /etc/docker/daemon.json
{
  "userns-remap": "default"
}
```

```bash
# Docker ì¬ì‹œì‘
sudo systemctl restart docker

# í™•ì¸
docker run --rm alpine id
# ì¶œë ¥: uid=0(root) gid=0(root) groups=0(root)
# í•˜ì§€ë§Œ í˜¸ìŠ¤íŠ¸ì—ì„œëŠ”:
ps aux | grep alpine
# ì¶œë ¥: dockremap (UID 100000+)
```

---

## 6. ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ë° ê°ì‚¬

### 6.1 Docker Bench Security

Dockerì˜ ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€ë¥¼ ìë™ìœ¼ë¡œ ê²€ì‚¬í•©ë‹ˆë‹¤.

```bash
# Docker Bench Security ì‹¤í–‰
docker run --rm --net host --pid host --userns host \
  --cap-add audit_control \
  -v /etc:/etc:ro \
  -v /usr/bin/containerd:/usr/bin/containerd:ro \
  -v /usr/bin/runc:/usr/bin/runc:ro \
  -v /usr/lib/systemd:/usr/lib/systemd:ro \
  -v /var/lib:/var/lib:ro \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  docker/docker-bench-security

# ì¶œë ¥ ì˜ˆì‹œ:
[INFO] 1 - Host Configuration
[PASS] 1.1.1 - Ensure a separate partition for containers has been created
[WARN] 1.1.2 - Ensure only trusted users are allowed to control Docker daemon
[PASS] 1.2.1 - Ensure the container host has been hardened
...

[INFO] 4 - Container Images and Build File
[WARN] 4.1 - Ensure a user for the container has been created
[PASS] 4.2 - Ensure that containers use only trusted base images
...

# JSON ì¶œë ¥
docker run ... docker/docker-bench-security -j > bench-results.json
```

### 6.2 Falco (ëŸ°íƒ€ì„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§)

ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ë¹„ì •ìƒ í–‰ìœ„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤.

```yaml
# docker-compose.yml
services:
  falco:
    image: falcosecurity/falco:latest
    privileged: true
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /dev:/host/dev
      - /proc:/host/proc:ro
      - /boot:/host/boot:ro
      - /lib/modules:/host/lib/modules:ro
      - /usr:/host/usr:ro
      - ./falco-rules.yaml:/etc/falco/rules.d/custom-rules.yaml
```

```yaml
# falco-rules.yaml (ì»¤ìŠ¤í…€ ê·œì¹™)
- rule: Unauthorized Process in Container
  desc: Detect unauthorized process execution
  condition: >
    spawned_process and
    container and
    not proc.name in (java, node, python)
  output: >
    Unauthorized process started in container
    (user=%user.name command=%proc.cmdline container=%container.name)
  priority: WARNING

- rule: Write to Non-Temp Directory
  desc: Detect writes to non-temp directories in read-only containers
  condition: >
    open_write and
    container and
    not fd.directory in (/tmp, /app/logs)
  output: >
    Write to unexpected directory
    (file=%fd.name container=%container.name)
  priority: ERROR

- rule: Sensitive File Access
  desc: Detect access to sensitive files
  condition: >
    open_read and
    container and
    fd.name in (/etc/shadow, /etc/passwd, /root/.ssh/id_rsa)
  output: >
    Sensitive file accessed
    (file=%fd.name user=%user.name container=%container.name)
  priority: CRITICAL
```

Falco ì•Œë¦¼:

```
17:23:45.123456789: Warning Unauthorized process started in container
  (user=appuser command=bash container=user-service)

17:24:12.987654321: Error Write to unexpected directory
  (file=/etc/hosts container=user-service)

17:24:58.456789012: Critical Sensitive file accessed
  (file=/etc/shadow user=root container=compromised-container)
```

### 6.3 Audit ë¡œê·¸

Docker ì´ë²¤íŠ¸ë¥¼ ëª¨ë‘ ê¸°ë¡í•©ë‹ˆë‹¤.

```json
// /etc/docker/daemon.json
{
  "log-level": "info",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

```bash
# Docker ì´ë²¤íŠ¸ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
docker events

# íŠ¹ì • ì´ë²¤íŠ¸ í•„í„°ë§
docker events --filter 'type=container' --filter 'event=start'
docker events --filter 'type=container' --filter 'event=exec_start'

# ì¶œë ¥ ì˜ˆì‹œ:
2025-09-30T10:15:32.123456789+09:00 container start abc123 (image=lk-trade/user-service, name=user-service)
2025-09-30T10:16:45.987654321+09:00 container exec_start abc123 (image=lk-trade/user-service, name=user-service)

# JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥
docker events --format '{{json .}}' >> /var/log/docker-events.log
```

---

## LK-Trade í”„ë¡œì íŠ¸ì— ë³´ì•ˆ ì ìš©í•˜ê¸°

### 1. ë³´ì•ˆ ê°•í™”ëœ Dockerfile

```dockerfile
# modules/user/api/Dockerfile
# Stage 1: Build
FROM gradle:8.5-jdk17-alpine AS builder
WORKDIR /build
COPY . .
RUN gradle build --no-daemon -x test

# Stage 2: Runtime
FROM eclipse-temurin:17-jre-alpine

# ë³´ì•ˆ: ë¶ˆí•„ìš”í•œ íŒ¨í‚¤ì§€ ì œê±°, ì—…ë°ì´íŠ¸
RUN apk update && \
    apk upgrade && \
    apk add --no-cache dumb-init && \
    rm -rf /var/cache/apk/*

# ë³´ì•ˆ: non-root ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR /app

# ë³´ì•ˆ: íŒŒì¼ ë³µì‚¬ ë° ê¶Œí•œ ì„¤ì •
COPY --from=builder --chown=appuser:appuser /build/build/libs/*.jar app.jar

# ë³´ì•ˆ: non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER appuser

# ë³´ì•ˆ: í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

EXPOSE 8080

# ë³´ì•ˆ: dumb-initìœ¼ë¡œ PID 1 ë¬¸ì œ í•´ê²°
ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["java", \
     "-XX:+UseContainerSupport", \
     "-XX:MaxRAMPercentage=75.0", \
     "-Djava.security.egd=file:/dev/./urandom", \
     "-jar", "app.jar"]
```

### 2. ë³´ì•ˆ ê°•í™”ëœ docker-compose.yml

```yaml
# docker-compose.prod.yml
version: '3.8'

x-security-defaults: &security-defaults
  cap_drop:
    - ALL
  cap_add:
    - NET_BIND_SERVICE
  security_opt:
    - no-new-privileges:true
  read_only: true
  tmpfs:
    - /tmp

services:
  user-service:
    <<: *security-defaults
    build:
      context: ./modules/user/api
      dockerfile: Dockerfile
    image: lk-trade/user-service:${VERSION:-latest}
    container_name: lk-user-service
    user: "1000:1000"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
    secrets:
      - db_password
      - jwt_secret
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  trade-service:
    <<: *security-defaults
    build:
      context: ./modules/trade/api
      dockerfile: Dockerfile
    image: lk-trade/trade-service:${VERSION:-latest}
    container_name: lk-trade-service
    user: "1000:1000"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - internal
    depends_on:
      postgres:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  postgres:
    image: postgres:16-alpine
    container_name: lk-postgres
    user: postgres
    environment:
      - POSTGRES_DB=lk_trade
      - POSTGRES_USER=lk_admin
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - database
    # ì™¸ë¶€ í¬íŠ¸ ë…¸ì¶œ ì•ˆ í•¨ (ë³´ì•ˆ)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lk_admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: lk-redis
    user: redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - internal
    volumes:
      - redis-data:/data
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

secrets:
  db_password:
    file: ./secrets/db_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt

networks:
  internal:
    driver: bridge
    internal: true  # ì™¸ë¶€ ì¸í„°ë„· ì ‘ê·¼ ì°¨ë‹¨
  database:
    driver: bridge
    internal: true

volumes:
  postgres-data:
  redis-data:
```

### 3. Secrets ë””ë ‰í† ë¦¬ êµ¬ì¡°

```bash
C:\trade\backend1\
â”œâ”€â”€ secrets/              # .gitignoreì— ì¶”ê°€
â”‚   â”œâ”€â”€ .gitkeep         # ë””ë ‰í† ë¦¬ ìœ ì§€ìš©
â”‚   â”œâ”€â”€ db_password.txt  # Gitì— ì»¤ë°‹ ì•ˆ í•¨
â”‚   â””â”€â”€ jwt_secret.txt   # Gitì— ì»¤ë°‹ ì•ˆ í•¨
â”œâ”€â”€ secrets.example/     # Gitì— ì»¤ë°‹
â”‚   â”œâ”€â”€ db_password.txt  # "CHANGE_ME"
â”‚   â””â”€â”€ jwt_secret.txt   # "CHANGE_ME"
â””â”€â”€ scripts/
    â””â”€â”€ generate-secrets.sh
```

```bash
#!/bin/bash
# scripts/generate-secrets.sh

echo "ğŸ” Generating secrets..."

mkdir -p secrets

# DB ë¹„ë°€ë²ˆí˜¸ ìƒì„± (32ì ëœë¤)
openssl rand -base64 32 > secrets/db_password.txt
echo "âœ… Database password generated"

# JWT Secret ìƒì„± (64ì ëœë¤)
openssl rand -base64 64 > secrets/jwt_secret.txt
echo "âœ… JWT secret generated"

# ê¶Œí•œ ì„¤ì • (ì½ê¸° ì „ìš©)
chmod 400 secrets/*.txt

echo "
========================================
Secrets generated successfully! ğŸ‰
========================================

âš ï¸  IMPORTANT: Keep these secrets safe!

Files created:
- secrets/db_password.txt
- secrets/jwt_secret.txt

Next steps:
1. Review the generated secrets
2. Update them if needed
3. NEVER commit secrets/ to Git!
========================================
"
```

### 4. ë³´ì•ˆ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/security-check.sh

echo "ğŸ” Running security checks..."

# 1. Trivy ì´ë¯¸ì§€ ìŠ¤ìº”
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1. Image Vulnerability Scan (Trivy)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
for service in user-service trade-service account-service strategy-service; do
    echo "Scanning lk-trade/$service:latest..."
    trivy image --severity HIGH,CRITICAL lk-trade/$service:latest
done

# 2. Docker Bench Security
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2. Docker Bench Security"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker run --rm --net host --pid host --userns host \
  --cap-add audit_control \
  -v /var/lib:/var/lib:ro \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  docker/docker-bench-security

# 3. ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ì²´í¬
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3. Running Container Security Check"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
for container in $(docker ps --format '{{.Names}}'); do
    echo "Checking $container..."

    # rootë¡œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸
    user=$(docker exec $container whoami 2>/dev/null)
    if [ "$user" = "root" ]; then
        echo "  âŒ WARNING: Running as root"
    else
        echo "  âœ… Running as non-root user: $user"
    fi

    # privileged ëª¨ë“œ í™•ì¸
    privileged=$(docker inspect --format='{{.HostConfig.Privileged}}' $container)
    if [ "$privileged" = "true" ]; then
        echo "  âŒ WARNING: Running in privileged mode"
    else
        echo "  âœ… Not privileged"
    fi

    # Docker ì†Œì¼“ ë§ˆìš´íŠ¸ í™•ì¸
    sock_mount=$(docker inspect --format='{{range .Mounts}}{{if eq .Destination "/var/run/docker.sock"}}true{{end}}{{end}}' $container)
    if [ "$sock_mount" = "true" ]; then
        echo "  âŒ WARNING: Docker socket mounted"
    else
        echo "  âœ… Docker socket not mounted"
    fi
done

echo "
========================================
Security check completed! ğŸ‰
========================================
"
```

### 5. Makefile í†µí•©

```makefile
# Makefile
.PHONY: security-check security-scan secrets-generate

# ë³´ì•ˆ ê²€ì‚¬
security-check:
	@bash scripts/security-check.sh

# ì´ë¯¸ì§€ ì·¨ì•½ì  ìŠ¤ìº”
security-scan:
	@echo "ğŸ” Scanning images for vulnerabilities..."
	@trivy image --severity HIGH,CRITICAL lk-trade/user-service:latest
	@trivy image --severity HIGH,CRITICAL lk-trade/trade-service:latest
	@trivy image --severity HIGH,CRITICAL lk-trade/account-service:latest
	@trivy image --severity HIGH,CRITICAL lk-trade/strategy-service:latest

# Secrets ìƒì„±
secrets-generate:
	@bash scripts/generate-secrets.sh

# ë³´ì•ˆ ê°•í™” ëª¨ë“œë¡œ ì‹œì‘
start-secure:
	@echo "ğŸ”’ Starting in secure mode..."
	@docker-compose -f docker-compose.prod.yml up -d
	@make health-check
```

---

## ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë°°í¬ ì „ì— ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”:

### ì´ë¯¸ì§€ ë³´ì•ˆ
- [ ] ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì‚¬ìš©
- [ ] ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œ ì ìš©
- [ ] ì´ë¯¸ì§€ ì·¨ì•½ì  ìŠ¤ìº” (Trivy)
- [ ] ë¶ˆí•„ìš”í•œ íŒ¨í‚¤ì§€ ì œê±°
- [ ] íŠ¹ì • ë²„ì „ íƒœê·¸ ì‚¬ìš© (`:latest` ê¸ˆì§€)

### ì»¨í…Œì´ë„ˆ ê²©ë¦¬
- [ ] non-root ì‚¬ìš©ìë¡œ ì‹¤í–‰
- [ ] ë¶ˆí•„ìš”í•œ Capabilities ì œê±° (`cap_drop: ALL`)
- [ ] `no-new-privileges` ì„¤ì •
- [ ] Read-only íŒŒì¼ ì‹œìŠ¤í…œ (ê°€ëŠ¥í•œ ê²½ìš°)
- [ ] PID ì œí•œ ì„¤ì •

### ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ
- [ ] ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ (internal ë„¤íŠ¸ì›Œí¬)
- [ ] ë¶ˆí•„ìš”í•œ í¬íŠ¸ ë…¸ì¶œ ê¸ˆì§€
- [ ] ë°©í™”ë²½ ê·œì¹™ ì„¤ì •

### Secrets ê´€ë¦¬
- [ ] í™˜ê²½ ë³€ìˆ˜ë¡œ ë¹„ë°€ ì •ë³´ ì „ë‹¬ (í•˜ë“œì½”ë”© ê¸ˆì§€)
- [ ] `.env` íŒŒì¼ì„ `.gitignore`ì— ì¶”ê°€
- [ ] Docker Secrets ë˜ëŠ” ì™¸ë¶€ ê´€ë¦¬ ì‹œìŠ¤í…œ ì‚¬ìš©
- [ ] Secret íŒŒì¼ ê¶Œí•œ ì œí•œ (400)

### ë¦¬ì†ŒìŠ¤ ì œí•œ
- [ ] CPU ì œí•œ ì„¤ì •
- [ ] ë©”ëª¨ë¦¬ ì œí•œ ì„¤ì •
- [ ] ë””ìŠ¤í¬ I/O ì œí•œ (í•„ìš” ì‹œ)

### ëª¨ë‹ˆí„°ë§ & ê°ì‚¬
- [ ] ë¡œê·¸ ìˆ˜ì§‘ ë° ëª¨ë‹ˆí„°ë§
- [ ] Docker ì´ë²¤íŠ¸ ë¡œê¹…
- [ ] Falco ë˜ëŠ” ìœ ì‚¬ ë„êµ¬ë¡œ ëŸ°íƒ€ì„ ëª¨ë‹ˆí„°ë§
- [ ] ì •ê¸°ì ì¸ ë³´ì•ˆ ìŠ¤ìº”

---

## ë‹¤ìŒ ë‹¨ê³„

ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰ Docker ë³´ì•ˆì˜ ëª¨ë“  ê²ƒì„ ë°°ì› ìŠµë‹ˆë‹¤.

### ì´ë²ˆ ì„¹ì…˜ì—ì„œ ë°°ìš´ ê²ƒ

âœ… ì´ë¯¸ì§€ ë³´ì•ˆ (ë² ì´ìŠ¤ ì´ë¯¸ì§€, ë©€í‹° ìŠ¤í…Œì´ì§€, ì·¨ì•½ì  ìŠ¤ìº”)
âœ… ì»¨í…Œì´ë„ˆ ê²©ë¦¬ ë° ê¶Œí•œ ê´€ë¦¬ (non-root, capabilities, AppArmor)
âœ… ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ (ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬, ë°©í™”ë²½)
âœ… Secrets ê´€ë¦¬ (Docker Secrets, Vault, í™˜ê²½ ë³€ìˆ˜)
âœ… Docker Daemon ë³´ì•ˆ (ì†Œì¼“ ë³´í˜¸, TLS, User Namespace)
âœ… ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ (Docker Bench, Falco, Audit ë¡œê·¸)
âœ… LK-Trade í”„ë¡œì íŠ¸ì— ë³´ì•ˆ ì ìš©

### ë‹¤ìŒì— ë°°ìš¸ ê²ƒ

**ì„¹ì…˜ 28: ë°±ì—…ê³¼ ë³µêµ¬**ì—ì„œëŠ”:
- ë°ì´í„° ë³¼ë¥¨ ë°±ì—… ì „ëµ
- ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ë° ë³µì›
- ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë°±ì—…
- ì¬í•´ ë³µêµ¬ ê³„íš
- ìë™í™”ëœ ë°±ì—… ì‹œìŠ¤í…œ

### ì¶”ê°€ í•™ìŠµ ìë£Œ

**ê³µì‹ ë¬¸ì„œ:**
- [Docker Security](https://docs.docker.com/engine/security/)
- [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
- [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)

**ë„êµ¬:**
- [Trivy](https://github.com/aquasecurity/trivy)
- [Docker Bench Security](https://github.com/docker/docker-bench-security)
- [Falco](https://falco.org/)
- [HashiCorp Vault](https://www.vaultproject.io/)

**ì‹¬í™” í•™ìŠµ:**
- [OWASP Docker Security Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)
- [Linux Capabilities](https://man7.org/linux/man-pages/man7/capabilities.7.html)

---

**ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ë§Œë‚˜ìš”!** ğŸš€