# 23. 팀 협업

## 목차
1. [공통 개발 환경 구성](#공통-개발-환경-구성)
2. [Git을 통한 설정 공유](#git을-통한-설정-공유)
3. [환경 변수 관리 전략](#환경-변수-관리-전략)
4. [팀 코드 리뷰 프로세스](#팀-코드-리뷰-프로세스)
5. [문서화 가이드](#문서화-가이드)
6. [온보딩 가이드](#온보딩-가이드)
7. [팀 컨벤션](#팀-컨벤션)
8. [트러블슈팅 공유](#트러블슈팅-공유)

---

## 공통 개발 환경 구성

### 왜 공통 환경이 중요한가?

**실생활 비유**: 오케스트라의 악기 조율

```
조율되지 않은 오케스트라:
- 바이올린: A=440Hz
- 플루트: A=442Hz
- 피아노: A=438Hz
→ 불협화음 발생!

조율된 오케스트라:
- 모든 악기: A=440Hz
→ 아름다운 하모니!

개발팀도 동일:
- 개발자 A: Node 16, PostgreSQL 14
- 개발자 B: Node 18, PostgreSQL 15
→ "내 컴퓨터에서는 되는데?" 문제 발생!

Docker로 해결:
- 모든 팀원: 동일한 Docker 이미지
→ 환경 차이 제로!
```

### 표준화된 docker-compose.yml

```yaml
# docker-compose.dev.yml
# 모든 팀원이 동일하게 사용

version: '3.8'

x-common-variables: &common-variables
  TZ: Asia/Seoul
  LANG: ko_KR.UTF-8

x-spring-boot-service: &spring-boot-service
  build:
    context: .
    dockerfile: Dockerfile.dev
  environment:
    <<: *common-variables
    SPRING_PROFILES_ACTIVE: dev
  restart: unless-stopped

services:
  # 인프라 (모든 팀원 공통)
  postgres:
    image: postgres:15-alpine
    environment:
      <<: *common-variables
      POSTGRES_DB: lktrade_dev
      POSTGRES_USER: lkuser
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpass}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lkuser -d lktrade_dev"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # 마이크로서비스 (공통 템플릿)
  user-service:
    <<: *spring-boot-service
    container_name: lk-user-service
    ports:
      - "${USER_SERVICE_PORT:-8081}:8080"
      - "${USER_SERVICE_DEBUG_PORT:-5005}:5005"
    volumes:
      - ./modules/user/api/src:/app/api/src:cached
      - gradle-cache:/root/.gradle
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      <<: *common-variables
      SPRING_PROFILES_ACTIVE: dev
      DATABASE_URL: jdbc:postgresql://postgres:5432/lktrade_dev
      REDIS_HOST: redis

  account-service:
    <<: *spring-boot-service
    container_name: lk-account-service
    ports:
      - "${ACCOUNT_SERVICE_PORT:-8082}:8080"
      - "${ACCOUNT_SERVICE_DEBUG_PORT:-5006}:5005"
    volumes:
      - ./modules/account/api/src:/app/api/src:cached
      - gradle-cache:/root/.gradle
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # 개발 도구 (profile로 선택적 실행)
  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@lktrade.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    profiles:
      - tools
    depends_on:
      - postgres

  redis-commander:
    image: rediscommander/redis-commander:latest
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "${REDIS_COMMANDER_PORT:-8090}:8081"
    profiles:
      - tools
    depends_on:
      - redis

volumes:
  postgres-data:
  redis-data:
  pgadmin-data:
  gradle-cache:

networks:
  default:
    name: lktrade-dev
```

### .env 파일 템플릿

```bash
# .env.example
# Git에 커밋 (실제 값 제외)
# 새 팀원은 이 파일을 복사하여 .env.dev 생성

# ======================
# 데이터베이스 설정
# ======================
POSTGRES_PORT=5432
POSTGRES_PASSWORD=  # 팀 리더에게 문의

# ======================
# Redis 설정
# ======================
REDIS_PORT=6379

# ======================
# 서비스 포트 설정
# ======================
USER_SERVICE_PORT=8081
USER_SERVICE_DEBUG_PORT=5005

ACCOUNT_SERVICE_PORT=8082
ACCOUNT_SERVICE_DEBUG_PORT=5006

TRADE_SERVICE_PORT=8083
TRADE_SERVICE_DEBUG_PORT=5007

AI_SERVICE_PORT=8084
AI_SERVICE_DEBUG_PORT=5008

SCRAPER_SERVICE_PORT=8085
SCRAPER_SERVICE_DEBUG_PORT=5009

# ======================
# 개발 도구 포트
# ======================
PGADMIN_PORT=5050
PGADMIN_EMAIL=admin@lktrade.com
PGADMIN_PASSWORD=  # 팀 리더에게 문의

REDIS_COMMANDER_PORT=8090

# ======================
# 외부 API 키
# ======================
# Alpaca API
ALPACA_API_KEY=  # 본인의 테스트 키 입력
ALPACA_SECRET_KEY=  # 본인의 테스트 키 입력
ALPACA_BASE_URL=https://paper-api.alpaca.markets  # Paper Trading

# OpenAI API
OPENAI_API_KEY=  # 팀 공용 키 (팀 리더에게 문의)
OPENAI_MODEL=gpt-4

# ======================
# 기타 설정
# ======================
LOG_LEVEL=debug
DEBUG_MODE=true
```

---

## Git을 통한 설정 공유

### Git 저장소 구조

```
lk-trade/
├── .gitignore                 # Git 제외 파일
├── .env.example               # 환경 변수 템플릿 ✅ Git 포함
├── .env.dev                   # 실제 환경 변수 ❌ Git 제외
├── docker-compose.dev.yml     # 개발 환경 ✅ Git 포함
├── docker-compose.prod.yml    # 프로덕션 환경 ✅ Git 포함
├── Dockerfile.dev             # 개발용 Dockerfile ✅ Git 포함
├── Dockerfile                 # 프로덕션용 Dockerfile ✅ Git 포함
├── Makefile                   # 자동화 스크립트 ✅ Git 포함
├── README.md                  # 프로젝트 설명 ✅ Git 포함
├── docs/
│   ├── SETUP.md              # 환경 설정 가이드 ✅ Git 포함
│   ├── CONVENTIONS.md        # 팀 컨벤션 ✅ Git 포함
│   └── TROUBLESHOOTING.md    # 트러블슈팅 ✅ Git 포함
├── scripts/
│   ├── init-dev-env.sh       # 초기 설정 스크립트 ✅ Git 포함
│   ├── morning-start.sh      # 개발 환경 시작 ✅ Git 포함
│   └── backup-db.sh          # 백업 스크립트 ✅ Git 포함
└── modules/
    ├── user/
    ├── account/
    └── trade/
```

### .gitignore 설정

```gitignore
# .gitignore

# ==================
# 환경 변수 (보안)
# ==================
.env
.env.dev
.env.local
.env.*.local
*.env

# 환경 변수 템플릿은 포함
!.env.example
!.env.template

# ==================
# Docker 관련
# ==================
# 로그 파일
logs/
*.log

# 백업 파일
backup/
*.sql
*.sql.gz
*.tar.gz

# ==================
# IDE 설정 (선택적)
# ==================
# IntelliJ IDEA
.idea/
*.iml
*.iws

# VSCode (개인 설정 제외)
.vscode/*
!.vscode/settings.json.example
!.vscode/launch.json.example
!.vscode/tasks.json.example

# ==================
# OS 생성 파일
# ==================
.DS_Store
Thumbs.db
```

### 팀 설정 파일 공유

```json
// .vscode/settings.json.example
// 팀원은 이 파일을 복사하여 .vscode/settings.json 생성

{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  },

  // Kotlin 설정
  "[kotlin]": {
    "editor.defaultFormatter": "fwcd.kotlin",
    "editor.tabSize": 4
  },

  // Docker 설정
  "docker.showExplorer": true,
  "docker.explorerRefreshInterval": 1000,

  // 프로젝트 경로
  "gradle.nestedProjects": true
}
```

---

## 환경 변수 관리 전략

### 환경 변수 계층 구조

```
우선순위 (높음 → 낮음):
1. 셸 환경 변수 (export DATABASE_PASSWORD=...)
2. docker-compose.yml의 environment
3. .env 파일
4. 애플리케이션 기본값
```

### 보안 환경 변수 관리

#### 1. 팀 공용 시크릿 (1Password, LastPass 등)

```markdown
# docs/SECRETS.md (Git 제외)

## 팀 공용 시크릿

### 데이터베이스
- **위치**: 1Password > LK-Trade Vault > Database
- **항목**: Dev Database Password
- **값**: [1Password에서 확인]

### OpenAI API
- **위치**: 1Password > LK-Trade Vault > APIs
- **항목**: OpenAI API Key
- **값**: [1Password에서 확인]

### 획득 방법
1. 1Password 팀 초대 메일 확인
2. LK-Trade Vault 접근 권한 요청
3. .env.dev 파일에 값 복사
```

#### 2. 개인 테스트 키

```bash
# .env.dev (각자 관리)

# 개인 Alpaca Paper Trading 키
# 획득: https://app.alpaca.markets/paper/dashboard/overview
ALPACA_API_KEY=PK... # 본인 키
ALPACA_SECRET_KEY=... # 본인 키

# 팀 공용 OpenAI 키
# 획득: 1Password > LK-Trade Vault
OPENAI_API_KEY=sk-... # 팀 공용
```

### 환경별 설정 파일

```yaml
# docker-compose.override.yml (Git 제외)
# 개인 맞춤 설정 (포트 충돌 해결 등)

version: '3.8'

services:
  user-service:
    ports:
      - "9081:8080"  # 8081 대신 9081 사용 (개인 설정)

  postgres:
    ports:
      - "5433:5432"  # 5432 대신 5433 사용
```

---

## 팀 코드 리뷰 프로세스

### Pull Request 템플릿

```markdown
# .github/pull_request_template.md

## 변경 사항 요약
<!-- 무엇을 변경했는지 간략히 설명 -->

## 변경 이유
<!-- 왜 이 변경이 필요한지 설명 -->

## 테스트 방법
<!-- 리뷰어가 어떻게 테스트할 수 있는지 -->

### 로컬 테스트
\`\`\`bash
# 1. 브랜치 체크아웃
git checkout feature/user-authentication

# 2. Docker 이미지 재빌드
docker-compose build user-service

# 3. 컨테이너 재시작
docker-compose up -d user-service

# 4. 테스트 실행
curl http://localhost:8081/api/auth/login \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'

# 기대 결과: 200 OK, JWT 토큰 반환
\`\`\`

## 체크리스트
- [ ] 코드 스타일 가이드 준수
- [ ] 단위 테스트 추가/업데이트
- [ ] 통합 테스트 통과
- [ ] 문서 업데이트 (필요시)
- [ ] Docker 이미지 빌드 성공
- [ ] 로컬에서 동작 확인

## 스크린샷 (UI 변경 시)
<!-- 스크린샷 첨부 -->

## 관련 이슈
Closes #123
```

### 코드 리뷰 가이드라인

```markdown
# docs/CODE_REVIEW.md

## 코드 리뷰 원칙

### 리뷰어의 자세
1. **친절하게**: "이렇게 하면 안돼" (❌) → "이렇게 하면 어떨까요?" (✅)
2. **구체적으로**: "코드가 별로" (❌) → "14번 라인의 반복문을 map으로 개선하면 가독성이 좋을 것 같습니다" (✅)
3. **배우는 태도**: 더 나은 방법이 있다면 제안 수용

### 리뷰 체크리스트

#### 기능
- [ ] 요구사항을 충족하는가?
- [ ] 엣지 케이스를 처리하는가?
- [ ] 에러 핸들링이 적절한가?

#### 코드 품질
- [ ] 읽기 쉬운가?
- [ ] 중복 코드가 없는가?
- [ ] 적절히 추상화되었는가?

#### 테스트
- [ ] 테스트 커버리지 충분한가?
- [ ] 테스트가 의미 있는가?

#### Docker 관련
- [ ] Dockerfile 최적화되었는가?
- [ ] docker-compose.yml 변경 사항 문서화되었는가?
- [ ] 환경 변수 변경 시 .env.example 업데이트되었는가?

#### 보안
- [ ] 민감한 정보(API 키, 비밀번호) 하드코딩 안 했는가?
- [ ] SQL Injection 취약점 없는가?
- [ ] XSS 취약점 없는가?

### 리뷰 예제

#### ✅ 좋은 리뷰
\`\`\`
user-service/UserController.kt:45
💡 제안: 이 로직을 UserService로 이동하면 어떨까요?
Controller는 요청/응답 처리만 담당하고, 비즈니스 로직은 Service에서
처리하는 것이 일반적입니다.

참고: https://martinfowler.com/eaaCatalog/serviceLayer.html
\`\`\`

#### ❌ 나쁜 리뷰
\`\`\`
이 코드 스타일이 마음에 안 듭니다. 다시 작성하세요.
\`\`\`
```

---

## 문서화 가이드

### README.md 구조

```markdown
# LK-Trade 프로젝트

## 프로젝트 개요
GPT 기반 자동매매 시스템

## 기술 스택
- Backend: Kotlin, Spring Boot
- Database: PostgreSQL, Redis
- Infrastructure: Docker, Docker Compose
- CI/CD: GitHub Actions

## 빠른 시작

### 사전 요구사항
- Docker Desktop 설치
- Git
- JDK 21 (로컬 개발 시)

### 초기 설정
\`\`\`bash
# 1. 저장소 클론
git clone https://github.com/your-org/lk-trade.git
cd lk-trade

# 2. 환경 변수 설정
cp .env.example .env.dev
# .env.dev 파일 편집 (팀 리더에게 시크릿 요청)

# 3. 개발 환경 시작
make morning

# 또는
docker-compose -f docker-compose.dev.yml up -d
\`\`\`

### 서비스 URL
- User Service: http://localhost:8081
- Account Service: http://localhost:8082
- Trade Service: http://localhost:8083
- pgAdmin: http://localhost:5050

## 개발 워크플로우

### 브랜치 전략
- \`main\`: 프로덕션
- \`develop\`: 개발
- \`feature/*\`: 기능 개발
- \`hotfix/*\`: 긴급 수정

### 커밋 메시지 컨벤션
\`\`\`
feat: 새로운 기능 추가
fix: 버그 수정
docs: 문서 수정
style: 코드 포맷팅
refactor: 코드 리팩토링
test: 테스트 추가/수정
chore: 빌드, 설정 변경
\`\`\`

## 자주 사용하는 명령어
\`\`\`bash
# 개발 환경 시작
make morning

# 로그 확인
make logs

# 특정 서비스 재시작
make restart SERVICE=user-service

# 테스트 실행
make test

# 정리
make clean
\`\`\`

## 문서
- [환경 설정 가이드](docs/SETUP.md)
- [팀 컨벤션](docs/CONVENTIONS.md)
- [트러블슈팅](docs/TROUBLESHOOTING.md)
- [API 문서](docs/API.md)

## 팀 연락처
- 팀 리더: @leader
- 백엔드: @backend-team
- 프론트엔드: @frontend-team

## 라이선스
MIT
```

### 트러블슈팅 문서

```markdown
# docs/TROUBLESHOOTING.md

## 자주 발생하는 문제

### Q1: "Cannot connect to Docker daemon"

**증상**:
\`\`\`
Cannot connect to the Docker daemon at unix:///var/run/docker.sock
\`\`\`

**해결**:
1. Docker Desktop이 실행 중인지 확인
2. (Linux) Docker 서비스 시작: \`sudo systemctl start docker\`
3. 권한 확인: \`sudo usermod -aG docker $USER\` (재로그인 필요)

---

### Q2: "Port 8081 is already allocated"

**증상**:
\`\`\`
Error: bind: address already in use
\`\`\`

**해결**:
\`\`\`bash
# 1. 사용 중인 프로세스 찾기
netstat -tuln | grep 8081

# 2. 프로세스 종료
kill <PID>

# 또는 다른 포트 사용
# .env.dev에서 USER_SERVICE_PORT=9081 설정
\`\`\`

---

### Q3: "Database connection refused"

**증상**:
\`\`\`
Connection refused: postgres:5432
\`\`\`

**해결**:
\`\`\`bash
# 1. PostgreSQL 컨테이너 상태 확인
docker-compose ps postgres

# 2. PostgreSQL 로그 확인
docker-compose logs postgres

# 3. PostgreSQL 재시작
docker-compose restart postgres

# 4. 연결 테스트
docker-compose exec postgres psql -U lkuser -d lktrade_dev
\`\`\`

---

### Q4: "Out of memory" / OOM Killed

**증상**:
\`\`\`
Container exited with code 137
\`\`\`

**해결**:
\`\`\`yaml
# docker-compose.yml에 메모리 증가
services:
  user-service:
    mem_limit: 2g
    environment:
      - JAVA_OPTS=-Xmx1536m
\`\`\`

---

## 도움 요청하기

문제가 해결되지 않으면:

1. **Slack #dev-help 채널**에 다음 정보와 함께 질문:
   - 문제 증상
   - 시도한 해결 방법
   - 에러 로그 (docker logs 출력)
   - 환경 정보 (OS, Docker 버전)

2. **GitHub Issue** 생성:
   - 재현 가능한 최소 예제
   - 스크린샷
   - docker-compose.yml 관련 부분

3. **페어 프로그래밍** 요청
```

---

## 온보딩 가이드

### 신입 팀원 체크리스트

```markdown
# docs/ONBOARDING.md

## 환영합니다! 🎉

### Day 1: 환경 설정

#### 1. 계정 생성
- [ ] GitHub 계정 (팀 Organization에 초대됨)
- [ ] Slack 계정
- [ ] 1Password 계정 (시크릿 관리)

#### 2. 도구 설치
- [ ] Docker Desktop 설치
- [ ] Git 설치
- [ ] IDE 설치 (IntelliJ IDEA / VSCode)

#### 3. 저장소 클론 및 설정
\`\`\`bash
git clone https://github.com/your-org/lk-trade.git
cd lk-trade
cp .env.example .env.dev
# .env.dev 편집 (팀 리더에게 시크릿 요청)
\`\`\`

#### 4. 개발 환경 시작
\`\`\`bash
./scripts/init-dev-env.sh
\`\`\`

#### 5. 동작 확인
- [ ] http://localhost:8081/actuator/health 접속
- [ ] 모든 서비스 UP 확인

---

### Day 2-3: 프로젝트 이해

#### 1. 문서 읽기
- [ ] README.md
- [ ] docs/ARCHITECTURE.md
- [ ] docs/CONVENTIONS.md

#### 2. 코드 탐색
- [ ] User Service 코드 리뷰
- [ ] API 엔드포인트 테스트 (Postman/curl)

#### 3. 첫 번째 작업
- [ ] 간단한 버그 수정 또는 테스트 추가
- [ ] Pull Request 생성
- [ ] 코드 리뷰 받기

---

### Week 2: 첫 기능 개발

#### 1. 기능 선택
멘토와 함께 첫 번째 기능 선택

#### 2. 개발 프로세스
- [ ] 브랜치 생성 (\`feature/...\`)
- [ ] 로컬 개발
- [ ] 테스트 작성
- [ ] Pull Request

#### 3. 배포 프로세스 이해
- [ ] CI/CD 파이프라인 확인
- [ ] 스테이징 배포 관찰
- [ ] 프로덕션 배포 관찰

---

### Month 1: 독립적 작업

#### 1. 복잡한 기능 개발
멘토 도움 최소화, 독립적으로 작업

#### 2. 팀 프로세스 이해
- [ ] 스프린트 플래닝 참여
- [ ] 데일리 스탠드업 리드
- [ ] 회고 참여

#### 3. 지식 공유
- [ ] 배운 내용 문서화
- [ ] 팀 발표 (선택)

---

## 멘토 배정
- 멘토: @mentor-name
- 질문 환영!
```

---

## 팀 컨벤션

### 코드 스타일

```markdown
# docs/CONVENTIONS.md

## 코드 스타일

### Kotlin
- **포맷터**: IntelliJ IDEA 기본 + ktlint
- **네이밍**:
  - 클래스: PascalCase (\`UserService\`)
  - 함수: camelCase (\`getUserById\`)
  - 상수: UPPER_SNAKE_CASE (\`MAX_RETRY_COUNT\`)

### Docker 파일명
- 개발: \`Dockerfile.dev\`
- 프로덕션: \`Dockerfile\`
- 특정 서비스: \`Dockerfile.user-service\`

### Git 브랜치명
- 기능: \`feature/user-authentication\`
- 버그: \`fix/login-error\`
- 긴급: \`hotfix/security-patch\`

### 커밋 메시지
\`\`\`
<type>: <subject>

<body>

<footer>
\`\`\`

**예제**:
\`\`\`
feat: 사용자 인증 API 추가

- JWT 기반 인증 구현
- Refresh Token 로직 추가
- 로그인/로그아웃 엔드포인트

Closes #123
\`\`\`

### Docker Compose 서비스명
- 소문자, 하이픈 구분: \`user-service\`
- 일관성: 모든 서비스 동일한 네이밍 패턴

### 환경 변수명
- 대문자, 언더스코어 구분: \`DATABASE_URL\`
- 프리픽스 사용: \`USER_SERVICE_PORT\`, \`ACCOUNT_SERVICE_PORT\`
```

---

## 트러블슈팅 공유

### 팀 위키 (Confluence/Notion)

```markdown
## 해결된 문제 목록

### 2024-01-15: Docker 빌드 느림
**문제**:
이미지 빌드 시 10분 이상 소요

**원인**:
.dockerignore 누락으로 node_modules 전체 복사

**해결**:
\`\`\`
# .dockerignore 추가
node_modules/
.git/
*.log
\`\`\`

**해결한 사람**: @john
**관련 PR**: #456

---

### 2024-01-10: PostgreSQL 연결 실패
**문제**:
로컬 환경에서 PostgreSQL 연결 안됨

**원인**:
이전 컨테이너의 볼륨이 남아있어 충돌

**해결**:
\`\`\`bash
docker-compose down -v
docker-compose up -d
\`\`\`

**해결한 사람**: @jane
**관련 이슈**: #789
```

### Slack 채널 운영

```
#dev-general: 일반 개발 논의
#dev-help: 도움 요청
#dev-deploy: 배포 알림
#dev-docker: Docker 관련 논의
#dev-random: 잡담
```

---

## 다음 단계

### 24. 리소스 제한 및 관리
- CPU, 메모리 제한
- 디스크 I/O 제한
- 리소스 모니터링

### 학습 자료

**팀 협업**:
- [GitHub Flow](https://guides.github.com/introduction/flow/)
- [Trunk Based Development](https://trunkbaseddevelopment.com/)

**문서화**:
- [Write the Docs](https://www.writethedocs.org/)
- [Documentation Guide](https://www.divio.com/blog/documentation/)

---

**축하합니다! 🎉** 효율적인 팀 협업 환경을 구축했습니다!