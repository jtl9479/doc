# 36ì¥ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ (GC) - Part 2: ì£¼ë‹ˆì–´ ì‹œë‚˜ë¦¬ì˜¤ & ì‹¤ë¬´ ì‚¬ë¡€

## ğŸ‘¨â€ğŸ’» ì£¼ë‹ˆì–´ ê°œë°œìê°€ ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜

### ì‹¤ìˆ˜ 1: System.gc() ë‚¨ìš©ìœ¼ë¡œ ì¸í•œ Full GC ìœ ë°œ

**ìƒí™©**: ì‹ ì… ê°œë°œìê°€ ë©”ëª¨ë¦¬ ì •ë¦¬ë¥¼ ìœ„í•´ System.gc()ë¥¼ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤.

```java
// âŒ ì£¼ë‹ˆì–´ ê°œë°œìê°€ ì‘ì„±í•œ ì½”ë“œ
public class DataProcessor {
    public void processLargeData(List<Data> dataList) {
        // ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬
        for (Data data : dataList) {
            processData(data);
        }

        // "ì²˜ë¦¬ ëë‚¬ìœ¼ë‹ˆ ë©”ëª¨ë¦¬ ì •ë¦¬í•´ì•¼ì§€!"
        System.gc();  // â† âŒ ì ˆëŒ€ ê¸ˆì§€!
        // ì˜ë„: "ì“°ë ˆê¸° ê°ì²´ ë¹¨ë¦¬ ì¹˜ìš°ì"
        // ì‹¤ì œ: Full GC ìœ ë°œ â†’ ìˆ˜ë°± ms ~ ìˆ˜ ì´ˆ ë©ˆì¶¤!

        System.out.println("ì²˜ë¦¬ ì™„ë£Œ! ë©”ëª¨ë¦¬ë„ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•¨!");
    }
}

// ì‹¤ì œ ë¡œê·¸:
[Full GC (System.gc()) 2000M->500M(4000M) 1.234 secs]
                       â†‘ 1.2ì´ˆ ë™ì•ˆ ëª¨ë“  ìš”ì²­ ì§€ì—°!
                       â†‘ ì‚¬ìš©ì: "ì™œ ì´ë ‡ê²Œ ëŠë ¤?"

// API ì„œë²„ì—ì„œ ì‚¬ìš© ì‹œ:
// - ì´ˆë‹¹ 1000ê±´ ìš”ì²­ ì²˜ë¦¬ ì¤‘
// - System.gc() í˜¸ì¶œ ìˆœê°„: 1.2ì´ˆ ë™ì•ˆ ë©ˆì¶¤
// - 1200ê±´ì˜ ìš”ì²­ì´ ëª¨ë‘ ì§€ì—°ë¨
// - íƒ€ì„ì•„ì›ƒ ë°œìƒ â†’ ì‚¬ìš©ì ë¶ˆë§Œ í­ì£¼!
```

**ë¬¸ì œì **:

1. **Full GC ê°•ì œ ìœ ë°œ**:
```java
// System.gc()ëŠ” Full GCë¥¼ ìœ ë°œí•¨
// Full GC = Young + Old ì „ì²´ ê²€ì‚¬ (ë§¤ìš° ëŠë¦¼!)

// ìì—°ìŠ¤ëŸ¬ìš´ GC (System.gc() ì—†ì´):
[GC (Allocation Failure) [PSYoungGen: 100M->10M] 5ms]
                                      â†‘ Youngë§Œ ê²€ì‚¬
                                      â†‘ 5ms (ë§¤ìš° ë¹ ë¦„!)

// System.gc() í˜¸ì¶œ ì‹œ:
[Full GC (System.gc()) [PSYoungGen: 100M->0M]
                       [ParOldGen: 1000M->800M]
                       1234ms]
        â†‘ Young + Old ëª¨ë‘ ê²€ì‚¬ (246ë°° ëŠë¦¼!)
```

2. **ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ íƒ€ì´ë°**:
```java
System.gc();  // í˜¸ì¶œí•´ë„ ì¦‰ì‹œ ì‹¤í–‰ ë³´ì¥ ì•ˆ ë¨!
// JVM: "ë°”ì˜ë‹ˆê¹Œ ë‚˜ì¤‘ì— í• ê²Œ~"

// ë˜í•œ JVM ì˜µì…˜ìœ¼ë¡œ ë¬´ì‹œ ê°€ëŠ¥:
java -XX:+DisableExplicitGC MyApp
// â†’ System.gc()ë¥¼ í˜¸ì¶œí•´ë„ ì•„ë¬´ ì¼ë„ ì•ˆ ì¼ì–´ë‚¨!
```

3. **ë²¤ì¹˜ë§ˆí¬ (1ë§Œ ë²ˆ í˜¸ì¶œ)**:
```java
// With System.gc()
long start = System.currentTimeMillis();
for (int i = 0; i < 10000; i++) {
    processData();
    System.gc();  // âŒ ë§¤ë²ˆ Full GC!
}
long end = System.currentTimeMillis();
System.out.println("ì†Œìš” ì‹œê°„: " + (end - start) + "ms");
// ì¶œë ¥: ì†Œìš” ì‹œê°„: 234000ms (234ì´ˆ!)

// Without System.gc()
start = System.currentTimeMillis();
for (int i = 0; i < 10000; i++) {
    processData();  // GCê°€ ì•Œì•„ì„œ
}
end = System.currentTimeMillis();
System.out.println("ì†Œìš” ì‹œê°„: " + (end - start) + "ms");
// ì¶œë ¥: ì†Œìš” ì‹œê°„: 2000ms (2ì´ˆ!)

// âš¡ 117ë°° ë¹ ë¦„!
```

**ì˜¬ë°”ë¥¸ ì½”ë“œ**:

```java
// âœ… GCì—ê²Œ ë§¡ê¸°ê¸°
public class DataProcessor {
    public void processLargeData(List<Data> dataList) {
        // ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬
        for (Data data : dataList) {
            processData(data);
        }

        // System.gc() í˜¸ì¶œ ì•ˆ í•¨!
        // GCê°€ í•„ìš”í•  ë•Œ ì•Œì•„ì„œ ì‹¤í–‰:
        // - Eden ê°€ë“ ì°¸ â†’ Minor GC (5ms)
        // - Old ê°€ë“ ì°¸ â†’ Major GC (50-100ms, ë“œë¬¼ê²Œ)

        System.out.println("ì²˜ë¦¬ ì™„ë£Œ!");
    }
}

// ë¡œê·¸:
[GC (Allocation Failure) [PSYoungGen: 100M->10M] 5ms]
                                      â†‘ 5msë§Œ ë©ˆì¶¤!
// ì‚¬ìš©ì: "ë¹ ë¥´ë„¤!"
```

**ë°°ìš´ ì **:
- ğŸ’¡ **System.gc()ëŠ” 99.9%ì˜ ê²½ìš° í˜¸ì¶œí•˜ë©´ ì•ˆ ë¨**
- ğŸ’¡ JVM ì˜µì…˜: `-XX:+DisableExplicitGC` ì¶”ê°€ (System.gc() ë¬´ì‹œ)
- ğŸ’¡ GC íŠœë‹ì€ Heap í¬ê¸°, GC ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ!
- ğŸ’¡ ìœ ì¼í•œ ì˜ˆì™¸: í…ŒìŠ¤íŠ¸/ë””ë²„ê¹… í™˜ê²½ì—ì„œë§Œ

---

### ì‹¤ìˆ˜ 2: Static ì»¬ë ‰ì…˜ì— ê³„ì† ì¶”ê°€í•˜ì—¬ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜

**ìƒí™©**: ìºì‹œë¥¼ ë§Œë“¤ì—ˆëŠ”ë° ì ì  ëŠë ¤ì§€ë‹¤ê°€ OutOfMemoryError ë°œìƒ!

```java
// âŒ ì£¼ë‹ˆì–´ ê°œë°œìê°€ ì‘ì„±í•œ ì½”ë“œ
public class UserCache {
    // "ì‚¬ìš©ì ì •ë³´ë¥¼ ìºì‹œí•´ì„œ DB ì¡°íšŒë¥¼ ì¤„ì´ì!"
    private static Map<String, User> cache = new HashMap<>();

    public static User getUser(String userId) {
        // ìºì‹œì— ìˆìœ¼ë©´ ë°˜í™˜
        if (cache.containsKey(userId)) {
            return cache.get(userId);
        }

        // ì—†ìœ¼ë©´ DBì—ì„œ ì¡°íšŒ í›„ ìºì‹œì— ì¶”ê°€
        User user = database.findUser(userId);
        cache.put(userId, user);  // â† âŒ ê³„ì† ìŒ“ì„! ì œê±° ì•ˆ í•¨!
        return user;
    }

    // ì œê±° ë©”ì„œë“œê°€ ì—†ìŒ! (ì¹˜ëª…ì )
}

// ì‹¤í–‰:
// Day 1: ì‚¬ìš©ì 1000ëª… â†’ cache í¬ê¸° 1000 (10MB)
// Day 2: ì‚¬ìš©ì 10000ëª… â†’ cache í¬ê¸° 10000 (100MB)
// Day 3: ì‚¬ìš©ì 100000ëª… â†’ cache í¬ê¸° 100000 (1GB)
// Day 7: ì‚¬ìš©ì 1000000ëª… â†’ cache í¬ê¸° 1000000 (10GB)
// â†’ OutOfMemoryError: Java heap space
```

**ë¬¸ì œì **:

1. **ë¬´í•œì • ì¦ê°€**:
```bash
# GC ë¡œê·¸ (ì‹œê°„ ê²½ê³¼):
[GC pause (young) 100M->10M(4000M) 5ms]  # Day 1: ì •ìƒ
[GC pause (young) 500M->50M(4000M) 12ms]  # Day 2: ì¡°ê¸ˆ ëŠë ¤ì§
[GC pause (young) 2000M->200M(4000M) 50ms]  # Day 3: ë§ì´ ëŠë ¤ì§
[Full GC (Ergonomics) 3800M->3750M(4000M) 5234ms]  # Day 7: ì¹˜ëª…ì !
                      â†‘ 3.8GB â†’ 3.75GB (50MBë°–ì— íšŒìˆ˜ ëª»í•¨!)
                      â†‘ 5.2ì´ˆ ë™ì•ˆ ë©ˆì¶¤!

java.lang.OutOfMemoryError: Java heap space  # ìµœì¢… ê²°ê³¼
```

2. **GCê°€ íšŒìˆ˜í•  ìˆ˜ ì—†ìŒ**:
```java
// static ë³€ìˆ˜ = GC Root
// â†’ cacheê°€ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  ê°ì²´ëŠ” Reachable
// â†’ GCê°€ ì ˆëŒ€ íšŒìˆ˜í•  ìˆ˜ ì—†ìŒ!

Stack (GC Root)  â† ë©”ì„œë“œ ì¢…ë£Œ ì‹œ ì‚¬ë¼ì§ (Unreachable)
static (GC Root)  â† í”„ë¡œê·¸ë¨ ì¢…ë£Œê¹Œì§€ ì‚´ì•„ìˆìŒ (í•­ìƒ Reachable)
                 â†“
          cache (HashMap)
                 â†“
          User ê°ì²´ 100ë§Œ ê°œ (10GB)
          â†‘ ëª¨ë‘ Reachable â†’ GC íšŒìˆ˜ ë¶ˆê°€!
```

3. **ì‹¤ì œ í”¼í•´ ì‚¬ë¡€**:
```java
// ì ì‹¬ í”¼í¬ ì‹œê°„ (12:00-13:00):
// - ì‹ ê·œ ì‚¬ìš©ì 10ë§Œ ëª… ìœ ì…
// - cacheì— 10ë§Œ ê°œ ì¶”ê°€ (1GB)
// - Old Generation ê°€ë“ ì°¸
// - Full GC ë°œìƒ (5ì´ˆ ë©ˆì¶¤)
// - ëª¨ë“  ì£¼ë¬¸/ê²°ì œ íƒ€ì„ì•„ì›ƒ
// - ê³ ê° ë¶ˆë§Œ í­ì£¼!

// íšŒì‚¬ í”¼í•´:
// - 1ì‹œê°„ ë™ì•ˆ ì„œë¹„ìŠ¤ ëŠë ¤ì§
// - ì£¼ë¬¸ ì‹¤íŒ¨ 1ë§Œ ê±´+
// - ë§¤ì¶œ ì†ì‹¤ 1ì–µ ì›+
// - ê³ ê° ì´íƒˆ 5ì²œ ëª…+
```

**ì˜¬ë°”ë¥¸ ì½”ë“œ**:

```java
// âœ… í•´ê²° 1: í¬ê¸° ì œí•œ (LRU ìºì‹œ)
public class UserCache {
    private static final int MAX_SIZE = 10000;  // ìµœëŒ€ 1ë§Œ ëª…

    private static Map<String, User> cache =
        Collections.synchronizedMap(
            new LinkedHashMap<String, User>(MAX_SIZE, 0.75f, true) {
                @Override
                protected boolean removeEldestEntry(Map.Entry<String, User> eldest) {
                    return size() > MAX_SIZE;  // 1ë§Œ ê°œ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ê²ƒ ì œê±°
                }
            }
        );

    public static User getUser(String userId) {
        if (cache.containsKey(userId)) {
            return cache.get(userId);
        }

        User user = database.findUser(userId);
        cache.put(userId, user);  // 1ë§Œ ê°œ ì´ˆê³¼ ì‹œ ìë™ ì œê±°!
        return user;
    }
}

// ê²°ê³¼:
// - cache í¬ê¸°: í•­ìƒ 10000ê°œ ì´í•˜ ìœ ì§€ (100MB)
// - Old Generation ì••ë ¥ ê°ì†Œ
// - Full GC ê±°ì˜ ì•ˆ ì¼ì–´ë‚¨
// - ì„œë¹„ìŠ¤ ì•ˆì •ì !

// âœ… í•´ê²° 2: TTL (Time To Live) - Caffeine ì‚¬ìš©
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import java.util.concurrent.TimeUnit;

public class UserCache {
    private static Cache<String, User> cache =
        Caffeine.newBuilder()
                .maximumSize(10000)  // ìµœëŒ€ 1ë§Œ ê°œ
                .expireAfterWrite(10, TimeUnit.MINUTES)  // 10ë¶„ í›„ ìë™ ì‚­ì œ
                .expireAfterAccess(5, TimeUnit.MINUTES)  // 5ë¶„ê°„ ì•ˆ ì“°ë©´ ì‚­ì œ
                .build();

    public static User getUser(String userId) {
        return cache.get(userId, id -> database.findUser(id));
        // ìºì‹œì— ì—†ìœ¼ë©´ DB ì¡°íšŒ â†’ ìºì‹œì— ì¶”ê°€
        // 10ë¶„ í›„ ë˜ëŠ” 5ë¶„ê°„ ë¯¸ì‚¬ìš© ì‹œ ìë™ ì œê±°!
    }
}

// ê²°ê³¼:
// - cache í¬ê¸°: í•­ìƒ ì•ˆì „í•œ ë²”ìœ„ ìœ ì§€
// - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: 100MBë¡œ ì¼ì •
// - ì˜¤ë˜ëœ ë°ì´í„° ìë™ ì œê±° (í•­ìƒ ìµœì‹  ìœ ì§€)
// - OOM ì—†ìŒ!

// âœ… í•´ê²° 3: WeakHashMap (ìë™ GC)
public class UserCache {
    // ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ GCê°€ ìë™ìœ¼ë¡œ ì œê±°
    private static Map<String, User> cache = new WeakHashMap<>();

    public static User getUser(String userId) {
        if (cache.containsKey(userId)) {
            return cache.get(userId);
        }

        User user = database.findUser(userId);
        cache.put(userId, user);
        return user;
    }
}

// ë™ì‘:
// - Heap ì—¬ìœ  ìˆìŒ: cache ìœ ì§€ (ë¹ ë¥¸ ì¡°íšŒ)
// - Heap ë¶€ì¡±: GCê°€ cache ì¼ë¶€ ì œê±° (OOM ë°©ì§€)
// ë‹¨ì : ì–¸ì œ ì œê±°ë ì§€ ì˜ˆì¸¡ ë¶ˆê°€ (ìºì‹œ íˆíŠ¸ìœ¨ ë¶ˆì•ˆì •)
```

**ë°°ìš´ ì **:
- ğŸ’¡ **Static ì»¬ë ‰ì…˜ ì‚¬ìš© ì‹œ í¬ê¸° ì œí•œ í•„ìˆ˜!**
- ğŸ’¡ Caffeine ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¶Œì¥ (TTL, í¬ê¸° ì œí•œ, í†µê³„)
- ğŸ’¡ WeakHashMapì€ ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ GCê°€ ìë™ ì •ë¦¬
- ğŸ’¡ ìºì‹œëŠ” í•­ìƒ ëª¨ë‹ˆí„°ë§ (í¬ê¸°, íˆíŠ¸ìœ¨, ë©”ëª¨ë¦¬)

---

### ì‹¤ìˆ˜ 3: Finalizer ì‚¬ìš©ìœ¼ë¡œ GC ì„±ëŠ¥ ì €í•˜

**ìƒí™©**: ë¦¬ì†ŒìŠ¤ ì •ë¦¬ë¥¼ ìœ„í•´ finalize()ë¥¼ ì˜¤ë²„ë¼ì´ë“œí–ˆëŠ”ë° GCê°€ ëŠë ¤ì¡ŒìŠµë‹ˆë‹¤.

```java
// âŒ ì£¼ë‹ˆì–´ ê°œë°œìê°€ ì‘ì„±í•œ ì½”ë“œ
public class DatabaseConnection {
    private Connection connection;

    public DatabaseConnection(String url) {
        this.connection = DriverManager.getConnection(url);
    }

    // "ìë™ìœ¼ë¡œ ì—°ê²°ì„ ë‹«ì•„ì£¼ë©´ ì¢‹ê² ë‹¤!"
    @Override
    protected void finalize() throws Throwable {
        try {
            if (connection != null && !connection.isClosed()) {
                connection.close();  // â† âŒ ì–¸ì œ ì‹¤í–‰ë ì§€ ëª¨ë¦„!
                System.out.println("Connection ìë™ìœ¼ë¡œ ë‹«í˜!");
            }
        } finally {
            super.finalize();
        }
    }
}

// ì‚¬ìš©:
for (int i = 0; i < 10000; i++) {
    DatabaseConnection conn = new DatabaseConnection(url);
    // ì‘ì—…
    // conn.close() í˜¸ì¶œ ì•ˆ í•¨!
    // "finalize()ê°€ ì•Œì•„ì„œ ë‹«ì•„ì£¼ê² ì§€?"
}

// ì‹¤ì œë¡œ ì¼ì–´ë‚˜ëŠ” ì¼:
// 1. 10000ê°œ Connection ìƒì„±
// 2. ë©”ì„œë“œ ëë‚˜ë©´ ëª¨ë‘ Unreachable
// 3. GC ì‹¤í–‰... í•˜ì§€ë§Œ finalize()ê°€ ìˆëŠ” ê°ì²´ëŠ” ì¦‰ì‹œ íšŒìˆ˜ ì•ˆ ë¨!
// 4. Finalizer Queueì— ìŒ“ì„ (10000ê°œ)
// 5. Finalizer Threadê°€ í•˜ë‚˜ì”© ì‹¤í–‰ (ë§¤ìš° ëŠë¦¼!)
// 6. 10000ê°œ ì²˜ë¦¬í•˜ëŠ”ë° ìˆ˜ì‹­ ì´ˆ~ìˆ˜ ë¶„ ì†Œìš”
// 7. ê·¸ ë™ì•ˆ Connection 10000ê°œê°€ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ìˆìŒ (ìˆ˜ë°± MB)
// 8. DB ì—°ê²° í’€ ê³ ê°ˆ â†’ ìƒˆ ìš”ì²­ ì²˜ë¦¬ ë¶ˆê°€!
```

**ë¬¸ì œì **:

1. **GC ì„±ëŠ¥ ì €í•˜**:
```java
// Finalizerê°€ ìˆëŠ” ê°ì²´ì˜ GC ê³¼ì •:
// 1. Minor GC: Edenì—ì„œ Unreachable ê°ì²´ ë°œê²¬
// 2. í•˜ì§€ë§Œ finalize()ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ íšŒìˆ˜ ì•ˆ í•¨!
// 3. Finalizer Queueë¡œ ì´ë™ (Old Generationìœ¼ë¡œ ìŠ¹ê²©)
// 4. Finalizer Threadê°€ finalize() ì‹¤í–‰
// 5. ë‹¤ìŒ GC ë•Œ ë¹„ë¡œì†Œ íšŒìˆ˜

// ì¼ë°˜ ê°ì²´:
new Object()  â†’ Eden â†’ Unreachable â†’ Minor GC â†’ íšŒìˆ˜ (5ms)

// Finalizer ìˆëŠ” ê°ì²´:
new DatabaseConnection()
  â†’ Eden
  â†’ Unreachable
  â†’ Minor GC
  â†’ Finalizer Queue (Oldë¡œ ìŠ¹ê²©!)  â† ë¬¸ì œ!
  â†’ Finalizer Thread ì‹¤í–‰ (ëŠë¦¼!)
  â†’ ë‹¤ìŒ Major GC
  â†’ íšŒìˆ˜ (ìˆ˜ë°± ms ~ ìˆ˜ ì´ˆ)

// ì„±ëŠ¥ ë¹„êµ:
// ì¼ë°˜ ê°ì²´: Minor GC 1íšŒ (5ms)
// Finalizer ê°ì²´: Minor GC 1íšŒ + Old ìŠ¹ê²© + Finalizer ì‹¤í–‰ + Major GC (ìˆ˜ë°± ms)
// â†’ 100ë°° ì´ìƒ ëŠë¦¼!
```

2. **Finalizer Queue í­ë°œ**:
```bash
# jstatìœ¼ë¡œ í™•ì¸:
jstat -gcutil <pid> 1000

# ì¶œë ¥:
S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
0.00   0.00  95.00  85.00  90.00  85.00  1000   10.000   50   100.000  110.000
                    â†‘ Old Generation 85% (ë†’ìŒ!)
                                        â†‘ Full GC 50íšŒ (ë„ˆë¬´ ë§ìŒ!)

# Finalizer Queue í™•ì¸:
jcmd <pid> GC.finalizer_info

# ì¶œë ¥:
Number of objects pending for finalization: 10000
â†‘ 10000ê°œ ê°ì²´ê°€ finalize() ëŒ€ê¸° ì¤‘!
â†‘ ëª¨ë‘ Old Generationì— ìŒ“ì—¬ìˆìŒ!
```

3. **ì‹¤ì œ ì¥ì•  ì‚¬ë¡€**:
```java
// ë°°ì¹˜ ì‘ì—… (ë§¤ì¼ ìì • ì‹¤í–‰):
// - 100ë§Œ ê±´ ë°ì´í„° ì²˜ë¦¬
// - ê° ê±´ë§ˆë‹¤ DatabaseConnection ìƒì„± (finalize() ìˆìŒ)
// - 100ë§Œ ê°œ ê°ì²´ê°€ Finalizer Queueì— ìŒ“ì„
// - Finalizer Threadê°€ ì²˜ë¦¬í•˜ëŠ”ë° 8ì‹œê°„ ì†Œìš”!
// - ë‹¤ìŒ ë‚  ìì •ì— ë˜ 100ë§Œ ê±´ ì¶”ê°€...
// - Finalizer Queue: 200ë§Œ ê°œ...
// - OutOfMemoryError ë°œìƒ!
// - ë°°ì¹˜ ì‘ì—… ì‹¤íŒ¨!

// í”¼í•´:
// - ë°°ì¹˜ ì‘ì—… 3ì¼ ì—°ì† ì‹¤íŒ¨
// - ë°ì´í„° ì²˜ë¦¬ ëˆ„ë½
// - ê³ ê° ë¶ˆë§Œ
// - ê¸´ê¸‰ íŒ¨ì¹˜ íˆ¬ì…
```

**ì˜¬ë°”ë¥¸ ì½”ë“œ**:

```java
// âœ… try-with-resources (Java 7+)
public class DatabaseConnection implements AutoCloseable {
    private Connection connection;

    public DatabaseConnection(String url) throws SQLException {
        this.connection = DriverManager.getConnection(url);
    }

    @Override
    public void close() {  // AutoCloseable ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
        try {
            if (connection != null && !connection.isClosed()) {
                connection.close();
                System.out.println("Connection ëª…ì‹œì ìœ¼ë¡œ ë‹«í˜!");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // finalize() ì œê±°! (ì‚¬ìš© ì•ˆ í•¨)
}

// ì‚¬ìš©:
for (int i = 0; i < 10000; i++) {
    try (DatabaseConnection conn = new DatabaseConnection(url)) {
        // ì‘ì—…
    }  // â† ë¸”ë¡ ëë‚˜ë©´ ìë™ìœ¼ë¡œ close() í˜¸ì¶œ!
       // finalize()ê°€ ì•„ë‹ˆë¼ close()ê°€ ì¦‰ì‹œ ì‹¤í–‰ë¨!
}

// ê²°ê³¼:
// - 10000ê°œ Connectionì´ ì¦‰ì‹œ ë‹«í˜ (finalize() ëŒ€ê¸° ì•ˆ í•¨)
// - GC ë¶€ë‹´ ì—†ìŒ (ì¼ë°˜ ê°ì²´ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
// - Minor GC 1íšŒë¡œ ëª¨ë‘ íšŒìˆ˜ (5ms)
// - Finalizer Queue ì—†ìŒ
// - DB ì—°ê²° í’€ ê±´ê°•!
```

**ì„±ëŠ¥ ë¹„êµ (10000ê°œ ê°ì²´ ìƒì„±/í•´ì œ)**:

| ë°©ì‹ | GC ì‹œê°„ | Finalizer Queue | Memory | ì•ˆì •ì„± |
|------|---------|----------------|--------|--------|
| **finalize()** | 5234ms (Major GC í•„ìš”) | 10000ê°œ ìŒ“ì„ | 500MB (Oldë¡œ ìŠ¹ê²©) | âŒ ë¶ˆì•ˆì • |
| **try-with-resources** | 5ms (Minor GCë§Œ) | 0ê°œ | 50MB (ì¦‰ì‹œ íšŒìˆ˜) | âœ… ì•ˆì •ì  |

â†’ **1046ë°° ë¹ ë¦„!** âš¡

**ë°°ìš´ ì **:
- ğŸ’¡ **finalize()ëŠ” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€!** (Deprecated in Java 9)
- ğŸ’¡ AutoCloseable + try-with-resources ì‚¬ìš©
- ğŸ’¡ ë¦¬ì†ŒìŠ¤ëŠ” ëª…ì‹œì ìœ¼ë¡œ close() í˜¸ì¶œ
- ğŸ’¡ Finalizer QueueëŠ” jcmdë¡œ ëª¨ë‹ˆí„°ë§

---

### ì‹¤ìˆ˜ 4: ë£¨í”„ ë‚´ì—ì„œ ë¶ˆí•„ìš”í•œ ê°ì²´ ìƒì„±

**ìƒí™©**: ëŒ€ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì¤‘ Minor GCê°€ ë„ˆë¬´ ìì£¼ ë°œìƒí•©ë‹ˆë‹¤.

```java
// âŒ ì£¼ë‹ˆì–´ ê°œë°œìê°€ ì‘ì„±í•œ ì½”ë“œ
public class DataFormatter {
    public List<String> formatData(List<Data> dataList) {
        List<String> result = new ArrayList<>();

        for (Data data : dataList) {  // 100ë§Œ ê±´ ì²˜ë¦¬
            // ë§¤ë²ˆ ìƒˆ ê°ì²´ ìƒì„±! (ì¹˜ëª…ì )
            SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            // â† âŒ 100ë§Œ ê°œ SimpleDateFormat ìƒì„±!

            String timestamp = formatter.format(data.getDate());

            // ë¬¸ìì—´ ì—°ê²°ë„ ë¹„íš¨ìœ¨ì !
            String formatted = new String("[" + timestamp + "] " + data.getValue());
            // â† âŒ new String() ë¶ˆí•„ìš”!
            // â† âŒ String ì—°ê²°ë§ˆë‹¤ ìƒˆ String ìƒì„±!

            result.add(formatted);
        }

        return result;
    }
}

// ì‹¤í–‰:
List<Data> bigData = loadBigData();  // 100ë§Œ ê±´
formatData(bigData);

// GC ë¡œê·¸:
[GC pause (Allocation Failure) 25M->5M 5ms]
[GC pause (Allocation Failure) 25M->5M 5ms]  â† 1ì´ˆì— 10íšŒ!
[GC pause (Allocation Failure) 25M->5M 5ms]  â† Minor GC ë„ˆë¬´ ìì£¼!
[GC pause (Allocation Failure) 25M->5M 5ms]
...
// 100ì´ˆ ë™ì•ˆ Minor GC 1000íšŒ ë°œìƒ!
// ì´ GC ì‹œê°„: 5ì´ˆ (5% ë‚­ë¹„)
```

**ë¬¸ì œì **:

1. **Eden ì••ë ¥ ì¦ê°€**:
```java
// ë£¨í”„ 1íšŒë‹¹ ìƒì„±ë˜ëŠ” ê°ì²´:
// 1. SimpleDateFormat: 5KB
// 2. String (timestamp): 20bytes
// 3. String (formatted, new String()): 50bytes
// 4. String ì—°ê²° ì¤‘ê°„ ìƒì„±ë˜ëŠ” String: 30bytes Ã— 3 = 90bytes
// ì´: ì•½ 5.16KB per iteration

// 100ë§Œ íšŒ:
// 5.16KB Ã— 1,000,000 = 5.16GB!
// Eden í¬ê¸°: 256MB
// â†’ 256MB ì°¨ë©´ Minor GC â†’ 20ë²ˆ ì±„ìš°ë©´ 5GB
// â†’ Minor GC 20íšŒ ë°œìƒ! (ë§¤ 5ë§Œ ê±´ë§ˆë‹¤)

// ì‹¤ì œ GC ë¡œê·¸:
[GC (Allocation Failure) [PSYoungGen: 256M->10M] 5ms]  # 5ë§Œ ê±´ ì²˜ë¦¬ í›„
[GC (Allocation Failure) [PSYoungGen: 256M->10M] 5ms]  # 10ë§Œ ê±´
[GC (Allocation Failure) [PSYoungGen: 256M->10M] 5ms]  # 15ë§Œ ê±´
...
// 20íšŒ Minor GC (ì´ 100ms ë‚­ë¹„)
```

2. **ì˜¤í† ë°•ì‹± ë¬¸ì œ**:
```java
// âŒ Integer ê°ì²´ 100ë§Œ ê°œ ìƒì„±
List<Integer> numbers = new ArrayList<>();
for (int i = 0; i < 1000000; i++) {
    numbers.add(i);  // â† int â†’ Integer (ì˜¤í† ë°•ì‹±)
                     // â† 100ë§Œ ê°œ Integer ê°ì²´ ìƒì„±!
}

// Integer 1ê°œ = 16 bytes
// 100ë§Œ ê°œ = 16MB
// Eden í¬ê¸°: 256MB
// â†’ Minor GC ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ë„... í•˜ì§€ë§Œ ë¹„íš¨ìœ¨ì !

// âœ… primitive ë°°ì—´
int[] numbers = new int[1000000];
for (int i = 0; i < 1000000; i++) {
    numbers[i] = i;  // ì˜¤í† ë°•ì‹± ì—†ìŒ!
}

// int[] 1ê°œ = 4MB (ë°°ì—´ ìì²´ë§Œ)
// â†’ ë©”ëª¨ë¦¬ 4ë°° ì ˆì•½!
// â†’ ê°ì²´ 100ë§Œ ê°œ ì•ˆ ë§Œë“¦!
```

3. **ì„±ëŠ¥ ì¸¡ì •** (100ë§Œ ê±´ ì²˜ë¦¬):

```java
// âŒ ë‚˜ìœ ì½”ë“œ
public String badConcat() {
    String result = "";
    for (int i = 0; i < 1000000; i++) {
        result += i;  // ë§¤ë²ˆ ìƒˆ String ìƒì„±!
    }
    return result;
}
// ì†Œìš” ì‹œê°„: ì¸¡ì • ë¶ˆê°€ (ëë‚˜ì§€ ì•ŠìŒ!)
// ì´ìœ : O(nÂ²) ì‹œê°„ ë³µì¡ë„ (n=100ë§Œì´ë©´ 10Â¹Â² ì—°ì‚°!)

// âœ… StringBuilder ì‚¬ìš©
public String goodConcat() {
    StringBuilder sb = new StringBuilder();
    for (int i = 0; i < 1000000; i++) {
        sb.append(i);  // ë‚´ë¶€ ë²„í¼ ì¬ì‚¬ìš©!
    }
    return sb.toString();
}
// ì†Œìš” ì‹œê°„: 234ms (1000ë°°+ ë¹ ë¦„!)
```

**ì˜¬ë°”ë¥¸ ì½”ë“œ**:

```java
// âœ… ê°ì²´ ì¬ì‚¬ìš© + StringBuilder
public class DataFormatter {
    // SimpleDateFormatì„ í•„ë“œë¡œ (ì¬ì‚¬ìš©)
    // ì£¼ì˜: SimpleDateFormatì€ Thread-safeí•˜ì§€ ì•ŠìŒ!
    // â†’ ThreadLocal ì‚¬ìš©
    private static final ThreadLocal<SimpleDateFormat> formatter =
        ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));

    public List<String> formatData(List<Data> dataList) {
        List<String> result = new ArrayList<>(dataList.size());  // ì´ˆê¸° ìš©ëŸ‰ ì„¤ì •
        StringBuilder sb = new StringBuilder(100);  // ì¬ì‚¬ìš©í•  StringBuilder

        for (Data data : dataList) {
            // SimpleDateFormat ì¬ì‚¬ìš© (ThreadLocalì—ì„œ ê°€ì ¸ì˜´)
            String timestamp = formatter.get().format(data.getDate());

            // StringBuilder ì¬ì‚¬ìš© (clear + append)
            sb.setLength(0);  // ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì¬ì‚¬ìš©!)
            sb.append('[').append(timestamp).append("] ").append(data.getValue());

            // new String() ë¶ˆí•„ìš” (toString()ìœ¼ë¡œ ì¶©ë¶„)
            result.add(sb.toString());
        }

        return result;
    }
}

// ì„±ëŠ¥ ë¹„êµ (100ë§Œ ê±´):

// âŒ ë‚˜ìœ ì½”ë“œ:
// - SimpleDateFormat: 100ë§Œ ê°œ ìƒì„± (5GB)
// - String: 400ë§Œ ê°œ ìƒì„± (200MB)
// - Minor GC: 20íšŒ (100ms)
// - ì†Œìš” ì‹œê°„: 15000ms

// âœ… ì¢‹ì€ ì½”ë“œ:
// - SimpleDateFormat: 1ê°œ ì¬ì‚¬ìš© (5KB)
// - String: 100ë§Œ ê°œ ìƒì„± (50MB, í•„ìˆ˜ì ì¸ ê²ƒë§Œ)
// - Minor GC: 1íšŒ (5ms)
// - ì†Œìš” ì‹œê°„: 1200ms

// âš¡ 12.5ë°° ë¹ ë¦„!
// âš¡ ë©”ëª¨ë¦¬ 100ë°° ì ˆì•½!
// âš¡ GC íšŸìˆ˜ 20ë°° ê°ì†Œ!
```

**ì¶”ê°€ ìµœì í™”**:

```java
// âœ… ê°ì²´ í’€ë§ (Object Pool)
public class DataFormatterWithPool {
    // StringBuilder í’€ (ì¬ì‚¬ìš©)
    private static final ThreadLocal<StringBuilder> builderPool =
        ThreadLocal.withInitial(() -> new StringBuilder(256));

    public List<String> formatData(List<Data> dataList) {
        List<String> result = new ArrayList<>(dataList.size());
        SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        StringBuilder sb = builderPool.get();  // í’€ì—ì„œ ê°€ì ¸ì˜´

        for (Data data : dataList) {
            sb.setLength(0);  // ì´ˆê¸°í™”
            sb.append('[')
              .append(formatter.format(data.getDate()))
              .append("] ")
              .append(data.getValue());

            result.add(sb.toString());
        }

        return result;
    }
}

// âœ… Primitive ì»¬ë ‰ì…˜ (Fastutil ë¼ì´ë¸ŒëŸ¬ë¦¬)
import it.unimi.dsi.fastutil.ints.IntArrayList;

// âŒ Integer 100ë§Œ ê°œ (16MB + ê°ì²´ 100ë§Œ ê°œ)
List<Integer> boxed = new ArrayList<>();
for (int i = 0; i < 1000000; i++) {
    boxed.add(i);  // ì˜¤í† ë°•ì‹±!
}

// âœ… int 100ë§Œ ê°œ (4MB, ê°ì²´ 1ê°œ)
IntArrayList primitives = new IntArrayList();
for (int i = 0; i < 1000000; i++) {
    primitives.add(i);  // ì˜¤í† ë°•ì‹± ì—†ìŒ!
}
// â†’ ë©”ëª¨ë¦¬ 4ë°° ì ˆì•½!
// â†’ GC ì••ë ¥ ì œë¡œ!
```

**ë°°ìš´ ì **:
- ğŸ’¡ **ë£¨í”„ ë‚´ ê°ì²´ ìƒì„± ìµœì†Œí™”** (ì¬ì‚¬ìš©!)
- ğŸ’¡ ThreadLocalë¡œ ê°ì²´ í’€ë§
- ğŸ’¡ StringBuilder ì¬ì‚¬ìš© (setLength(0))
- ğŸ’¡ Primitive íƒ€ì… ì‚¬ìš© (ì˜¤í† ë°•ì‹± í”¼í•˜ê¸°)
- ğŸ’¡ Fastutil ë“± primitive ì»¬ë ‰ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©

---

## ğŸ¢ ì‹¤ë¬´ í™œìš© ì‚¬ë¡€

### ì‚¬ë¡€ 1: ì¿ íŒ¡ ìƒí’ˆ ê²€ìƒ‰ ì‹œìŠ¤í…œ - HashMap ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í•´ê²°

```bash
# ë¬¸ì œ ìƒí™© (2021ë…„)
- ì„œë¹„ìŠ¤: ì¿ íŒ¡ ì‹¤ì‹œê°„ ìƒí’ˆ ê²€ìƒ‰ API
- ì„œë²„: 100ëŒ€ (ê° 32GB Heap)
- GC: G1 GC ì‚¬ìš©
- ë¬¸ì œ: í•˜ë£¨ê°€ ì§€ë‚ ìˆ˜ë¡ ëŠë ¤ì§ â†’ ìƒˆë²½ 2ì‹œê²½ OOM ë°œìƒ
  â†’ ë§¤ì¼ ìì •ì— ì„œë²„ ì¬ì‹œì‘ í•„ìš” (ìš´ì˜íŒ€ ì•¼ê·¼)

# ì¦ìƒ
00:00 (ìì •): ì„œë²„ ì¬ì‹œì‘
  â†’ Heap ì‚¬ìš©ëŸ‰: 2GB (ì •ìƒ)
  â†’ ì‘ë‹µ ì‹œê°„: 50ms (ë¹ ë¦„!)

06:00 (ì•„ì¹¨): Heap ì‚¬ìš©ëŸ‰ 10GB
  â†’ ì‘ë‹µ ì‹œê°„: 80ms (ì¡°ê¸ˆ ëŠë¦¼)

12:00 (ì ì‹¬): Heap ì‚¬ìš©ëŸ‰ 20GB
  â†’ ì‘ë‹µ ì‹œê°„: 150ms (ëŠë¦¼!)
  â†’ Minor GC ë¹ˆë„: 10ì´ˆë§ˆë‹¤ (ë„ˆë¬´ ìì£¼!)

18:00 (ì €ë…): Heap ì‚¬ìš©ëŸ‰ 28GB (ê±°ì˜ ê°€ë“!)
  â†’ ì‘ë‹µ ì‹œê°„: 300ms (ë§¤ìš° ëŠë¦¼!)
  â†’ Major GC ë°œìƒ: 2-3ì´ˆ ë©ˆì¶¤!
  â†’ ì‚¬ìš©ì ë¶ˆë§Œ: "ê²€ìƒ‰ì´ ì•ˆ ë¼ìš”!"

02:00 (ìƒˆë²½): OutOfMemoryError
  â†’ ì„œë¹„ìŠ¤ ë‹¤ìš´
  â†’ ê¸´ê¸‰ ì¬ì‹œì‘
  â†’ ë§¤ì¼ ë°˜ë³µ...

# GC ë¡œê·¸ ë¶„ì„
[GC pause (G1 Evacuation Pause) (young) 2048M->500M 12ms]  # 06:00 (ì •ìƒ)
[GC pause (G1 Evacuation Pause) (young) 4096M->2000M 45ms]  # 12:00 (ëŠë¦¼)
[GC pause (G1 Evacuation Pause) (young) 8192M->6000M 123ms]  # 18:00 (ë§¤ìš° ëŠë¦¼)
[Full GC (Allocation Failure) 31000M->30500M(32000M) 5234ms]  # 01:00 (ì¹˜ëª…ì !)
                                â†‘ 500MBë°–ì— íšŒìˆ˜ ëª»í•¨!
                                â†‘ 5.2ì´ˆ ë©ˆì¶¤!
java.lang.OutOfMemoryError: Java heap space  # 02:00 (ì„œë¹„ìŠ¤ ë‹¤ìš´)
```

**ì›ì¸ ë¶„ì„ (Heap Dump)**:

```bash
# 1. Heap Dump ìƒì„± (01:00, OOM ì§ì „)
jmap -dump:format=b,file=coupang_heapdump.hprof <pid>

# Heap Dump í¬ê¸°: 28GB (!)

# 2. MAT (Memory Analyzer Tool)ë¡œ ë¶„ì„
# Leak Suspects Report:

Problem Suspect 1:
  One instance of "com.coupang.search.ProductCache"
  loaded by "sun.misc.Launcher$AppClassLoader"
  occupies 27,845,234,567 bytes (87.5% of total heap)

  â†‘ ProductCacheê°€ ì „ì²´ Heapì˜ 87.5% ì°¨ì§€!
  â†‘ 27.8GB!

# 3. Dominator Tree

| Class Name | Shallow Heap | Retained Heap | Count |
|------------|--------------|---------------|-------|
| ProductCache | 48 bytes | 27.8GB (87.5%) | 1 |
| HashMap$Node[] | 20GB | 20GB | 1 |
| Product[] | 7.8GB | 7.8GB | 5,000,000 |

â†‘ Product ê°ì²´ê°€ 500ë§Œ ê°œ!
â†‘ Product 1ê°œ í‰ê·  í¬ê¸°: 1.56KB
â†‘ 500ë§Œ ê°œ Ã— 1.56KB = 7.8GB

# 4. Path to GC Roots

ProductCache (27.8GB)
  â† static field: cache (HashMap)
  â† com.coupang.search.SearchService
  â† GC Root (Static)

â†‘ static HashMapì— 500ë§Œ ê°œ Productê°€ ìŒ“ì—¬ìˆìŒ!
```

**ë¬¸ì œ ì½”ë“œ**:

```java
// âŒ ì›ì¸ ì½”ë“œ
public class ProductCache {
    // ìƒí’ˆ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ìºì‹œ (DB ì¡°íšŒ ì¤„ì´ê¸° ìœ„í•´)
    private static Map<String, Product> cache = new HashMap<>();

    public static Product getProduct(String productId) {
        // ìºì‹œì— ìˆìœ¼ë©´ ë°˜í™˜
        if (cache.containsKey(productId)) {
            return cache.get(productId);
        }

        // ì—†ìœ¼ë©´ DBì—ì„œ ì¡°íšŒ
        Product product = productRepository.findById(productId);

        // ìºì‹œì— ì¶”ê°€
        cache.put(productId, product);  // â† âŒ ì œê±° ì•ˆ í•¨!

        return product;
    }

    // ì œê±° ë©”ì„œë“œ ì—†ìŒ! (ì¹˜ëª…ì )
}

// í•˜ë£¨ ë™ì•ˆ ì¼ì–´ë‚˜ëŠ” ì¼:
// - ìƒˆ ìƒí’ˆ ë“±ë¡: í•˜ë£¨ 5ë§Œ ê°œ
// - ìƒí’ˆ ìˆ˜ì •: í•˜ë£¨ 10ë§Œ ê±´ (ìƒˆ ê°ì²´ë¡œ êµì²´)
// - ìƒí’ˆ ì‚­ì œ: í•˜ë£¨ 1ë§Œ ê°œ (í•˜ì§€ë§Œ cacheì—ëŠ” ë‚¨ìŒ!)
// - ì´ ì‹ ê·œ ê°ì²´: 16ë§Œ ê°œ/ì¼

// 30ì¼ í›„:
// - cache í¬ê¸°: 480ë§Œ ê°œ (16ë§Œ Ã— 30)
// - ë©”ëª¨ë¦¬: 7.5GB
// â†’ ê³„ì† ì¦ê°€!

// ë” í° ë¬¸ì œ:
// - ì‚­ì œëœ ìƒí’ˆë„ cacheì— ë‚¨ì•„ìˆìŒ (ì“¸ëª¨ì—†ëŠ” ë°ì´í„°)
// - ìˆ˜ì •ëœ ìƒí’ˆì˜ êµ¬ë²„ì „ë„ ë‚¨ì•„ìˆìŒ (ì˜ëª»ëœ ë°ì´í„°)
// â†’ ë©”ëª¨ë¦¬ ë‚­ë¹„ + ë°ì´í„° ì •í•©ì„± ë¬¸ì œ!
```

**í•´ê²° ë°©ë²• 1: Caffeine ìºì‹œ (ê¶Œì¥)**:

```java
// âœ… Caffeine ìºì‹œ ì ìš©
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import com.github.benmanes.caffeine.cache.stats.CacheStats;
import java.util.concurrent.TimeUnit;

public class ProductCache {
    private static final Cache<String, Product> cache =
        Caffeine.newBuilder()
                // 1. í¬ê¸° ì œí•œ: ìµœëŒ€ 10ë§Œ ê°œ
                .maximumSize(100000)

                // 2. TTL: 1ì‹œê°„ í›„ ìë™ ì‚­ì œ
                .expireAfterWrite(1, TimeUnit.HOURS)

                // 3. Idle timeout: 30ë¶„ê°„ ë¯¸ì‚¬ìš© ì‹œ ì‚­ì œ
                .expireAfterAccess(30, TimeUnit.MINUTES)

                // 4. í†µê³„ ìˆ˜ì§‘ (ëª¨ë‹ˆí„°ë§ìš©)
                .recordStats()

                // 5. ì œê±° ë¦¬ìŠ¤ë„ˆ (ë¡œê¹…)
                .removalListener((key, value, cause) -> {
                    log.debug("Cache ì œê±°: key={}, cause={}", key, cause);
                })

                .build();

    public static Product getProduct(String productId) {
        return cache.get(productId, id -> {
            // ìºì‹œ ë¯¸ìŠ¤ ì‹œ DB ì¡°íšŒ
            return productRepository.findById(id);
        });
    }

    // í†µê³„ ì¡°íšŒ (ëª¨ë‹ˆí„°ë§)
    public static CacheStats getStats() {
        return cache.stats();
    }

    // ìˆ˜ë™ ì œê±° (ìƒí’ˆ ì‚­ì œ/ìˆ˜ì • ì‹œ)
    public static void invalidate(String productId) {
        cache.invalidate(productId);
    }
}

// ëª¨ë‹ˆí„°ë§ (JMX ë˜ëŠ” Health Check)
@RestController
public class CacheMonitorController {
    @GetMapping("/cache/stats")
    public Map<String, Object> getCacheStats() {
        CacheStats stats = ProductCache.getStats();

        Map<String, Object> result = new HashMap<>();
        result.put("hitRate", stats.hitRate());  // ìºì‹œ íˆíŠ¸ìœ¨
        result.put("hitCount", stats.hitCount());
        result.put("missCount", stats.missCount());
        result.put("evictionCount", stats.evictionCount());  // ì œê±°ëœ ê°œìˆ˜
        result.put("size", cache.estimatedSize());  // í˜„ì¬ í¬ê¸°

        return result;
        // {
        //   "hitRate": 0.85,  â† 85% íˆíŠ¸ìœ¨ (ì¢‹ìŒ!)
        //   "hitCount": 850000,
        //   "missCount": 150000,
        //   "evictionCount": 50000,  â† 5ë§Œ ê°œ ìë™ ì œê±°ë¨
        //   "size": 95000  â† í˜„ì¬ 9.5ë§Œ ê°œ (10ë§Œ ê°œ ì´í•˜ ìœ ì§€)
        // }
    }
}
```

**í•´ê²° ë°©ë²• 2: Redis ìºì‹œ (ëŒ€ìš©ëŸ‰)**:

```java
// âœ… Redis ìºì‹œ (ë¶„ì‚° ìºì‹œ)
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import java.time.Duration;

@Service
public class ProductCache {
    @Autowired
    private RedisTemplate<String, Product> redisTemplate;

    @Autowired
    private ProductRepository productRepository;

    private static final Duration TTL = Duration.ofHours(1);  // 1ì‹œê°„ TTL

    public Product getProduct(String productId) {
        String cacheKey = "product:" + productId;

        // 1. Redisì—ì„œ ì¡°íšŒ
        Product cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }

        // 2. Cache Miss â†’ DB ì¡°íšŒ
        Product product = productRepository.findById(productId);

        // 3. Redisì— ì €ì¥ (TTL ì„¤ì •)
        redisTemplate.opsForValue().set(cacheKey, product, TTL);

        return product;
    }

    // ìˆ˜ë™ ì œê±° (ìƒí’ˆ ì‚­ì œ/ìˆ˜ì • ì‹œ)
    public void invalidate(String productId) {
        String cacheKey = "product:" + productId;
        redisTemplate.delete(cacheKey);
    }
}

// ì¥ì :
// 1. JVM Heap ì••ë ¥ ì—†ìŒ (Redisê°€ ë³„ë„ ë©”ëª¨ë¦¬ ì‚¬ìš©)
// 2. ì„œë²„ 100ëŒ€ê°€ ë™ì¼í•œ ìºì‹œ ê³µìœ  (ì •í•©ì„± ë³´ì¥)
// 3. TTL ìë™ ë§Œë£Œ (Redisê°€ ìë™ ì‚­ì œ)
// 4. ì„œë²„ ì¬ì‹œì‘í•´ë„ ìºì‹œ ìœ ì§€
// 5. Redis Clusterë¡œ í™•ì¥ ê°€ëŠ¥

// ë‹¨ì :
// 1. ë„¤íŠ¸ì›Œí¬ ë¹„ìš© (1-2ms ì¶”ê°€ ì§€ì—°)
// 2. Redis ì„œë²„ ê´€ë¦¬ í•„ìš”
// 3. ì§ë ¬í™”/ì—­ì§ë ¬í™” ë¹„ìš©
```

**ê²°ê³¼**:

```bash
# Before (HashMap ìºì‹œ):
- Heap ì‚¬ìš©ëŸ‰ (18:00): 28GB (ê±°ì˜ ê°€ë“)
- cache í¬ê¸°: 500ë§Œ ê°œ
- GC pause (18:00): 123ms (Major GC)
- ì‘ë‹µ ì‹œê°„ (18:00): 300ms
- OOM ë°œìƒ: ë§¤ì¼ 02:00
- ìš´ì˜íŒ€ ì•¼ê·¼: ë§¤ì¼
- ì„œë²„ ì¬ì‹œì‘: í•˜ë£¨ 1íšŒ (í•„ìˆ˜)

# After (Caffeine ìºì‹œ):
- Heap ì‚¬ìš©ëŸ‰ (18:00): 5GB (ì•ˆì •ì !)
- cache í¬ê¸°: 10ë§Œ ê°œ ì´í•˜ ìœ ì§€
- GC pause (18:00): 12ms (Minor GCë§Œ)
- ì‘ë‹µ ì‹œê°„ (18:00): 60ms (5ë°° ê°œì„ !)
- OOM ë°œìƒ: 0íšŒ (3ê°œì›”ê°„)
- ìš´ì˜íŒ€ ì•¼ê·¼: ì—†ìŒ
- ì„œë²„ ì¬ì‹œì‘: ë¶ˆí•„ìš”

# ë¹„ìš© íš¨ê³¼:
- Heap í¬ê¸° ê°ì†Œ: 32GB â†’ 8GB (ì„œë²„ë‹¹ ë©”ëª¨ë¦¬ ì ˆì•½)
- ì„œë²„ ëŒ€ìˆ˜ ìœ ì§€: 100ëŒ€ (ì¦ì„¤ ë¶ˆí•„ìš”)
- ì‘ë‹µ ì‹œê°„ ê°œì„ : ì‚¬ìš©ì ë§Œì¡±ë„ ìƒìŠ¹
- ìš´ì˜ ì•ˆì •ì„±: ì•¼ê°„ ì¥ì•  0ê±´
- ì¸ê±´ë¹„ ì ˆê°: ìš´ì˜íŒ€ ì•¼ê·¼ ì—†ìŒ (ì›” 1000ë§Œ ì›+ ì ˆê°)

# ì¶”ê°€ ìµœì í™”:
// ìƒí’ˆ ìˆ˜ì •/ì‚­ì œ ì‹œ ìºì‹œ ë¬´íš¨í™”
@Service
public class ProductService {
    @Autowired
    private ProductCache cache;

    public void updateProduct(String productId, Product updated) {
        // 1. DB ì—…ë°ì´íŠ¸
        productRepository.save(updated);

        // 2. ìºì‹œ ë¬´íš¨í™” (ì¤‘ìš”!)
        cache.invalidate(productId);
        // â†’ ë‹¤ìŒ ì¡°íšŒ ì‹œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜´
    }

    public void deleteProduct(String productId) {
        // 1. DB ì‚­ì œ
        productRepository.deleteById(productId);

        // 2. ìºì‹œ ë¬´íš¨í™”
        cache.invalidate(productId);
        // â†’ ì‚­ì œëœ ìƒí’ˆì´ ìºì‹œì— ë‚¨ì§€ ì•ŠìŒ
    }
}
```

---

### ì‚¬ë¡€ 2: í† ìŠ¤ ê²°ì œ API ì„œë²„ - Finalizer ì œê±°ë¡œ GC ì„±ëŠ¥ ê°œì„ 

```bash
# ë¬¸ì œ ìƒí™© (2020ë…„)
- ì„œë¹„ìŠ¤: í† ìŠ¤ ê²°ì œ ìŠ¹ì¸ API
- QPS (ì´ˆë‹¹ ìš”ì²­): 5ë§Œ ê±´
- ì„œë²„: 200ëŒ€ (ê° 16GB Heap)
- GC: G1 GC ì‚¬ìš©
- ë¬¸ì œ: Minor GC pauseê°€ 50-100ms (ëª©í‘œ: <10ms)
  â†’ 99 percentile ì‘ë‹µ ì‹œê°„: 200ms (ëª©í‘œ: <50ms)
  â†’ ì‚¬ìš©ì ë¶ˆë§Œ: "ê²°ì œê°€ ëŠë ¤ìš”!"

# GC ë¡œê·¸ ë¶„ì„
[GC pause (G1 Evacuation Pause) (young) 1024M->256M 87ms]
                                                      â†‘ 87ms (ë„ˆë¬´ ê¹€!)

[GC pause (G1 Evacuation Pause) (young) 1024M->256M 92ms]
                                                      â†‘ 92ms

[GC pause (G1 Evacuation Pause) (young) 1024M->256M 105ms]
                                                      â†‘ 105ms (ëª©í‘œ 10msì˜ 10ë°°!)

# í‰ê·  Minor GC pause: 85ms
# ëª©í‘œ: <10ms
# â†’ 8.5ë°° ëŠë¦¼!

# ì™œ ì´ë ‡ê²Œ ëŠë¦´ê¹Œ?
# â†’ Finalizerê°€ ì›ì¸!

# Finalizer Queue í™•ì¸:
jcmd <pid> GC.finalizer_info

# ì¶œë ¥:
Number of objects pending for finalization: 250000
â†‘ 25ë§Œ ê°œ ê°ì²´ê°€ finalize() ëŒ€ê¸° ì¤‘!
â†‘ ëª¨ë‘ Old Generationì— ìŒ“ì—¬ìˆìŒ!
```

**ì›ì¸ ì½”ë“œ**:

```java
// âŒ ë¬¸ì œ ì½”ë“œ
public class PaymentConnection {
    private HttpURLConnection connection;

    public PaymentConnection(String url) throws IOException {
        this.connection = (HttpURLConnection) new URL(url).openConnection();
    }

    // "HTTP ì—°ê²°ì„ ìë™ìœ¼ë¡œ ë‹«ì•„ì£¼ë©´ ì¢‹ê² ë‹¤!"
    @Override
    protected void finalize() throws Throwable {
        try {
            if (connection != null) {
                connection.disconnect();  // â† âŒ Finalizer ì‚¬ìš©!
            }
        } finally {
            super.finalize();
        }
    }
}

// ì‚¬ìš©:
// QPS 5ë§Œ ê±´ â†’ ì´ˆë‹¹ 5ë§Œ ê°œ PaymentConnection ìƒì„±
// â†’ Finalizer Queueì— ìŒ“ì„
// â†’ GCê°€ ëŠë ¤ì§!

// í•˜ë£¨ ë™ì•ˆ:
// 5ë§Œ ê±´/ì´ˆ Ã— 86400ì´ˆ = 43.2ì–µ ê°œ!
// Finalizer Threadê°€ ì²˜ë¦¬ ëª»í•¨
// â†’ 25ë§Œ ê°œê°€ Old Generationì— ìŒ“ì—¬ìˆìŒ
```

**í•´ê²° ë°©ë²•**:

```java
// âœ… try-with-resourcesë¡œ ë³€ê²½
public class PaymentConnection implements AutoCloseable {
    private HttpURLConnection connection;

    public PaymentConnection(String url) throws IOException {
        this.connection = (HttpURLConnection) new URL(url).openConnection();
        this.connection.setConnectTimeout(3000);
        this.connection.setReadTimeout(5000);
    }

    @Override
    public void close() {  // AutoCloseable
        if (connection != null) {
            connection.disconnect();  // ì¦‰ì‹œ ë‹«í˜!
        }
    }

    // finalize() ì œê±°!
}

// ì‚¬ìš©:
public String processPayment(String url, String payload) throws IOException {
    try (PaymentConnection conn = new PaymentConnection(url)) {
        // HTTP ìš”ì²­ ì²˜ë¦¬
        return sendRequest(conn);
    }  // â† ë¸”ë¡ ëë‚˜ë©´ ì¦‰ì‹œ close()!
       // Finalizer ëŒ€ê¸° ì—†ìŒ!
}
```

**ê²°ê³¼**:

```bash
# Before (Finalizer ì‚¬ìš©):
- Minor GC pause: í‰ê·  85ms
- 99 percentile ì‘ë‹µ ì‹œê°„: 200ms
- Finalizer Queue: 25ë§Œ ê°œ ìŒ“ì„
- Old Generation ì‚¬ìš©ë¥ : 85%
- QPS: 5ë§Œ ê±´ (í•œê³„)

# After (AutoCloseable ì‚¬ìš©):
- Minor GC pause: í‰ê·  8ms (10.6ë°° ê°œì„ ! âš¡)
- 99 percentile ì‘ë‹µ ì‹œê°„: 45ms (4.4ë°° ê°œì„ !)
- Finalizer Queue: 0ê°œ
- Old Generation ì‚¬ìš©ë¥ : 45% (ì•ˆì •ì !)
- QPS: 8ë§Œ ê±´ (1.6ë°° ì¦ê°€!)

# ë¹„ìš© íš¨ê³¼:
- ì„œë²„ ëŒ€ìˆ˜ ìœ ì§€: 200ëŒ€ (ì¦ì„¤ ë¶ˆí•„ìš”)
- ì‘ë‹µ ì‹œê°„ ê°œì„ : ì‚¬ìš©ì ë§Œì¡±ë„ ìƒìŠ¹
- ì²˜ë¦¬ ìš©ëŸ‰ ì¦ê°€: ì‹œê°„ë‹¹ 300ë§Œ ê±´ â†’ 480ë§Œ ê±´
- ì¸í”„ë¼ ë¹„ìš© ì ˆê°: ì„œë²„ ì¦ì„¤ ì•ˆ í•´ë„ ë¨ (ì—° 10ì–µ ì›+ ì ˆê°)
```

---

### ì‚¬ë¡€ 3: ë¼ì¸ ë©”ì‹ ì € - ê°ì²´ í’€ë§ìœ¼ë¡œ Minor GC ë¹ˆë„ ê°ì†Œ

```bash
# ë¬¸ì œ ìƒí™© (2022ë…„)
- ì„œë¹„ìŠ¤: ë¼ì¸ ë©”ì‹ ì € ë©”ì‹œì§€ ì „ì†¡ ì„œë²„
- QPS: 10ë§Œ ê±´ (ì´ˆë‹¹ ë©”ì‹œì§€ 10ë§Œ ê°œ)
- ì„œë²„: 500ëŒ€ (ê° 8GB Heap)
- GC: G1 GC ì‚¬ìš©
- ë¬¸ì œ: Minor GCê°€ 2ì´ˆë§ˆë‹¤ ë°œìƒ (ë„ˆë¬´ ìì£¼!)
  â†’ Edenì´ 2ì´ˆë§ˆë‹¤ ê°€ë“ ì°¸
  â†’ 1ì‹œê°„ì— 1800íšŒ Minor GC!
  â†’ ì´ GC ì‹œê°„: 1ì‹œê°„ë‹¹ 9ì´ˆ (0.25% ë‚­ë¹„)

# GC ë¡œê·¸ ë¶„ì„ (1ë¶„ê°„)
[GC pause (young) 512M->128M 5ms]  # 0ì´ˆ
[GC pause (young) 512M->128M 5ms]  # 2ì´ˆ
[GC pause (young) 512M->128M 5ms]  # 4ì´ˆ
[GC pause (young) 512M->128M 5ms]  # 6ì´ˆ
...
# 30íšŒ Minor GC (1ë¶„ì— 30íšŒ!)

# Eden í¬ê¸°: 512MB
# 2ì´ˆë§ˆë‹¤ ê°€ë“ ì°¸ â†’ ì´ˆë‹¹ 256MB í• ë‹¹
# â†’ ë„ˆë¬´ ë§ì€ ê°ì²´ ìƒì„±!
```

**ì›ì¸ ë¶„ì„**:

```java
// âŒ ë¬¸ì œ ì½”ë“œ
public class MessageProcessor {
    public void sendMessage(String userId, String content) {
        // ë§¤ë²ˆ ìƒˆ ê°ì²´ ìƒì„±!
        Message msg = new Message();  // â† 100 bytes
        msg.setUserId(userId);
        msg.setContent(content);
        msg.setTimestamp(System.currentTimeMillis());

        // ì§ë ¬í™”
        byte[] serialized = serialize(msg);  // â† 150 bytes

        // ì „ì†¡
        send(serialized);

        // msgì™€ serializedëŠ” ë©”ì„œë“œ ëë‚˜ë©´ ì“°ë ˆê¸°
    }
}

// QPS 10ë§Œ ê±´:
// - Message ê°ì²´: 100 bytes Ã— 100,000 = 10MB/ì´ˆ
// - byte[] ë°°ì—´: 150 bytes Ã— 100,000 = 15MB/ì´ˆ
// - ì´: 25MB/ì´ˆ = 150MB/ë¶„ = 9GB/ì‹œê°„!
// Eden í¬ê¸°: 512MB
// â†’ 512MB / 25MB/s = 20.48ì´ˆë§ˆë‹¤ ê°€ë“ ì°¸
// (ì‹¤ì œë¡œëŠ” ë‹¤ë¥¸ ê°ì²´ë“¤ë„ ìˆì–´ì„œ 2ì´ˆë§ˆë‹¤)

// í•˜ë£¨ ë™ì•ˆ:
// 25MB/ì´ˆ Ã— 86400ì´ˆ = 2.16TB ê°ì²´ ìƒì„±!
// â†’ Eden ì••ë ¥ì´ ì—„ì²­ë‚¨!
```

**í•´ê²° ë°©ë²•: ê°ì²´ í’€ë§**:

```java
// âœ… ê°ì²´ í’€ êµ¬í˜„
import org.apache.commons.pool2.BasePooledObjectFactory;
import org.apache.commons.pool2.PooledObject;
import org.apache.commons.pool2.impl.DefaultPooledObject;
import org.apache.commons.pool2.impl.GenericObjectPool;

// Message ê°ì²´ í’€
public class MessagePool {
    private static class MessageFactory extends BasePooledObjectFactory<Message> {
        @Override
        public Message create() {
            return new Message();
        }

        @Override
        public PooledObject<Message> wrap(Message msg) {
            return new DefaultPooledObject<>(msg);
        }

        @Override
        public void passivateObject(PooledObject<Message> p) {
            // í’€ë¡œ ë°˜í™˜ ì „ ì´ˆê¸°í™”
            p.getObject().clear();
        }
    }

    private static final GenericObjectPool<Message> pool;

    static {
        pool = new GenericObjectPool<>(new MessageFactory());
        pool.setMaxTotal(10000);  // ìµœëŒ€ 1ë§Œ ê°œ
        pool.setMaxIdle(5000);     // ìœ íœ´ ìµœëŒ€ 5ì²œ ê°œ
        pool.setMinIdle(1000);     // ìœ íœ´ ìµœì†Œ 1ì²œ ê°œ
    }

    public static Message borrow() throws Exception {
        return pool.borrowObject();
    }

    public static void returnObject(Message msg) {
        pool.returnObject(msg);
    }
}

// ì‚¬ìš©:
public class MessageProcessor {
    public void sendMessage(String userId, String content) {
        Message msg = null;
        try {
            // í’€ì—ì„œ ë¹Œë¦¼
            msg = MessagePool.borrow();

            // ì¬ì‚¬ìš©!
            msg.setUserId(userId);
            msg.setContent(content);
            msg.setTimestamp(System.currentTimeMillis());

            // ì§ë ¬í™” (byte[] ë°°ì—´ë„ í’€ë§ ê°€ëŠ¥)
            byte[] serialized = serialize(msg);

            // ì „ì†¡
            send(serialized);

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // í’€ë¡œ ë°˜í™˜ (ì¤‘ìš”!)
            if (msg != null) {
                MessagePool.returnObject(msg);
            }
        }
    }
}

// í’€ë§ íš¨ê³¼:
// - ì´ˆê¸° 1ë§Œ ê°œ Message ìƒì„± (1MB)
// - ì´í›„ ì¬ì‚¬ìš©ë§Œ (ìƒˆ ê°ì²´ ìƒì„± ì—†ìŒ!)
// - ë©”ëª¨ë¦¬ í• ë‹¹: 1MB (ì´ˆê¸°) vs 2.16TB (í•˜ë£¨)
// â†’ 2ë°±ë§Œ ë°° ê°ì†Œ! âš¡
```

**ThreadLocalì„ ì´ìš©í•œ ê°„ë‹¨í•œ í’€ë§**:

```java
// âœ… ThreadLocal í’€ë§ (ë” ê°„ë‹¨!)
public class MessageProcessor {
    // ìŠ¤ë ˆë“œë§ˆë‹¤ í•˜ë‚˜ì”© Message ê°ì²´ ì†Œìœ 
    private static final ThreadLocal<Message> messagePool =
        ThreadLocal.withInitial(Message::new);

    // ìŠ¤ë ˆë“œë§ˆë‹¤ í•˜ë‚˜ì”© ByteBuffer ì†Œìœ 
    private static final ThreadLocal<ByteBuffer> bufferPool =
        ThreadLocal.withInitial(() -> ByteBuffer.allocate(1024));

    public void sendMessage(String userId, String content) {
        // í’€ì—ì„œ ê°€ì ¸ì˜´ (ìŠ¤ë ˆë“œ ì „ìš©)
        Message msg = messagePool.get();
        msg.clear();  // ì´ˆê¸°í™”
        msg.setUserId(userId);
        msg.setContent(content);
        msg.setTimestamp(System.currentTimeMillis());

        // ByteBufferë„ ì¬ì‚¬ìš©
        ByteBuffer buffer = bufferPool.get();
        buffer.clear();

        // ì§ë ¬í™”
        serialize(msg, buffer);

        // ì „ì†¡
        send(buffer);

        // ThreadLocalì´ë¼ ëª…ì‹œì  ë°˜í™˜ ë¶ˆí•„ìš”
        // (ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ìœ ì§€)
    }
}

// ì¥ì :
// 1. Lock-free (ìŠ¤ë ˆë“œë§ˆë‹¤ ì „ìš© ê°ì²´)
// 2. êµ¬í˜„ ê°„ë‹¨
// 3. ì„±ëŠ¥ ìµœê³ 
// ë‹¨ì :
// 1. ìŠ¤ë ˆë“œ ê°œìˆ˜ë§Œí¼ ê°ì²´ ìƒì„± (ìŠ¤ë ˆë“œ í’€ í¬ê¸° Ã— ê°ì²´ í¬ê¸°)
// 2. ìŠ¤ë ˆë“œ ì¢…ë£Œ ì‹œ ëª…ì‹œì  ì •ë¦¬ í•„ìš” (remove())
```

**ê²°ê³¼**:

```bash
# Before (ê°ì²´ í’€ë§ ì—†ìŒ):
- Minor GC ë¹ˆë„: 2ì´ˆë§ˆë‹¤ (1ë¶„ì— 30íšŒ)
- GC ì‹œê°„: 5ms Ã— 30íšŒ = 150ms/ë¶„
- Eden í• ë‹¹ë¥ : 25MB/ì´ˆ
- í•˜ë£¨ ê°ì²´ ìƒì„±: 2.16TB
- Heap ì‚¬ìš©ëŸ‰ (í‰ê· ): 3GB

# After (ê°ì²´ í’€ë§):
- Minor GC ë¹ˆë„: 20ì´ˆë§ˆë‹¤ (1ë¶„ì— 3íšŒ, 10ë°° ê°ì†Œ! âš¡)
- GC ì‹œê°„: 5ms Ã— 3íšŒ = 15ms/ë¶„ (10ë°° ê°ì†Œ!)
- Eden í• ë‹¹ë¥ : 2.5MB/ì´ˆ (10ë°° ê°ì†Œ!)
- í•˜ë£¨ ê°ì²´ ìƒì„±: 216GB (10ë°° ê°ì†Œ!)
- Heap ì‚¬ìš©ëŸ‰ (í‰ê· ): 1.5GB (50% ê°ì†Œ!)

# ì¶”ê°€ íš¨ê³¼:
- CPU ì‚¬ìš©ë¥  ê°ì†Œ: 65% â†’ 55% (GC ì˜¤ë²„í—¤ë“œ ê°ì†Œ)
- ì‘ë‹µ ì‹œê°„ ê°œì„ : í‰ê·  15ms â†’ 12ms (20% ê°œì„ )
- ì²˜ë¦¬ ìš©ëŸ‰ ì¦ê°€: QPS 10ë§Œ â†’ 12ë§Œ (20% ì¦ê°€)
- ì„œë²„ ì¦ì„¤ ë¶ˆí•„ìš”: 500ëŒ€ ìœ ì§€ (ì—° 20ì–µ ì›+ ì ˆê°)

# ëª¨ë‹ˆí„°ë§:
// í’€ ìƒíƒœ í™•ì¸
@RestController
public class PoolMonitorController {
    @GetMapping("/pool/stats")
    public Map<String, Object> getPoolStats() {
        Map<String, Object> stats = new HashMap<>();
        stats.put("numActive", pool.getNumActive());  // ì‚¬ìš© ì¤‘
        stats.put("numIdle", pool.getNumIdle());      // ìœ íœ´
        stats.put("numWaiters", pool.getNumWaiters()); // ëŒ€ê¸° ì¤‘
        stats.put("meanBorrowWaitTime", pool.getMeanBorrowWaitTimeMillis());

        return stats;
        // {
        //   "numActive": 3000,  â† 3ì²œ ê°œ ì‚¬ìš© ì¤‘
        //   "numIdle": 2000,    â† 2ì²œ ê°œ ìœ íœ´
        //   "numWaiters": 0,    â† ëŒ€ê¸° ì—†ìŒ (ì¶©ë¶„í•¨!)
        //   "meanBorrowWaitTime": 0.1  â† 0.1ms (ë¹ ë¦„!)
        // }
    }
}
```

---

## ğŸ’¡ GC íŠœë‹ Best Practices

```bash
# 1. ëª¨ë‹ˆí„°ë§ ë¨¼ì € (ì¸¡ì • ì—†ì´ íŠœë‹ ì—†ìŒ!)
-Xlog:gc*:file=gc.log:time,uptime,level,tags
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/logs/heapdump.hprof

# 2. ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì‹œì‘ (G1 GC ê¶Œì¥)
-Xms4g -Xmx4g  # ì´ˆê¸° = ìµœëŒ€ (ë™ì  ì¡°ì • ë°©ì§€)
-XX:+UseG1GC

# 3. ëª©í‘œ ì„¤ì • (pause time)
-XX:MaxGCPauseMillis=100  # ì›¹ ì„œë²„: 100ms
# ë˜ëŠ”
-XX:MaxGCPauseMillis=10   # ì‹¤ì‹œê°„ ì„œë¹„ìŠ¤: 10ms

# 4. Young Generation ì¡°ì • (í•„ìš”ì‹œ)
-XX:G1NewSizePercent=20  # Young Gen ìµœì†Œ 20%
-XX:G1MaxNewSizePercent=40  # Young Gen ìµœëŒ€ 40%

# 5. ë™ì‹œ GC ìŠ¤ë ˆë“œ ì¡°ì •
-XX:ConcGCThreads=4  # Concurrent GC ìŠ¤ë ˆë“œ
-XX:ParallelGCThreads=8  # Parallel GC ìŠ¤ë ˆë“œ

# 6. ë„êµ¬ í™œìš©
- jstat: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
- jmap: Heap dump ìƒì„±
- MAT: Heap dump ë¶„ì„
- VisualVM: GUI ëª¨ë‹ˆí„°ë§
- GC Easy: ë¡œê·¸ ë¶„ì„ (https://gceasy.io)
```

**GC íŠœë‹ ì²´í¬ë¦¬ìŠ¤íŠ¸**:

```bash
# âœ… 1. í˜„ì¬ ìƒíƒœ íŒŒì•…
jstat -gc <pid> 1000  # GC í†µê³„
jstat -gcutil <pid> 1000  # ë°±ë¶„ìœ¨
jmap -heap <pid>  # Heap ìš”ì•½

# âœ… 2. ëª©í‘œ ì„¤ì •
- Throughput > 95% (GC ì‹œê°„ < 5%)
- Minor GC pause < 50ms
- Major GC pause < 200ms
- Full GC ë¹ˆë„ < í•˜ë£¨ 1íšŒ

# âœ… 3. ë¬¸ì œ ì§„ë‹¨
- Full GC ìì£¼ ë°œìƒ â†’ Heap ì¦ê°€ ë˜ëŠ” ë©”ëª¨ë¦¬ ëˆ„ìˆ˜
- Minor GC ìì£¼ ë°œìƒ â†’ Young Gen ì¦ê°€ ë˜ëŠ” ê°ì²´ ìƒì„± ì¤„ì´ê¸°
- pause time ê¸¸ìŒ â†’ GC ì•Œê³ ë¦¬ì¦˜ ë³€ê²½ (G1, ZGC)

# âœ… 4. ì½”ë“œ ìµœì í™” (ìš°ì„ !)
- ê°ì²´ ì¬ì‚¬ìš© (í’€ë§)
- ë¶ˆí•„ìš”í•œ ê°ì²´ ìƒì„± ì œê±°
- Static ì»¬ë ‰ì…˜ í¬ê¸° ì œí•œ
- finalize() ì œê±°

# âœ… 5. JVM íŠœë‹ (ì½”ë“œ ìµœì í™” í›„)
- Heap í¬ê¸° ì¡°ì •
- GC ì•Œê³ ë¦¬ì¦˜ ì„ íƒ
- GC ì˜µì…˜ ì¡°ì •

# âœ… 6. ì§€ì†ì  ëª¨ë‹ˆí„°ë§
- Prometheus + Grafana
- ì•ŒëŒ ì„¤ì • (Full GC, OOM, pause time)
- ì£¼ê¸°ì  GC ë¡œê·¸ ë¶„ì„
```

**ë‹¤ìŒ Part 3**: ë©´ì ‘ ì§ˆë¬¸ (ì£¼ë‹ˆì–´ 7ê°œ + ì¤‘ê¸‰ 5ê°œ)
