# ì„¹ì…˜ 29: í”„ë¡œë•ì…˜ ë°°í¬ ì „ëžµ

## ë¹„ìœ ë¡œ ì‹œìž‘í•˜ê¸°

ë°°í¬ ì „ëžµì€ **ë¹„í–‰ê¸° êµì²´**ì™€ ê°™ìŠµë‹ˆë‹¤.

```
í•­ê³µì‚¬ì˜ ë¹„í–‰ê¸° êµì²´                 í”„ë¡œë•ì…˜ ë°°í¬
====================                 =============
âœˆï¸ ì‹ í˜• ë¹„í–‰ê¸° ë„ìž…              â†’   ìƒˆ ë²„ì „ ë°°í¬
ðŸ‘¥ ìŠ¹ê° ì´ë™ ê³„íš                â†’   íŠ¸ëž˜í”½ ì „í™˜ ì „ëžµ
ðŸ”§ ì ì§„ì  êµì²´                   â†’   Rolling/Canary ë°°í¬
âœˆï¸âœˆï¸ ë‘ ëŒ€ ë™ì‹œ ìš´ì˜            â†’   Blue-Green ë°°í¬
ðŸš¨ ë¬¸ì œ ì‹œ ì¦‰ì‹œ ë³µê·€            â†’   ë¡¤ë°± ì „ëžµ
ðŸ“Š ìŠ¹ê° í”¼ë“œë°± ìˆ˜ì§‘              â†’   ëª¨ë‹ˆí„°ë§ & ì•Œë¦¼
```

ë¹„í–‰ê¸°ë¥¼ í•œ ë²ˆì— ëª¨ë‘ êµì²´í•˜ë©´ ìœ„í—˜í•˜ë“¯ì´, ì„œë¹„ìŠ¤ë¥¼ í•œ ë²ˆì— ëª¨ë‘ ì—…ë°ì´íŠ¸í•˜ë©´ ìž¥ì•  ë°œìƒ ì‹œ í° í”¼í•´ë¥¼ ìž…ìŠµë‹ˆë‹¤.

---

## ì™œ ë°°í¬ ì „ëžµì´ ì¤‘ìš”í•œê°€?

### 1. ë°°í¬ ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤

```
âŒ ë¬´ê³„íš ë°°í¬ (All at Once)
===========================

15:00 - ìƒˆ ë²„ì „ ë°°í¬ ì‹œìž‘
15:01 - ëª¨ë“  ì„œë²„ë¥¼ ë™ì‹œì— ìƒˆ ë²„ì „ìœ¼ë¡œ êµì²´
15:02 - ì¹˜ëª…ì ì¸ ë²„ê·¸ ë°œê²¬!
15:03 - ëª¨ë“  ì‚¬ìš©ìžê°€ ì„œë¹„ìŠ¤ ì´ìš© ë¶ˆê°€
15:04 - ê¸´ê¸‰ ë¡¤ë°± ì‹œë„
15:10 - ë¡¤ë°± ì™„ë£Œ, 6ë¶„ê°„ ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ë‹¨
ê²°ê³¼: ë§¤ì¶œ ì†ì‹¤, ê³ ê° ì´íƒˆ, ë¸Œëžœë“œ ì´ë¯¸ì§€ ì†ìƒ ðŸ’€


âœ… Canary ë°°í¬ (ì ì§„ì )
=======================

15:00 - ìƒˆ ë²„ì „ ë°°í¬ ì‹œìž‘
15:01 - 5%ì˜ íŠ¸ëž˜í”½ë§Œ ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜
15:02 - 5% ì‚¬ìš©ìž ëª¨ë‹ˆí„°ë§ â†’ ë²„ê·¸ ë°œê²¬!
15:03 - ì¦‰ì‹œ ìƒˆ ë²„ì „ ì¤‘ë‹¨
15:04 - 95%ì˜ ì‚¬ìš©ìžëŠ” ì˜í–¥ ì—†ìŒ
ê²°ê³¼: 5%ë§Œ ìž ê¹ ì˜í–¥, ë¹ ë¥¸ ëŒ€ì‘, í”¼í•´ ìµœì†Œí™” âœ¨
```

### 2. ë‹¤ìš´íƒ€ìž„ì˜ ë¹„ìš©

```
ë‹¤ìš´íƒ€ìž„ ë¹„ìš© ê³„ì‚°
=================

ê°€ì •:
- ì¼ í‰ê·  ê±°ëž˜ì•¡: $1,000,000
- 1ì‹œê°„ ë‹¤ìš´íƒ€ìž„ ë¹„ìš©: $1,000,000 / 24 = $41,667
- 1ë¶„ ë‹¤ìš´íƒ€ìž„ ë¹„ìš©: $694

ì‹œë‚˜ë¦¬ì˜¤ë³„ ë¹„ìš©:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°°í¬ ì „ëžµ           â”‚ ë‹¤ìš´íƒ€ìž„     â”‚ ë¹„ìš©        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ All at Once         â”‚ 5ë¶„          â”‚ $3,470      â”‚
â”‚ Rolling Update      â”‚ 0ë¶„ (ë¬´ì¤‘ë‹¨) â”‚ $0          â”‚
â”‚ Blue-Green          â”‚ 30ì´ˆ (ì „í™˜)  â”‚ $347        â”‚
â”‚ Canary (ë²„ê·¸ ë°œê²¬)  â”‚ 0ë¶„ (5%ë§Œ)   â”‚ ~$0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

+ ê³ ê° ì‹ ë¢°ë„ í•˜ë½
+ ë¸Œëžœë“œ ì´ë¯¸ì§€ ì†ìƒ
+ ê²½ìŸì‚¬ë¡œ ì´íƒˆ
```

---

## ë°°í¬ ì „ëžµì˜ ì¢…ë¥˜

### 1. ì „ì²´ ë¹„êµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì „ëžµ             â”‚ ë‹¤ìš´íƒ€ìž„     â”‚ ë¡¤ë°± ì†ë„ â”‚ ë¦¬ì†ŒìŠ¤    â”‚ ë³µìž¡ë„       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recreate         â”‚ ìžˆìŒ (5ë¶„+)  â”‚ ëŠë¦¼      â”‚ 1ë°°       â”‚ ë‚®ìŒ         â”‚
â”‚ Rolling Update   â”‚ ì—†ìŒ         â”‚ ëŠë¦¼      â”‚ 1ë°°       â”‚ ì¤‘ê°„         â”‚
â”‚ Blue-Green       â”‚ ê±°ì˜ ì—†ìŒ    â”‚ ë§¤ìš° ë¹ ë¦„ â”‚ 2ë°°       â”‚ ì¤‘ê°„         â”‚
â”‚ Canary           â”‚ ì—†ìŒ         â”‚ ë¹ ë¦„      â”‚ 1.1ë°°     â”‚ ë†’ìŒ         â”‚
â”‚ A/B Testing      â”‚ ì—†ìŒ         â”‚ ë¹ ë¦„      â”‚ 1.2ë°°     â”‚ ë†’ìŒ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Recreate ë°°í¬

ê°€ìž¥ ê°„ë‹¨í•˜ì§€ë§Œ ë‹¤ìš´íƒ€ìž„ì´ ë°œìƒí•©ë‹ˆë‹¤.

### ë™ìž‘ ë°©ì‹

```
ì‹œê°„ íë¦„
=========

ê¸°ì¡´ ë²„ì „ (v1.0)
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚  â† 3ê°œì˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
   |       |       |
   â†“       â†“       â†“
  Stop    Stop    Stop    â† ëª¨ë‘ ì¤‘ì§€ (ë‹¤ìš´íƒ€ìž„ ì‹œìž‘!)
   X       X       X

   â³ ë‹¤ìš´íƒ€ìž„ (5-10ë¶„)

   â†“       â†“       â†“
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚  â† ìƒˆ ë²„ì „ ì‹œìž‘ (ë‹¤ìš´íƒ€ìž„ ì¢…ë£Œ)
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

### docker-compose ì˜ˆì‹œ

```yaml
# docker-compose.yml
version: '3.8'

services:
  user-service:
    image: lk-trade/user-service:${VERSION}
    deploy:
      replicas: 3
      # ê¸°ë³¸ ì „ëžµ (Recreate)
```

```bash
# ë°°í¬ ëª…ë ¹
export VERSION=2.0.0
docker-compose down
docker-compose pull
docker-compose up -d

# ë‹¤ìš´íƒ€ìž„: docker-compose downë¶€í„° up -d ì™„ë£Œê¹Œì§€
```

### ìž¥ë‹¨ì 

```
âœ… ìž¥ì :
- êµ¬í˜„ì´ ë§¤ìš° ê°„ë‹¨
- ë²„ì „ ì¶©ëŒ ì—†ìŒ (í•œ ë²ˆì— í•˜ë‚˜ì˜ ë²„ì „ë§Œ ì‹¤í–‰)
- ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì  (ì¶”ê°€ ì„œë²„ ë¶ˆí•„ìš”)

âŒ ë‹¨ì :
- ë‹¤ìš´íƒ€ìž„ ë°œìƒ (5-10ë¶„)
- ì‚¬ìš©ìž ê²½í—˜ ì €í•˜
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ëŠ” ë¶€ì í•©
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½
- ì‚¬ìš©ìžê°€ ì—†ëŠ” ì‹œê°„ëŒ€ (ìƒˆë²½)
- ìœ ì§€ë³´ìˆ˜ ì°½êµ¬ (maintenance window) í™œìš©

---

## 2. Rolling Update (ìˆœì°¨ ë°°í¬)

ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ì ì§„ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

### ë™ìž‘ ë°©ì‹

```
ì‹œê°„ íë¦„
=========

ì´ˆê¸° ìƒíƒœ (v1.0)
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚  (4ê°œ ì¸ìŠ¤í„´ìŠ¤)
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
   â†“
1ë‹¨ê³„: í•˜ë‚˜ì”© êµì²´
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚  â† 1ê°œ ì—…ë°ì´íŠ¸
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
   â†“
2ë‹¨ê³„
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚  â† 2ê°œ ì—…ë°ì´íŠ¸
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
   â†“
3ë‹¨ê³„
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v1  â”‚  â† 3ê°œ ì—…ë°ì´íŠ¸
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
   â†“
ì™„ë£Œ
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚  â† ëª¨ë‘ ì—…ë°ì´íŠ¸
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

âœ… ì „ì²´ ê³¼ì •ì—ì„œ ë‹¤ìš´íƒ€ìž„ ì—†ìŒ!
```

### Docker Swarmìœ¼ë¡œ Rolling Update

```bash
# Swarm ì´ˆê¸°í™”
docker swarm init

# Stack ë°°í¬
docker stack deploy -c docker-stack.yml lk-trade
```

```yaml
# docker-stack.yml
version: '3.8'

services:
  user-service:
    image: lk-trade/user-service:${VERSION:-latest}
    deploy:
      replicas: 4
      update_config:
        parallelism: 1        # í•œ ë²ˆì— 1ê°œì”© ì—…ë°ì´íŠ¸
        delay: 10s            # ê° ì—…ë°ì´íŠ¸ ì‚¬ì´ ëŒ€ê¸° ì‹œê°„
        failure_action: rollback  # ì‹¤íŒ¨ ì‹œ ìžë™ ë¡¤ë°±
        monitor: 60s          # ëª¨ë‹ˆí„°ë§ ì‹œê°„
        max_failure_ratio: 0.25   # 25% ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
        order: stop-first     # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ í›„ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: pause
        monitor: 60s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - lk-trade-network

networks:
  lk-trade-network:
    driver: overlay
```

### ë°°í¬ ë° ëª¨ë‹ˆí„°ë§

```bash
# ìƒˆ ë²„ì „ ë°°í¬
export VERSION=2.0.0
docker stack deploy -c docker-stack.yml lk-trade

# ë°°í¬ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§
watch -n 1 'docker service ps lk-trade_user-service'

# ì¶œë ¥:
ID            NAME                         IMAGE                    NODE    DESIRED STATE  CURRENT STATE
abc123...     lk-trade_user-service.1      lk-trade/user-service:2.0.0  node1   Running        Running 30 seconds ago
def456...     lk-trade_user-service.2      lk-trade/user-service:2.0.0  node1   Running        Running 20 seconds ago
ghi789...     lk-trade_user-service.3      lk-trade/user-service:2.0.0  node1   Running        Running 10 seconds ago
jkl012...     lk-trade_user-service.4      lk-trade/user-service:1.0.0  node1   Shutdown       Shutdown 5 seconds ago

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
docker service ls
docker service logs -f lk-trade_user-service

# ë¡¤ë°± (ë¬¸ì œ ë°œìƒ ì‹œ)
docker service rollback lk-trade_user-service

# ë˜ëŠ” ì´ì „ ë²„ì „ìœ¼ë¡œ ìž¬ë°°í¬
export VERSION=1.0.0
docker stack deploy -c docker-stack.yml lk-trade
```

### ìž¥ë‹¨ì 

```
âœ… ìž¥ì :
- ë¬´ì¤‘ë‹¨ ë°°í¬ (Zero Downtime)
- ì ì§„ì  ì—…ë°ì´íŠ¸ë¡œ ìœ„í—˜ ë¶„ì‚°
- ìžë™ í—¬ìŠ¤ì²´í¬ ë° ë¡¤ë°±
- ì¶”ê°€ ë¦¬ì†ŒìŠ¤ ë¶ˆí•„ìš”

âŒ ë‹¨ì :
- ë°°í¬ ì‹œê°„ì´ ê¹€ (ì „ì²´ ì—…ë°ì´íŠ¸ê¹Œì§€)
- v1ê³¼ v2ê°€ ë™ì‹œì— ì‹¤í–‰ë¨ (í˜¸í™˜ì„± í•„ìš”)
- ë¡¤ë°±ì´ ëŠë¦¼ (ë‹¤ì‹œ rolling)
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ì¼ë°˜ì ì¸ í”„ë¡œë•ì…˜ ë°°í¬
- ë¦¬ì†ŒìŠ¤ê°€ ì œí•œì ì¸ í™˜ê²½
- ë²„ì „ ê°„ í˜¸í™˜ì„±ì´ ë³´ìž¥ë˜ëŠ” ê²½ìš°

---

## 3. Blue-Green ë°°í¬

ë‘ ê°œì˜ ë™ì¼í•œ í™˜ê²½ì„ ìš´ì˜í•˜ê³  ì¦‰ì‹œ ì „í™˜í•©ë‹ˆë‹¤.

### ë™ìž‘ ë°©ì‹

```
Blue (ê¸°ì¡´ í™˜ê²½, v1.0)          Green (ìƒˆ í™˜ê²½, v2.0)
=========================        =========================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Balancer         â”‚        â”‚                       â”‚
â”‚   â†“                   â”‚        â”‚                       â”‚
â”‚ Blue Environment      â”‚        â”‚ Green Environment     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚      â”‚        â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚        â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   â†‘                   â”‚        â”‚                       â”‚
â”‚ 100% íŠ¸ëž˜í”½           â”‚        â”‚ 0% íŠ¸ëž˜í”½             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            â†“ í…ŒìŠ¤íŠ¸ ì™„ë£Œ, ì „í™˜ ì¤€ë¹„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Balancer         â”‚        â”‚                       â”‚
â”‚       â†“               â”‚        â”‚                       â”‚
â”‚ Blue Environment      â”‚        â”‚ Green Environment     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚      â”‚        â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚        â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                       â”‚        â”‚   â†‘                   â”‚
â”‚ 0% íŠ¸ëž˜í”½             â”‚        â”‚ 100% íŠ¸ëž˜í”½           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            â†“ ë¬¸ì œ ì—†ìœ¼ë©´ Blue í™˜ê²½ ì¢…ë£Œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Green Environment     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   â†‘                   â”‚
â”‚ 100% íŠ¸ëž˜í”½           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            â†“ Greenì´ ì´ì œ Blueê°€ ë¨
```

### Nginxë¥¼ ì´ìš©í•œ Blue-Green ë°°í¬

```yaml
# docker-compose.blue-green.yml
version: '3.8'

services:
  # Nginx ë¡œë“œ ë°¸ëŸ°ì„œ
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/upstream.conf:/etc/nginx/conf.d/upstream.conf:ro
    networks:
      - lk-trade-network
    depends_on:
      - user-service-blue
      - user-service-green

  # Blue í™˜ê²½ (í˜„ìž¬ ìš´ì˜)
  user-service-blue:
    image: lk-trade/user-service:1.0.0
    container_name: user-service-blue
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DEPLOYMENT_COLOR=blue
    networks:
      - lk-trade-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Green í™˜ê²½ (ìƒˆ ë²„ì „)
  user-service-green:
    image: lk-trade/user-service:2.0.0
    container_name: user-service-green
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DEPLOYMENT_COLOR=green
    networks:
      - lk-trade-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  lk-trade-network:
    driver: bridge
```

```nginx
# nginx/upstream.conf (ì´ˆê¸° ìƒíƒœ: Blue)
upstream user_service {
    server user-service-blue:8080 max_fails=3 fail_timeout=30s;
    # server user-service-green:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;

    location / {
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # í—¬ìŠ¤ ì²´í¬ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ ì„¤ì •
        proxy_connect_timeout 2s;
        proxy_send_timeout 2s;
        proxy_read_timeout 2s;
    }

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### Blue-Green ì „í™˜ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/blue-green-deploy.sh

set -e

CURRENT_ENV=${1:-blue}
NEW_ENV=${2:-green}

if [ "$CURRENT_ENV" != "blue" ] && [ "$CURRENT_ENV" != "green" ]; then
    echo "âŒ Invalid environment. Use 'blue' or 'green'"
    exit 1
fi

if [ "$CURRENT_ENV" == "blue" ]; then
    NEW_ENV="green"
else
    NEW_ENV="blue"
fi

echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Blue-Green Deployment                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Current Environment: $CURRENT_ENV
New Environment:     $NEW_ENV
"

# 1. ìƒˆ í™˜ê²½ í—¬ìŠ¤ ì²´í¬
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  Health Check: $NEW_ENV environment"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

MAX_RETRIES=30
RETRY=0

while [ $RETRY -lt $MAX_RETRIES ]; do
    if docker exec user-service-$NEW_ENV wget -q --spider http://localhost:8080/actuator/health; then
        echo "âœ… $NEW_ENV environment is healthy"
        break
    fi
    RETRY=$((RETRY+1))
    echo "â³ Waiting for $NEW_ENV to be ready... ($RETRY/$MAX_RETRIES)"
    sleep 2
done

if [ $RETRY -eq $MAX_RETRIES ]; then
    echo "âŒ $NEW_ENV environment health check failed"
    exit 1
fi

# 2. ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  Smoke Tests"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
if ! docker exec user-service-$NEW_ENV wget -q -O- http://localhost:8080/actuator/info > /dev/null; then
    echo "âŒ Smoke test failed"
    exit 1
fi

echo "âœ… Smoke tests passed"

# 3. íŠ¸ëž˜í”½ ì „í™˜
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  Traffic Switch"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

read -p "Switch traffic to $NEW_ENV? (yes/no): " CONFIRM
if [ "$CONFIRM" != "yes" ]; then
    echo "Deployment cancelled"
    exit 0
fi

# Nginx ì„¤ì • ë³€ê²½
cat > nginx/upstream.conf <<EOF
upstream user_service {
    server user-service-$NEW_ENV:8080 max_fails=3 fail_timeout=30s;
    # server user-service-$CURRENT_ENV:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;

    location / {
        proxy_pass http://user_service;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;

        proxy_connect_timeout 2s;
        proxy_send_timeout 2s;
        proxy_read_timeout 2s;
    }
}
EOF

# Nginx ìž¬ì‹œìž‘
docker exec nginx nginx -s reload
echo "âœ… Traffic switched to $NEW_ENV"

# 4. ëª¨ë‹ˆí„°ë§
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  Monitoring (60 seconds)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Press Ctrl+C to stop monitoring and rollback"
echo ""

for i in {1..60}; do
    if ! docker exec user-service-$NEW_ENV wget -q --spider http://localhost:8080/actuator/health; then
        echo ""
        echo "âŒ Health check failed during monitoring!"
        echo "ðŸ”„ Rolling back to $CURRENT_ENV..."

        # ë¡¤ë°±
        cat > nginx/upstream.conf <<EOF
upstream user_service {
    server user-service-$CURRENT_ENV:8080 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    location / {
        proxy_pass http://user_service;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
    }
}
EOF
        docker exec nginx nginx -s reload
        echo "âœ… Rolled back to $CURRENT_ENV"
        exit 1
    fi
    echo -n "."
    sleep 1
done

echo ""
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  Cleanup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

read -p "Stop $CURRENT_ENV environment? (yes/no): " CLEANUP
if [ "$CLEANUP" == "yes" ]; then
    docker-compose stop user-service-$CURRENT_ENV
    echo "âœ… $CURRENT_ENV environment stopped"
else
    echo "âš ï¸  $CURRENT_ENV environment is still running"
    echo "   You can manually stop it later with:"
    echo "   docker-compose stop user-service-$CURRENT_ENV"
fi

echo ""
echo "âœ… Blue-Green deployment completed successfully!"
echo ""
echo "Current active environment: $NEW_ENV"
```

### ì‚¬ìš© ë°©ë²•

```bash
# 1. ì´ˆê¸° ìƒíƒœ: Blue ìš´ì˜ ì¤‘
docker-compose -f docker-compose.blue-green.yml up -d user-service-blue nginx

# 2. Green í™˜ê²½ì— ìƒˆ ë²„ì „ ë°°í¬
docker-compose -f docker-compose.blue-green.yml up -d user-service-green

# 3. Blue â†’ Green ì „í™˜
bash scripts/blue-green-deploy.sh blue

# 4. ë¬¸ì œ ë°œìƒ ì‹œ ì¦‰ì‹œ ë¡¤ë°± (Green â†’ Blue)
bash scripts/blue-green-rollback.sh green
```

### ìž¥ë‹¨ì 

```
âœ… ìž¥ì :
- ê±°ì˜ ì¦‰ì‹œ ì „í™˜ (1-2ì´ˆ)
- ë§¤ìš° ë¹ ë¥¸ ë¡¤ë°± (1-2ì´ˆ)
- í”„ë¡œë•ì…˜ê³¼ ë™ì¼í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- v1ê³¼ v2ê°€ ê²©ë¦¬ë¨

âŒ ë‹¨ì :
- ë¦¬ì†ŒìŠ¤ 2ë°° í•„ìš”
- ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë³µìž¡
- ì¸í”„ë¼ ë¹„ìš© ì¦ê°€
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ì¤‘ìš”í•œ í”„ë¡œë•ì…˜ ë°°í¬
- ë¹ ë¥¸ ë¡¤ë°±ì´ í•„ìˆ˜ì¸ ê²½ìš°
- ë¦¬ì†ŒìŠ¤ê°€ ì¶©ë¶„í•œ í™˜ê²½

---

## 4. Canary ë°°í¬

ì†Œìˆ˜ì˜ ì‚¬ìš©ìžì—ê²Œ ë¨¼ì € ë°°í¬í•˜ì—¬ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

### ë™ìž‘ ë°©ì‹

```
ì‹œê°„ íë¦„
=========

ì´ˆê¸°: 5% Canary
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Balancer                                 â”‚
â”‚                                               â”‚
â”‚  5% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”  Canary (v2.0)              â”‚
â”‚         â”‚ v2  â”‚                               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                               â”‚
â”‚ 95% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â†“ ëª¨ë‹ˆí„°ë§ (15ë¶„) â†’ ë¬¸ì œ ì—†ìŒ

25% Canary
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 25% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”  Canary (v2.0)       â”‚
â”‚         â”‚ v2  â”‚ â”‚ v2  â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                               â”‚
â”‚ 75% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚ v1  â”‚ â”‚ v1  â”‚ â”‚ v1  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â†“ ëª¨ë‹ˆí„°ë§ (15ë¶„) â†’ ë¬¸ì œ ì—†ìŒ

50% Canary
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 50% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                               â”‚
â”‚ 50% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                      â”‚
â”‚         â”‚ v1  â”‚ â”‚ v1  â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â†“ ëª¨ë‹ˆí„°ë§ (15ë¶„) â†’ ë¬¸ì œ ì—†ìŒ

100% ì „í™˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚100% â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚
â”‚         â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚ â”‚ v2  â”‚      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Traefikì„ ì´ìš©í•œ Canary ë°°í¬

```yaml
# docker-compose.canary.yml
version: '3.8'

services:
  # Traefik (ë¡œë“œ ë°¸ëŸ°ì„œ)
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"  # Traefik ëŒ€ì‹œë³´ë“œ
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - lk-trade-network

  # Stable ë²„ì „ (v1.0)
  user-service-stable:
    image: lk-trade/user-service:1.0.0
    deploy:
      replicas: 4
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.user-stable.rule=Host(`api.lk-trade.com`)"
        - "traefik.http.services.user-stable.loadbalancer.server.port=8080"
        - "traefik.http.services.user-stable.loadbalancer.sticky.cookie=true"
        # ê°€ì¤‘ì¹˜: 95%
        - "traefik.http.services.user-stable.loadbalancer.weight=95"
    networks:
      - lk-trade-network

  # Canary ë²„ì „ (v2.0)
  user-service-canary:
    image: lk-trade/user-service:2.0.0
    deploy:
      replicas: 1
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.user-canary.rule=Host(`api.lk-trade.com`)"
        - "traefik.http.services.user-canary.loadbalancer.server.port=8080"
        - "traefik.http.services.user-canary.loadbalancer.sticky.cookie=true"
        # ê°€ì¤‘ì¹˜: 5%
        - "traefik.http.services.user-canary.loadbalancer.weight=5"
    networks:
      - lk-trade-network

networks:
  lk-trade-network:
    driver: overlay
```

### Canary ë°°í¬ ìžë™í™” ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/canary-deploy.sh

set -e

NEW_VERSION=$1
CANARY_PERCENTAGES=(5 25 50 100)
MONITORING_DURATION=900  # 15ë¶„ (ì´ˆ)

if [ -z "$NEW_VERSION" ]; then
    echo "Usage: $0 <new-version>"
    echo "Example: $0 2.0.0"
    exit 1
fi

echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Canary Deployment                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

New Version: $NEW_VERSION
Canary Stages: ${CANARY_PERCENTAGES[@]}%
Monitoring Duration: $MONITORING_DURATION seconds per stage
"

# Prometheus ë©”íŠ¸ë¦­ ì²´í¬ í•¨ìˆ˜
check_metrics() {
    local version=$1

    # ì—ëŸ¬ìœ¨ ì²´í¬
    ERROR_RATE=$(curl -s "http://localhost:9090/api/v1/query?query=rate(http_requests_total{status=~\"5..\",version=\"$version\"}[5m])" | jq -r '.data.result[0].value[1] // 0')

    # ì‘ë‹µ ì‹œê°„ ì²´í¬
    AVG_RESPONSE_TIME=$(curl -s "http://localhost:9090/api/v1/query?query=histogram_quantile(0.95,http_request_duration_seconds{version=\"$version\"})" | jq -r '.data.result[0].value[1] // 0')

    echo "  Error Rate: $ERROR_RATE"
    echo "  P95 Response Time: ${AVG_RESPONSE_TIME}s"

    # ìž„ê³„ê°’ ì²´í¬
    if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
        echo "  âŒ Error rate too high (>1%)"
        return 1
    fi

    if (( $(echo "$AVG_RESPONSE_TIME > 1.0" | bc -l) )); then
        echo "  âŒ Response time too slow (>1s)"
        return 1
    fi

    return 0
}

# Canary ë‹¨ê³„ë³„ ë°°í¬
for PERCENTAGE in "${CANARY_PERCENTAGES[@]}"; do
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸš€ Deploying Canary: $PERCENTAGE%"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ê°€ì¤‘ì¹˜ ê³„ì‚°
    STABLE_WEIGHT=$((100 - PERCENTAGE))
    CANARY_WEIGHT=$PERCENTAGE

    # Docker Compose íŒŒì¼ ì—…ë°ì´íŠ¸
    cat > docker-compose.canary-weights.yml <<EOF
version: '3.8'

services:
  user-service-stable:
    image: lk-trade/user-service:1.0.0
    deploy:
      labels:
        - "traefik.http.services.user-stable.loadbalancer.weight=$STABLE_WEIGHT"

  user-service-canary:
    image: lk-trade/user-service:$NEW_VERSION
    deploy:
      labels:
        - "traefik.http.services.user-canary.loadbalancer.weight=$CANARY_WEIGHT"
EOF

    # ë°°í¬
    docker stack deploy -c docker-compose.canary.yml -c docker-compose.canary-weights.yml lk-trade

    echo "â³ Monitoring for $MONITORING_DURATION seconds..."

    # ëª¨ë‹ˆí„°ë§
    ELAPSED=0
    while [ $ELAPSED -lt $MONITORING_DURATION ]; do
        sleep 30
        ELAPSED=$((ELAPSED + 30))

        echo ""
        echo "[$ELAPSED/${MONITORING_DURATION}s] Checking metrics..."

        if ! check_metrics "$NEW_VERSION"; then
            echo ""
            echo "âŒ Canary deployment failed at $PERCENTAGE%"
            echo "ðŸ”„ Rolling back..."

            # ë¡¤ë°±
            docker stack deploy -c docker-compose.stable-only.yml lk-trade

            echo "âœ… Rolled back to stable version"
            exit 1
        fi

        echo "  âœ… Metrics OK"
    done

    echo ""
    echo "âœ… Canary $PERCENTAGE% successful"
    echo ""

    if [ $PERCENTAGE -ne 100 ]; then
        read -p "Continue to next stage? (yes/no): " CONTINUE
        if [ "$CONTINUE" != "yes" ]; then
            echo "Deployment paused at $PERCENTAGE%"
            exit 0
        fi
    fi
done

echo "
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Canary deployment completed successfully!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Version $NEW_VERSION is now serving 100% of traffic.
"
```

### ìž¥ë‹¨ì 

```
âœ… ìž¥ì :
- ìœ„í—˜ ìµœì†Œí™” (ì†Œìˆ˜ ì‚¬ìš©ìžë§Œ ì˜í–¥)
- ì‹¤ì œ ì‚¬ìš©ìž í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸
- ì ì§„ì  íŠ¸ëž˜í”½ ì¦ê°€
- ë¹ ë¥¸ ë¬¸ì œ ê°ì§€ ë° ë¡¤ë°±

âŒ ë‹¨ì :
- êµ¬í˜„ ë³µìž¡ë„ ë†’ìŒ
- ëª¨ë‹ˆí„°ë§ í•„ìˆ˜
- ë°°í¬ ì‹œê°„ ê¹€ (ë‹¨ê³„ë³„ ëª¨ë‹ˆí„°ë§)
- ì¸í”„ë¼ ë³µìž¡ì„± ì¦ê°€
```

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- ì¤‘ëŒ€í•œ ë³€ê²½ ì‚¬í•­
- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶œì‹œ
- ëŒ€ê·œëª¨ ì‚¬ìš©ìž ëŒ€ìƒ ì„œë¹„ìŠ¤

---

## 5. A/B Testing

ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­ ê¸°ë°˜ìœ¼ë¡œ ë‘ ë²„ì „ì„ ë¹„êµí•©ë‹ˆë‹¤.

### Canary vs A/B Testing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ Canary            â”‚ A/B Testing      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ëª©ì             â”‚ ì•ˆì •ì„± ê²€ì¦       â”‚ ë¹„ì¦ˆë‹ˆìŠ¤ ê²€ì¦    â”‚
â”‚ ì‚¬ìš©ìž ì„ íƒ     â”‚ ëžœë¤              â”‚ ì˜ë„ì  ê·¸ë£¹ ë¶„ë¦¬ â”‚
â”‚ ëª¨ë‹ˆí„°ë§ ì§€í‘œ   â”‚ ì—ëŸ¬ìœ¨, ì‘ë‹µì‹œê°„  â”‚ ì „í™˜ìœ¨, ë§¤ì¶œ     â”‚
â”‚ ê¸°ê°„            â”‚ ì§§ìŒ (ë¶„~ì‹œê°„)    â”‚ ê¸¸ìŒ (ì¼~ì£¼)     â”‚
â”‚ ìµœì¢… ê²°ì •       â”‚ ìžë™ (ë©”íŠ¸ë¦­)     â”‚ ìˆ˜ë™ (ë¹„ì¦ˆë‹ˆìŠ¤)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### êµ¬í˜„ ì˜ˆì‹œ

```yaml
# docker-compose.ab-testing.yml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - lk-trade-network

  # ë²„ì „ A (ê¸°ì¡´ UI)
  frontend-a:
    image: lk-trade/frontend:1.0.0-old-ui
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.frontend-a.rule=Host(`lk-trade.com`) && Header(`X-AB-Test`, `A`)"
        - "traefik.http.services.frontend-a.loadbalancer.server.port=80"
        - "traefik.http.middlewares.ab-test-a.headers.customrequestheaders.X-AB-Group=A"
    environment:
      - AB_TEST_GROUP=A
      - FEATURE_NEW_CHECKOUT=false
    networks:
      - lk-trade-network

  # ë²„ì „ B (ìƒˆ UI)
  frontend-b:
    image: lk-trade/frontend:2.0.0-new-ui
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.frontend-b.rule=Host(`lk-trade.com`) && Header(`X-AB-Test`, `B`)"
        - "traefik.http.services.frontend-b.loadbalancer.server.port=80"
        - "traefik.http.middlewares.ab-test-b.headers.customrequestheaders.X-AB-Group=B"
    environment:
      - AB_TEST_GROUP=B
      - FEATURE_NEW_CHECKOUT=true
    networks:
      - lk-trade-network

networks:
  lk-trade-network:
    driver: overlay
```

ì‚¬ìš©ìžë¥¼ ê·¸ë£¹ë³„ë¡œ ë¶„ë¦¬:

```javascript
// frontend/ab-test.js
function getABTestGroup() {
    // ì¿ í‚¤ì—ì„œ ê·¸ë£¹ í™•ì¸
    let group = getCookie('ab_test_group');

    if (!group) {
        // 50/50 ëžœë¤ ë°°ì •
        group = Math.random() < 0.5 ? 'A' : 'B';
        setCookie('ab_test_group', group, 30);  // 30ì¼
    }

    return group;
}

// API ìš”ì²­ ì‹œ í—¤ë” ì¶”ê°€
fetch('/api/orders', {
    headers: {
        'X-AB-Test': getABTestGroup()
    }
});

// ì´ë²¤íŠ¸ íŠ¸ëž˜í‚¹
function trackEvent(eventName, data) {
    analytics.track(eventName, {
        ...data,
        ab_test_group: getABTestGroup(),
        timestamp: new Date().toISOString()
    });
}

// ì˜ˆ: ì²´í¬ì•„ì›ƒ ì™„ë£Œ íŠ¸ëž˜í‚¹
trackEvent('checkout_completed', {
    order_id: orderId,
    amount: orderAmount
});
```

---

## 6. LK-Trade í”„ë¡œì íŠ¸ ë°°í¬ ì „ëžµ

### ê¶Œìž¥ ì „ëžµ

```
ì„œë¹„ìŠ¤ë³„ ë°°í¬ ì „ëžµ
=================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì„œë¹„ìŠ¤             â”‚ ë°°í¬ ì „ëžµ        â”‚ ì´ìœ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user-service       â”‚ Blue-Green       â”‚ ì¤‘ìš”ë„ ë†’ìŒ â”‚
â”‚ trade-service      â”‚ Canary           â”‚ ìœ„í—˜ë„ ë†’ìŒ â”‚
â”‚ account-service    â”‚ Rolling Update   â”‚ ì¼ë°˜ì       â”‚
â”‚ strategy-service   â”‚ Rolling Update   â”‚ ì¼ë°˜ì       â”‚
â”‚ notification       â”‚ Recreate         â”‚ ì¤‘ìš”ë„ ë‚®ìŒ â”‚
â”‚ admin              â”‚ Recreate         â”‚ ì‚¬ìš©ìž ì ìŒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Makefile í†µí•©

```makefile
# Makefile
.PHONY: deploy-blue-green deploy-canary deploy-rolling

# Blue-Green ë°°í¬
deploy-blue-green:
	@echo "ðŸ”µðŸŸ¢ Blue-Green Deployment"
	@read -p "Enter service name: " service; \
	read -p "Enter new version: " version; \
	bash scripts/blue-green-deploy.sh $$service $$version

# Canary ë°°í¬
deploy-canary:
	@echo "ðŸ¤ Canary Deployment"
	@read -p "Enter service name: " service; \
	read -p "Enter new version: " version; \
	bash scripts/canary-deploy.sh $$service $$version

# Rolling Update
deploy-rolling:
	@echo "ðŸ”„ Rolling Update"
	@read -p "Enter service name: " service; \
	read -p "Enter new version: " version; \
	export VERSION=$$version && docker stack deploy -c docker-stack.yml lk-trade

# ë¡¤ë°±
rollback:
	@echo "âª Rollback"
	@read -p "Enter service name: " service; \
	docker service rollback lk-trade_$$service

# ë°°í¬ ìƒíƒœ í™•ì¸
deploy-status:
	@docker service ls
	@echo ""
	@docker service ps lk-trade_user-service --format "table {{.Name}}\t{{.Image}}\t{{.CurrentState}}"
```

---

## ë‹¤ìŒ ë‹¨ê³„

ì¶•í•˜í•©ë‹ˆë‹¤! ðŸŽ‰ í”„ë¡œë•ì…˜ ë°°í¬ ì „ëžµì„ ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤.

### ì´ë²ˆ ì„¹ì…˜ì—ì„œ ë°°ìš´ ê²ƒ

âœ… ë°°í¬ ì „ëžµì˜ ì¤‘ìš”ì„±
âœ… Recreate ë°°í¬
âœ… Rolling Update (ìˆœì°¨ ë°°í¬)
âœ… Blue-Green ë°°í¬
âœ… Canary ë°°í¬
âœ… A/B Testing
âœ… ì„œë¹„ìŠ¤ë³„ ë°°í¬ ì „ëžµ ì„ íƒ

### ë‹¤ìŒì— ë°°ìš¸ ê²ƒ

**ì„¹ì…˜ 30: CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•**ì—ì„œëŠ”:
- GitHub Actionsë¥¼ ì´ìš©í•œ CI/CD
- Jenkinsë¥¼ ì´ìš©í•œ CI/CD
- GitLab CI/CD
- ìžë™í™”ëœ í…ŒìŠ¤íŠ¸ ë° ë°°í¬

### ì¶”ê°€ í•™ìŠµ ìžë£Œ

**ê³µì‹ ë¬¸ì„œ:**
- [Docker Swarm Deploy](https://docs.docker.com/engine/swarm/stack-deploy/)
- [Rolling Updates](https://docs.docker.com/engine/swarm/swarm-tutorial/rolling-update/)

**ë„êµ¬:**
- [Traefik](https://traefik.io/) - í˜„ëŒ€ì ì¸ ë¡œë“œ ë°¸ëŸ°ì„œ
- [Flagger](https://flagger.app/) - Canary ë°°í¬ ìžë™í™”

---

**ë‹¤ìŒ ì„¹ì…˜ì—ì„œ ë§Œë‚˜ìš”!** ðŸš€