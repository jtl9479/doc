# 24. ë¦¬ì†ŒìŠ¤ ì œí•œ ë° ê´€ë¦¬

## ëª©ì°¨
1. [ë¦¬ì†ŒìŠ¤ ì œí•œì˜ ì¤‘ìš”ì„±](#ë¦¬ì†ŒìŠ¤-ì œí•œì˜-ì¤‘ìš”ì„±)
2. [CPU ì œí•œ](#cpu-ì œí•œ)
3. [ë©”ëª¨ë¦¬ ì œí•œ](#ë©”ëª¨ë¦¬-ì œí•œ)
4. [ë””ìŠ¤í¬ I/O ì œí•œ](#ë””ìŠ¤í¬-io-ì œí•œ)
5. [ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì œí•œ](#ë„¤íŠ¸ì›Œí¬-ëŒ€ì—­í­-ì œí•œ)
6. [PID ì œí•œ](#pid-ì œí•œ)
7. [ë¦¬ì†ŒìŠ¤ ì˜ˆì•½ (Reservation)](#ë¦¬ì†ŒìŠ¤-ì˜ˆì•½-reservation)
8. [ì‹¤ì „ ì˜ˆì œ: LK-Trade ë¦¬ì†ŒìŠ¤ ì„¤ì •](#ì‹¤ì „-ì˜ˆì œ-lk-trade-ë¦¬ì†ŒìŠ¤-ì„¤ì •)
9. [ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§](#ë¦¬ì†ŒìŠ¤-ëª¨ë‹ˆí„°ë§)
10. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ë¦¬ì†ŒìŠ¤ ì œí•œì˜ ì¤‘ìš”ì„±

### ì™œ ë¦¬ì†ŒìŠ¤ë¥¼ ì œí•œí•´ì•¼ í•˜ë‚˜?

**ì‹¤ìƒí™œ ë¹„ìœ **: ì•„íŒŒíŠ¸ ì „ê¸° ì‚¬ìš©ëŸ‰ ì œí•œ

```
ì œí•œ ì—†ëŠ” ê²½ìš°:
- 201í˜¸: ì—ì–´ì»¨ 10ëŒ€ ê°€ë™
- 202í˜¸: ì •ìƒ ì‚¬ìš©
- 203í˜¸: ì •ìƒ ì‚¬ìš©
â†’ ì „ì²´ ì•„íŒŒíŠ¸ ì •ì „! âš¡

ì œí•œ ìˆëŠ” ê²½ìš°:
- 201í˜¸: ìµœëŒ€ 5kW ì œí•œ (ì°¨ë‹¨ê¸°)
- 202í˜¸: ìµœëŒ€ 5kW ì œí•œ
- 203í˜¸: ìµœëŒ€ 5kW ì œí•œ
â†’ 201í˜¸ë§Œ ì°¨ë‹¨, ë‹¤ë¥¸ ì§‘ì€ ì •ìƒ âœ…
```

**Docker í™˜ê²½**:
```
ì œí•œ ì—†ëŠ” ê²½ìš°:
Container A: CPU 100% + ë©”ëª¨ë¦¬ 8GB ì‚¬ìš©
â†’ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë“¤ ëŠë ¤ì§/ì¤‘ë‹¨ âŒ

ì œí•œ ìˆëŠ” ê²½ìš°:
Container A: CPU ìµœëŒ€ 50% + ë©”ëª¨ë¦¬ 2GB
â†’ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë“¤ ì •ìƒ ì‘ë™ âœ…
```

### ë¦¬ì†ŒìŠ¤ ì œí•œì˜ ì´ì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ì´ì            â”‚            ì„¤ëª…                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì•ˆì •ì„± í–¥ìƒ        â”‚ í•œ ì»¨í…Œì´ë„ˆê°€ ì „ì²´ ì‹œìŠ¤í…œ        â”‚
â”‚                    â”‚ ë§ˆë¹„ì‹œí‚¤ëŠ” ê²ƒ ë°©ì§€               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ê³µí‰í•œ ë¦¬ì†ŒìŠ¤ ë¶„ë°° â”‚ ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ í•„ìš”í•œ           â”‚
â”‚                    â”‚ ë¦¬ì†ŒìŠ¤ ë³´ì¥                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë¹„ìš© ì˜ˆì¸¡ ê°€ëŠ¥     â”‚ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ë¹„ìš©           â”‚
â”‚                    â”‚ ì´ˆê³¼ ë°©ì§€                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì„±ëŠ¥ ì˜ˆì¸¡ ê°€ëŠ¥     â”‚ ì¼ì •í•œ ì„±ëŠ¥ ë³´ì¥                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë³´ì•ˆ ê°•í™”          â”‚ ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ê³µê²©(DoS) ë°©ì–´       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CPU ì œí•œ

### CPU ì œí•œ ë°©ì‹

#### 1. --cpus (ì¶”ì²œ)

```bash
# 2ê°œ CPU ì½”ì–´ ì‚¬ìš© ì œí•œ
docker run -d --cpus="2.0" nginx

# 0.5ê°œ CPU ì½”ì–´ (50%)
docker run -d --cpus="0.5" nginx

# docker-compose.yml
services:
  user-service:
    image: user-service:latest
    cpus: 2.0  # 2 CPU ì½”ì–´
```

**ë™ì‘ ì›ë¦¬**:
```
í˜¸ìŠ¤íŠ¸: 8 CPU ì½”ì–´
ì»¨í…Œì´ë„ˆ: --cpus="2.0"

â†’ ì»¨í…Œì´ë„ˆëŠ” ìµœëŒ€ 2 CPU ì½”ì–´ë§Œ ì‚¬ìš© ê°€ëŠ¥
â†’ 8 ì½”ì–´ ëª¨ë‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ì§€ë§Œ, ì´ ì‚¬ìš©ëŸ‰ì€ 2 ì½”ì–´ë¡œ ì œí•œ
```

#### 2. --cpu-shares (ìƒëŒ€ì  ê°€ì¤‘ì¹˜)

```bash
# ê¸°ë³¸ê°’: 1024
docker run -d --cpu-shares=512 nginx   # 50% ê°€ì¤‘ì¹˜
docker run -d --cpu-shares=1024 nginx  # 100% ê°€ì¤‘ì¹˜ (ê¸°ë³¸)
docker run -d --cpu-shares=2048 nginx  # 200% ê°€ì¤‘ì¹˜
```

**ë™ì‘ ì›ë¦¬**:
```
ì»¨í…Œì´ë„ˆ A: --cpu-shares=1024
ì»¨í…Œì´ë„ˆ B: --cpu-shares=2048
ì»¨í…Œì´ë„ˆ C: --cpu-shares=1024

CPU ê²½í•© ì‹œ:
- ì»¨í…Œì´ë„ˆ A: 25% (1024 / 4096)
- ì»¨í…Œì´ë„ˆ B: 50% (2048 / 4096)
- ì»¨í…Œì´ë„ˆ C: 25% (1024 / 4096)

CPU ì—¬ìœ  ì‹œ:
- ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ í•„ìš”í•œ ë§Œí¼ ì‚¬ìš© ê°€ëŠ¥
```

#### 3. --cpuset-cpus (íŠ¹ì • ì½”ì–´ í• ë‹¹)

```bash
# CPU 0, 1ë²ˆë§Œ ì‚¬ìš©
docker run -d --cpuset-cpus="0,1" nginx

# CPU 0-3ë²ˆ ì‚¬ìš©
docker run -d --cpuset-cpus="0-3" nginx

# docker-compose.yml
services:
  user-service:
    cpuset: "0,1"  # CPU 0, 1ë²ˆ ì½”ì–´ë§Œ
```

**ì‚¬ìš© ì‚¬ë¡€**:
```
NUMA ì‹œìŠ¤í…œì—ì„œ ì„±ëŠ¥ ìµœì í™”:
- CPU 0-7: NUMA ë…¸ë“œ 0 (ë©”ëª¨ë¦¬ ë±…í¬ 0 ê°€ê¹Œì›€)
- CPU 8-15: NUMA ë…¸ë“œ 1 (ë©”ëª¨ë¦¬ ë±…í¬ 1 ê°€ê¹Œì›€)

â†’ ì»¨í…Œì´ë„ˆë¥¼ íŠ¹ì • NUMA ë…¸ë“œì— ê³ ì •
```

### CPU ì œí•œ ë¹„êµ

```yaml
# docker-compose.yml

services:
  # 1. ì ˆëŒ€ì  ì œí•œ (ì¶”ì²œ)
  web-server:
    image: nginx
    cpus: 1.5  # ìµœëŒ€ 1.5 CPU ì½”ì–´

  # 2. ìƒëŒ€ì  ê°€ì¤‘ì¹˜
  background-job:
    image: worker
    cpu_shares: 512  # ë‚®ì€ ìš°ì„ ìˆœìœ„

  # 3. íŠ¹ì • ì½”ì–´ í• ë‹¹
  real-time-service:
    image: rt-service
    cpuset: "0,1"  # CPU 0, 1ë²ˆ ì „ìš©
```

### CPU ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

```bash
# ì‹¤ì‹œê°„ CPU ì‚¬ìš©ëŸ‰
docker stats

# CPU ì œí•œ í™•ì¸
docker inspect container_id | jq '.[0].HostConfig.NanoCpus'
# 2000000000 = 2.0 CPU

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ
docker exec container_id cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
docker exec container_id cat /sys/fs/cgroup/cpu/cpu.cfs_period_us
# quota / period = CPU ì½”ì–´ ìˆ˜
```

---

## ë©”ëª¨ë¦¬ ì œí•œ

### ë©”ëª¨ë¦¬ ì œí•œ ì˜µì…˜

#### 1. --memory (í•˜ë“œ ë¦¬ë¯¸íŠ¸)

```bash
# 512MB ì œí•œ
docker run -d --memory="512m" nginx

# 2GB ì œí•œ
docker run -d --memory="2g" nginx

# docker-compose.yml
services:
  user-service:
    image: user-service:latest
    mem_limit: 1g  # 1GB
```

**ë™ì‘ ì›ë¦¬**:
```
ë©”ëª¨ë¦¬ ì œí•œ: 512MB
í”„ë¡œì„¸ìŠ¤ê°€ 512MB ì´ˆê³¼ ì‹œë„:
â†’ OOM Killer ì‘ë™
â†’ ì»¨í…Œì´ë„ˆ ê°•ì œ ì¢…ë£Œ (Exit Code 137)
```

#### 2. --memory-reservation (ì†Œí”„íŠ¸ ë¦¬ë¯¸íŠ¸)

```bash
# ì˜ˆì•½: 256MB, ìµœëŒ€: 512MB
docker run -d \
  --memory="512m" \
  --memory-reservation="256m" \
  nginx
```

**ë™ì‘ ì›ë¦¬**:
```
ì •ìƒ ìƒí™©:
- 256MB ë³´ì¥ë°›ìŒ
- í•„ìš” ì‹œ 512MBê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥

ë©”ëª¨ë¦¬ ë¶€ì¡± ìƒí™©:
- 256MBê¹Œì§€ ë³´ì¥
- 256MB~512MBëŠ” íšŒìˆ˜ë  ìˆ˜ ìˆìŒ
```

#### 3. --memory-swap (ìŠ¤ì™‘ í¬í•¨ ì œí•œ)

```bash
# ë©”ëª¨ë¦¬: 512MB, ìŠ¤ì™‘: 512MB (ì´ 1GB)
docker run -d \
  --memory="512m" \
  --memory-swap="1g" \
  nginx

# ìŠ¤ì™‘ ë¹„í™œì„±í™”
docker run -d \
  --memory="512m" \
  --memory-swap="512m" \
  nginx
```

**ë™ì‘ ì›ë¦¬**:
```
--memory="512m" --memory-swap="1g"
â†’ ë¬¼ë¦¬ ë©”ëª¨ë¦¬: 512MB
â†’ ìŠ¤ì™‘: 512MB (1g - 512m)

--memory="512m" --memory-swap="512m"
â†’ ë¬¼ë¦¬ ë©”ëª¨ë¦¬: 512MB
â†’ ìŠ¤ì™‘: 0 (ìŠ¤ì™‘ ë¹„í™œì„±í™”)
```

### OOM (Out of Memory) ë™ì‘ ì„¤ì •

```bash
# OOM Killer ë¹„í™œì„±í™” (ìœ„í—˜!)
docker run -d \
  --memory="512m" \
  --oom-kill-disable \
  nginx

# OOM ì ìˆ˜ ì¡°ì • (ìš°ì„ ìˆœìœ„)
docker run -d \
  --memory="512m" \
  --oom-score-adj=500 \
  nginx
```

```yaml
# docker-compose.yml

services:
  critical-service:
    image: critical:latest
    mem_limit: 1g
    oom_score_adj: -500  # ë‚®ì„ìˆ˜ë¡ ì¢…ë£Œ ìš°ì„ ìˆœìœ„ ë‚®ìŒ

  non-critical-service:
    image: worker:latest
    mem_limit: 512m
    oom_score_adj: 500   # ë†’ì„ìˆ˜ë¡ ë¨¼ì € ì¢…ë£Œë¨
```

### ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

```bash
# ì‹¤ì‹œê°„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
docker stats

# ë©”ëª¨ë¦¬ ì œí•œ í™•ì¸
docker inspect container_id | jq '.[0].HostConfig.Memory'

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ
docker exec container_id cat /sys/fs/cgroup/memory/memory.limit_in_bytes
docker exec container_id cat /sys/fs/cgroup/memory/memory.usage_in_bytes
```

### JVM ë©”ëª¨ë¦¬ ì„¤ì • (Java/Kotlin)

```dockerfile
# Dockerfile

FROM eclipse-temurin:21-jre-alpine

# ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì¸ì‹ (JDK 8u191+)
ENV JAVA_OPTS="-XX:+UseContainerSupport \
               -XX:MaxRAMPercentage=75.0 \
               -XX:InitialRAMPercentage=50.0"

CMD ["java", "-jar", "app.jar"]
```

```yaml
# docker-compose.yml

services:
  user-service:
    image: user-service:latest
    mem_limit: 2g
    environment:
      # JVMì´ ì „ì²´ 2GB ì¸ì‹
      # MaxRAMPercentage=75.0 â†’ í™ ìµœëŒ€ 1.5GB
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
```

---

## ë””ìŠ¤í¬ I/O ì œí•œ

### Block I/O ê°€ì¤‘ì¹˜

```bash
# ê¸°ë³¸ê°’: 500
docker run -d --blkio-weight=300 nginx  # ë‚®ì€ ìš°ì„ ìˆœìœ„
docker run -d --blkio-weight=700 nginx  # ë†’ì€ ìš°ì„ ìˆœìœ„
```

### ì½ê¸°/ì“°ê¸° ì†ë„ ì œí•œ

```bash
# ì½ê¸° ì†ë„: 10MB/s
docker run -d \
  --device-read-bps /dev/sda:10mb \
  nginx

# ì“°ê¸° ì†ë„: 5MB/s
docker run -d \
  --device-write-bps /dev/sda:5mb \
  nginx

# docker-compose.yml
services:
  database:
    image: postgres:15
    device_read_bps:
      - path: /dev/sda
        rate: 50mb
    device_write_bps:
      - path: /dev/sda
        rate: 20mb
```

### IOPS ì œí•œ

```bash
# ì½ê¸° IOPS: 100
docker run -d \
  --device-read-iops /dev/sda:100 \
  nginx

# ì“°ê¸° IOPS: 50
docker run -d \
  --device-write-iops /dev/sda:50 \
  nginx
```

---

## ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì œí•œ

Docker ìì²´ëŠ” ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì œí•œ ê¸°ëŠ¥ì´ ì—†ì§€ë§Œ, Linuxì˜ `tc` (traffic control)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### tcë¥¼ ì´ìš©í•œ ëŒ€ì—­í­ ì œí•œ

```bash
#!/bin/bash
# scripts/limit-bandwidth.sh

CONTAINER_ID=$1
BANDWIDTH=${2:-1mbit}  # ê¸°ë³¸ 1Mbps

# ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì°¾ê¸°
CONTAINER_PID=$(docker inspect -f '{{.State.Pid}}' $CONTAINER_ID)
CONTAINER_NETNS="docker-${CONTAINER_ID}"

# tc ê·œì¹™ ì¶”ê°€
sudo tc qdisc add dev veth_${CONTAINER_PID} root tbf \
    rate $BANDWIDTH \
    burst 32kbit \
    latency 400ms

echo "ì»¨í…Œì´ë„ˆ $CONTAINER_ID ëŒ€ì—­í­ì„ $BANDWIDTHë¡œ ì œí•œí–ˆìŠµë‹ˆë‹¤."
```

### Docker Network Plugin ì‚¬ìš©

```yaml
# docker-compose.yml

services:
  user-service:
    image: user-service:latest
    networks:
      - limited-network

networks:
  limited-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500
```

---

## PID ì œí•œ

### PID (í”„ë¡œì„¸ìŠ¤ ìˆ˜) ì œí•œ

```bash
# ìµœëŒ€ 100ê°œ í”„ë¡œì„¸ìŠ¤
docker run -d --pids-limit=100 nginx

# docker-compose.yml
services:
  user-service:
    image: user-service:latest
    pids_limit: 200
```

**ì‚¬ìš© ì‚¬ë¡€**:
```
í¬í¬ í­íƒ„(Fork Bomb) ë°©ì–´:
ë¬´í•œíˆ í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ì•…ì˜ì  ì½”ë“œ

while true; do
    bash &
done

â†’ PID ì œí•œìœ¼ë¡œ ë°©ì–´
```

---

## ë¦¬ì†ŒìŠ¤ ì˜ˆì•½ (Reservation)

### CPU ì˜ˆì•½

```yaml
# docker-compose.yml

services:
  user-service:
    image: user-service:latest
    deploy:
      resources:
        limits:
          cpus: '2.0'      # ìµœëŒ€ 2 CPU
        reservations:
          cpus: '1.0'      # ìµœì†Œ 1 CPU ë³´ì¥
```

### ë©”ëª¨ë¦¬ ì˜ˆì•½

```yaml
services:
  database:
    image: postgres:15
    deploy:
      resources:
        limits:
          memory: 4G       # ìµœëŒ€ 4GB
        reservations:
          memory: 2G       # ìµœì†Œ 2GB ë³´ì¥
```

**ë™ì‘ ì›ë¦¬**:
```
Reservations (ì˜ˆì•½):
- ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì»¨í…Œì´ë„ˆ ë°°ì¹˜ ì‹œ ê³ ë ¤
- í•´ë‹¹ ë¦¬ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆí•¨

Limits (ì œí•œ):
- ì‹¤ì œ ëŸ°íƒ€ì„ì—ì„œ ê°•ì œ ì œí•œ
- ì´ˆê³¼ ì‹œ ì œí•œ/ì¢…ë£Œ

ì˜ˆì‹œ:
reservations: 2GB, limits: 4GB
â†’ ìµœì†Œ 2GB í™•ë³´ í›„ ì‹œì‘
â†’ ìµœëŒ€ 4GBê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥
```

---

## ì‹¤ì „ ì˜ˆì œ: LK-Trade ë¦¬ì†ŒìŠ¤ ì„¤ì •

### í”„ë¡œë•ì…˜ í™˜ê²½ ë¦¬ì†ŒìŠ¤ ì„¤ì •

```yaml
# docker-compose.prod.yml

version: '3.8'

x-resource-limits: &standard-limits
  cpus: '1.0'
  mem_limit: 1g
  mem_reservation: 512m

x-resource-limits-high: &high-limits
  cpus: '2.0'
  mem_limit: 2g
  mem_reservation: 1g

services:
  # ì¸í”„ë¼ (ë†’ì€ ë¦¬ì†ŒìŠ¤)
  postgres:
    image: postgres:15-alpine
    <<: *high-limits
    environment:
      - POSTGRES_DB=lktrade
      - POSTGRES_USER=lkuser
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    shm_size: 256m  # ê³µìœ  ë©”ëª¨ë¦¬

  redis:
    image: redis:7-alpine
    cpus: 0.5
    mem_limit: 512m
    mem_reservation: 256m
    command: >
      redis-server
      --maxmemory 400mb
      --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # User Service (í‘œì¤€ ë¦¬ì†ŒìŠ¤)
  user-service:
    image: ${REGISTRY}/user-service:${VERSION}
    <<: *standard-limits
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Account Service (í‘œì¤€ ë¦¬ì†ŒìŠ¤)
  account-service:
    image: ${REGISTRY}/account-service:${VERSION}
    <<: *standard-limits
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Trade Service (ë†’ì€ ë¦¬ì†ŒìŠ¤ - ì‹¤ì‹œê°„ ê±°ë˜)
  trade-service:
    image: ${REGISTRY}/trade-service:${VERSION}
    <<: *high-limits
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    # ë†’ì€ ìš°ì„ ìˆœìœ„ (OOM ì‹œ ë§ˆì§€ë§‰ì— ì¢…ë£Œ)
    oom_score_adj: -500

  # AI Service (ë§¤ìš° ë†’ì€ ë¦¬ì†ŒìŠ¤ - GPT í˜¸ì¶œ)
  ai-service:
    image: ${REGISTRY}/ai-service:${VERSION}
    cpus: 2.0
    mem_limit: 3g
    mem_reservation: 2g
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=80.0
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Scraper Service (ë‚®ì€ ë¦¬ì†ŒìŠ¤ - ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…)
  scraper-service:
    image: ${REGISTRY}/scraper-service:${VERSION}
    cpus: 0.5
    mem_limit: 512m
    mem_reservation: 256m
    cpu_shares: 512  # ë‚®ì€ ìš°ì„ ìˆœìœ„
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    # ë‚®ì€ ìš°ì„ ìˆœìœ„ (OOM ì‹œ ë¨¼ì € ì¢…ë£Œ)
    oom_score_adj: 500

  # Nginx (ë‚®ì€ ë¦¬ì†ŒìŠ¤)
  nginx:
    image: nginx:alpine
    cpus: 0.5
    mem_limit: 256m
    ports:
      - "80:80"
      - "443:443"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

volumes:
  postgres-data:
```

### ê°œë°œ í™˜ê²½ ë¦¬ì†ŒìŠ¤ ì„¤ì •

```yaml
# docker-compose.dev.yml

version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    # ê°œë°œ í™˜ê²½: ì œí•œ ì—†ìŒ (ë¹ ë¥¸ ê°œë°œ)
    shm_size: 128m

  redis:
    image: redis:7-alpine
    # ê°œë°œ í™˜ê²½: ì œí•œ ì—†ìŒ

  user-service:
    build:
      context: ./modules/user
      dockerfile: Dockerfile.dev
    # ê°œë°œ í™˜ê²½: ê°€ë²¼ìš´ ì œí•œë§Œ
    mem_limit: 2g
    # OOM ë°©ì§€ìš©, í•« ë¦¬ë¡œë“œ ìœ„í•œ ì—¬ìœ  ê³µê°„
```

---

## ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ëŒ€ì‹œë³´ë“œ

```bash
#!/bin/bash
# scripts/resource-monitor.sh

echo "ğŸ“Š LK-Trade ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰"
echo "========================================"

# í—¤ë”
printf "%-20s %8s %12s %12s\n" "SERVICE" "CPU %" "MEMORY" "NET I/O"
echo "----------------------------------------"

# ê° ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ í™•ì¸
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" | tail -n +2 | while read line; do
    printf "%s\n" "$line"
done

echo "========================================"

# ì „ì²´ ìš”ì•½
echo ""
echo "ì „ì²´ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
docker stats --no-stream --format "CPU: {{.CPUPerc}}, Memory: {{.MemUsage}}" | \
    awk '{cpu+=$2; mem+=$4} END {print "  Total CPU: " cpu "%, Total Memory: " mem "MB"}'
```

### Prometheus ë©”íŠ¸ë¦­

```yaml
# prometheus.yml

scrape_configs:
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
```

### Grafana ëŒ€ì‹œë³´ë“œ ì˜ˆì œ

```json
{
  "dashboard": {
    "title": "LK-Trade ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§",
    "panels": [
      {
        "title": "CPU ì‚¬ìš©ëŸ‰",
        "targets": [
          {
            "expr": "rate(container_cpu_usage_seconds_total[5m])"
          }
        ]
      },
      {
        "title": "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰",
        "targets": [
          {
            "expr": "container_memory_usage_bytes"
          }
        ]
      },
      {
        "title": "ë„¤íŠ¸ì›Œí¬ I/O",
        "targets": [
          {
            "expr": "rate(container_network_receive_bytes_total[5m])"
          }
        ]
      }
    ]
  }
}
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: OOM Killed (Exit Code 137)

**ì¦ìƒ**:
```bash
$ docker ps -a
CONTAINER ID   STATUS                     NAMES
a1b2c3d4e5f6   Exited (137) 1 minute ago  user-service
```

**ì§„ë‹¨**:
```bash
# 1. ë¡œê·¸ í™•ì¸
docker logs user-service | tail -50

# 2. ë©”ëª¨ë¦¬ ì œí•œ í™•ì¸
docker inspect user-service | jq '.[0].HostConfig.Memory'

# 3. OOMKilled í™•ì¸
docker inspect user-service | jq '.[0].State.OOMKilled'
# true
```

**í•´ê²°**:
```yaml
# docker-compose.yml
services:
  user-service:
    mem_limit: 2g  # 1g â†’ 2g ì¦ê°€
    environment:
      - JAVA_OPTS=-XX:MaxRAMPercentage=75.0  # 80 â†’ 75ë¡œ ê°ì†Œ
```

### ë¬¸ì œ 2: CPU ì œí•œìœ¼ë¡œ ì¸í•œ ëŠë¦° ì‘ë‹µ

**ì¦ìƒ**:
```
API ì‘ë‹µ ì‹œê°„ì´ í‰ì†Œë³´ë‹¤ 5ë°° ëŠë¦¼
```

**ì§„ë‹¨**:
```bash
# CPU ì‚¬ìš©ë¥  í™•ì¸
docker stats user-service

# CPU ì œí•œ í™•ì¸
docker inspect user-service | jq '.[0].HostConfig.NanoCpus'
```

**í•´ê²°**:
```yaml
services:
  user-service:
    cpus: 2.0  # 1.0 â†’ 2.0 ì¦ê°€
```

### ë¬¸ì œ 3: ë””ìŠ¤í¬ I/O ë³‘ëª©

**ì¦ìƒ**:
```
ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ê°€ ë§¤ìš° ëŠë¦¼
```

**ì§„ë‹¨**:
```bash
# I/O í†µê³„
docker stats postgres --no-stream --format "{{.BlockIO}}"

# I/O ì œí•œ í™•ì¸
docker inspect postgres | jq '.[0].HostConfig.BlkioDeviceReadBps'
```

**í•´ê²°**:
```yaml
services:
  postgres:
    # I/O ì œí•œ ì œê±° ë˜ëŠ” ì¦ê°€
    device_read_bps:
      - path: /dev/sda
        rate: 100mb  # 50mb â†’ 100mb
```

---

## ë¦¬ì†ŒìŠ¤ ì œí•œ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. í”„ë¡œë•ì…˜ í™˜ê²½

```yaml
services:
  # í•µì‹¬ ì„œë¹„ìŠ¤: ë†’ì€ ë¦¬ì†ŒìŠ¤ + ìš°ì„ ìˆœìœ„
  core-service:
    cpus: 2.0
    mem_limit: 2g
    mem_reservation: 1g
    oom_score_adj: -500  # ë‚®ì€ OOM ìš°ì„ ìˆœìœ„

  # ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤: ë‚®ì€ ë¦¬ì†ŒìŠ¤ + ìš°ì„ ìˆœìœ„
  worker:
    cpus: 0.5
    mem_limit: 512m
    cpu_shares: 512
    oom_score_adj: 500   # ë†’ì€ OOM ìš°ì„ ìˆœìœ„
```

### 2. ê°œë°œ í™˜ê²½

```yaml
services:
  # ê°œë°œ í™˜ê²½: ê´€ëŒ€í•œ ì œí•œ (í¸ì˜ì„±)
  dev-service:
    mem_limit: 4g  # ë„‰ë„‰í•˜ê²Œ
    # CPU ì œí•œ ì—†ìŒ (ë¹ ë¥¸ ë¹Œë“œ)
```

### 3. í…ŒìŠ¤íŠ¸ í™˜ê²½

```yaml
services:
  # í…ŒìŠ¤íŠ¸ í™˜ê²½: í”„ë¡œë•ì…˜ê³¼ ë™ì¼í•œ ì œí•œ (ì •í™•í•œ í…ŒìŠ¤íŠ¸)
  test-service:
    cpus: 1.0
    mem_limit: 1g
```

---

## ë‹¤ìŒ ë‹¨ê³„

### 25. ì»¨í…Œì´ë„ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
- docker stats í™œìš©
- cAdvisor ì„¤ì¹˜
- Prometheus + Grafana ì—°ë™

### í•™ìŠµ ìë£Œ

**ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**:
- [Docker Resource Constraints](https://docs.docker.com/config/containers/resource_constraints/)
- [cgroups Documentation](https://www.kernel.org/doc/Documentation/cgroup-v1/)

**ëª¨ë‹ˆí„°ë§**:
- [cAdvisor](https://github.com/google/cadvisor)
- [Prometheus](https://prometheus.io/docs/introduction/overview/)

---

**ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰** Docker ë¦¬ì†ŒìŠ¤ ì œí•œê³¼ ê´€ë¦¬ë¥¼ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤!