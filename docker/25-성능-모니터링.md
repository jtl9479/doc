# 25. ì»¨í…Œì´ë„ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

## ëª©ì°¨
1. [ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì˜ ì¤‘ìš”ì„±](#ì„±ëŠ¥-ëª¨ë‹ˆí„°ë§ì˜-ì¤‘ìš”ì„±)
2. [docker stats í™œìš©](#docker-stats-í™œìš©)
3. [cAdvisor ì„¤ì¹˜ ë° ì‚¬ìš©](#cadvisor-ì„¤ì¹˜-ë°-ì‚¬ìš©)
4. [Prometheus + Grafana ì—°ë™](#prometheus-grafana-ì—°ë™)
5. [ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ì„](#ì„±ëŠ¥-ë©”íŠ¸ë¦­-ë¶„ì„)
6. [ë³‘ëª© ì§€ì  ì°¾ê¸°](#ë³‘ëª©-ì§€ì -ì°¾ê¸°)
7. [ì•Œë¦¼ ì„¤ì •](#ì•Œë¦¼-ì„¤ì •)
8. [ì‹¤ì „ ì˜ˆì œ: LK-Trade ëª¨ë‹ˆí„°ë§](#ì‹¤ì „-ì˜ˆì œ-lk-trade-ëª¨ë‹ˆí„°ë§)
9. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì˜ ì¤‘ìš”ì„±

### ì™œ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•œê°€?

**ì‹¤ìƒí™œ ë¹„ìœ **: ìë™ì°¨ ê³„ê¸°íŒ

```
ê³„ê¸°íŒ ì—†ëŠ” ìë™ì°¨:
- ì†ë„ë¥¼ ëª¨ë¦„
- ì—°ë£Œê°€ ì–¼ë§ˆë‚˜ ë‚¨ì•˜ëŠ”ì§€ ëª¨ë¦„
- ì—”ì§„ ê³¼ì—´ ì—¬ë¶€ ëª¨ë¦„
â†’ ì–¸ì œ ê³ ì¥ë‚ ì§€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ âŒ

ê³„ê¸°íŒ ìˆëŠ” ìë™ì°¨:
- ì‹¤ì‹œê°„ ì†ë„ í™•ì¸
- ì—°ë£Œ ì”ëŸ‰ í™•ì¸
- ì—”ì§„ ì˜¨ë„ í™•ì¸
â†’ ë¬¸ì œ ë°œìƒ ì „ ì¡°ì¹˜ ê°€ëŠ¥ âœ…
```

**Docker í™˜ê²½**:
```
ëª¨ë‹ˆí„°ë§ ì—†ìŒ:
- CPU ì‚¬ìš©ë¥ ? ëª¨ë¦„
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰? ëª¨ë¦„
- ë””ìŠ¤í¬ I/O? ëª¨ë¦„
â†’ ì„œë¹„ìŠ¤ ë‹¤ìš´ í›„ ì›ì¸ íŒŒì•… âŒ

ëª¨ë‹ˆí„°ë§ ìˆìŒ:
- CPU 95% â†’ ìŠ¤ì¼€ì¼ ì•„ì›ƒ í•„ìš”
- ë©”ëª¨ë¦¬ 90% â†’ ì¦ì„¤ í•„ìš”
- ë””ìŠ¤í¬ I/O ë³‘ëª© â†’ íŠœë‹ í•„ìš”
â†’ ë¬¸ì œ ë°œìƒ ì „ ì˜ˆë°© âœ…
```

### ëª¨ë‹ˆí„°ë§í•´ì•¼ í•  ì£¼ìš” ë©”íŠ¸ë¦­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ë©”íŠ¸ë¦­ ì¢…ë¥˜       â”‚          ì˜ë¯¸                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPU ì‚¬ìš©ë¥           â”‚ í”„ë¡œì„¸ì„œ ë¶€í•˜ ìˆ˜ì¤€               â”‚
â”‚                     â”‚ (ë†’ìœ¼ë©´ ìŠ¤ì¼€ì¼ ì•„ì›ƒ í•„ìš”)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰       â”‚ RAM ì‚¬ìš© ì •ë„                    â”‚
â”‚                     â”‚ (ë†’ìœ¼ë©´ ë©”ëª¨ë¦¬ ì¦ì„¤ ë˜ëŠ” ëˆ„ìˆ˜)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë„¤íŠ¸ì›Œí¬ I/O        â”‚ ì†¡ìˆ˜ì‹  ë°ì´í„°ëŸ‰                  â”‚
â”‚                     â”‚ (ëŒ€ì—­í­ ë³‘ëª© í™•ì¸)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë””ìŠ¤í¬ I/O          â”‚ ì½ê¸°/ì“°ê¸° ì†ë„                   â”‚
â”‚                     â”‚ (ìŠ¤í† ë¦¬ì§€ ë³‘ëª© í™•ì¸)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì‘ë‹µ ì‹œê°„           â”‚ ìš”ì²­ ì²˜ë¦¬ ì‹œê°„                   â”‚
â”‚                     â”‚ (ì‚¬ìš©ì ê²½í—˜ ì§€í‘œ)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì—ëŸ¬ìœ¨              â”‚ ì‹¤íŒ¨í•œ ìš”ì²­ ë¹„ìœ¨                 â”‚
â”‚                     â”‚ (ì„œë¹„ìŠ¤ ì•ˆì •ì„± ì§€í‘œ)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## docker stats í™œìš©

### ê¸°ë³¸ ì‚¬ìš©ë²•

```bash
# ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (ê³„ì† ê°±ì‹ )
docker stats

# 1íšŒë§Œ ì¶œë ¥
docker stats --no-stream

# íŠ¹ì • ì»¨í…Œì´ë„ˆë§Œ
docker stats user-service account-service

# ëª¨ë“  ì»¨í…Œì´ë„ˆ (ì¤‘ì§€ëœ ê²ƒ í¬í•¨)
docker stats --all
```

### ì¶œë ¥ í˜•ì‹

```
CONTAINER ID   NAME           CPU %   MEM USAGE / LIMIT   MEM %   NET I/O         BLOCK I/O
a1b2c3d4e5f6   user-service   2.50%   450MiB / 1GiB       43.95%  1.2kB / 648B    0B / 0B
```

**ê° ì—´ì˜ ì˜ë¯¸**:
- **CPU %**: CPU ì‚¬ìš©ë¥  (ë©€í‹°ì½”ì–´ í™˜ê²½ì—ì„œëŠ” 100% ì´ìƒ ê°€ëŠ¥)
- **MEM USAGE / LIMIT**: í˜„ì¬ ë©”ëª¨ë¦¬ / ì œí•œ
- **MEM %**: ë©”ëª¨ë¦¬ ì‚¬ìš© ë¹„ìœ¨
- **NET I/O**: ë„¤íŠ¸ì›Œí¬ ì†¡ìˆ˜ì‹ ëŸ‰ (ì „ì²´ ëˆ„ì )
- **BLOCK I/O**: ë””ìŠ¤í¬ ì½ê¸°/ì“°ê¸° (ì „ì²´ ëˆ„ì )

### ì»¤ìŠ¤í…€ í¬ë§·

```bash
# CPUì™€ ë©”ëª¨ë¦¬ë§Œ ì¶œë ¥
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

# JSON í˜•ì‹
docker stats --format "{{json .}}" --no-stream

# CSV í˜•ì‹
docker stats --no-stream --format "{{.Name}},{{.CPUPerc}},{{.MemUsage}}"
```

### ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/stats-monitor.sh

# ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ + ë¡œê·¸ ì €ì¥

LOG_DIR="./logs/stats"
LOG_FILE="$LOG_DIR/stats_$(date +%Y%m%d).csv"

mkdir -p $LOG_DIR

# í—¤ë” ì‘ì„± (ì²˜ìŒ ì‹¤í–‰ ì‹œ)
if [ ! -f "$LOG_FILE" ]; then
    echo "Timestamp,Container,CPU,Memory,MemoryPercent,NetIO,BlockIO" > $LOG_FILE
fi

# ë¬´í•œ ë£¨í”„ ëª¨ë‹ˆí„°ë§
while true; do
    TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

    docker stats --no-stream --format "{{.Name}},{{.CPUPerc}},{{.MemUsage}},{{.MemPerc}},{{.NetIO}},{{.BlockIO}}" | while read line; do
        echo "$TIMESTAMP,$line" >> $LOG_FILE
    done

    sleep 60  # 1ë¶„ë§ˆë‹¤ ìˆ˜ì§‘
done
```

### ê³ ê¸‰ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/stats-analyzer.sh

LOG_FILE=$1

if [ -z "$LOG_FILE" ]; then
    echo "Usage: $0 <log-file>"
    exit 1
fi

echo "ğŸ“Š í†µê³„ ë¶„ì„: $LOG_FILE"
echo ""

# ì»¨í…Œì´ë„ˆë³„ í‰ê·  CPU ì‚¬ìš©ë¥ 
echo "=== í‰ê·  CPU ì‚¬ìš©ë¥  ==="
awk -F',' 'NR>1 {cpu[$2]+=$3; count[$2]++} END {for(c in cpu) printf "%s: %.2f%%\n", c, cpu[c]/count[c]}' $LOG_FILE | sort -t: -k2 -rn

echo ""

# ì»¨í…Œì´ë„ˆë³„ ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
echo "=== ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ==="
awk -F',' 'NR>1 {if($4 > max[$2]) max[$2]=$4} END {for(c in max) print c": "max[c]}' $LOG_FILE | sort -t: -k2 -rn

echo ""

# CPU ì‚¬ìš©ë¥  90% ì´ìƒ ê²½ê³ 
echo "=== CPU ê²½ê³  (90% ì´ìƒ) ==="
awk -F',' 'NR>1 {gsub("%","",$3); if($3+0 > 90) print $1, $2, $3"%"}' $LOG_FILE
```

---

## cAdvisor ì„¤ì¹˜ ë° ì‚¬ìš©

### cAdvisorë€?

Googleì´ ê°œë°œí•œ ì»¨í…Œì´ë„ˆ ëª¨ë‹ˆí„°ë§ ë„êµ¬ë¡œ, ë” ìƒì„¸í•œ ë©”íŠ¸ë¦­ì„ ì œê³µí•©ë‹ˆë‹¤.

```
docker stats vs cAdvisor:

docker stats:
- ê¸°ë³¸ ë©”íŠ¸ë¦­ (CPU, ë©”ëª¨ë¦¬, ë„¤íŠ¸ì›Œí¬)
- CLI ê¸°ë°˜
- íˆìŠ¤í† ë¦¬ ì—†ìŒ

cAdvisor:
- ìƒì„¸ ë©”íŠ¸ë¦­ (íŒŒì¼ì‹œìŠ¤í…œ, ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë³„ ë“±)
- Web UI ì œê³µ
- ì§§ì€ íˆìŠ¤í† ë¦¬ ì œê³µ (ìµœê·¼ 1ë¶„)
- Prometheus ì—°ë™ ê°€ëŠ¥
```

### cAdvisor ì„¤ì¹˜

```yaml
# docker-compose.monitoring.yml

version: '3.8'

services:
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    command:
      - '--housekeeping_interval=10s'
      - '--docker_only=true'
      - '--disable_metrics=disk,network,tcp,udp,percpu,sched,process'
```

**Windows (Docker Desktop)**:
```yaml
services:
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/:/var/lib/docker:ro
```

### cAdvisor ì‹¤í–‰

```bash
# ì‹¤í–‰
docker-compose -f docker-compose.monitoring.yml up -d cadvisor

# í™•ì¸
curl http://localhost:8080/containers/
```

### cAdvisor Web UI

ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†: `http://localhost:8080`

**ì£¼ìš” ê¸°ëŠ¥**:
- **Docker Containers**: ëª¨ë“  ì»¨í…Œì´ë„ˆ ëª©ë¡ ë° ìƒì„¸ ì •ë³´
- **Metrics**: CPU, ë©”ëª¨ë¦¬, ë„¤íŠ¸ì›Œí¬, íŒŒì¼ì‹œìŠ¤í…œ ê·¸ë˜í”„
- **Subcontainers**: ì»¨í…Œì´ë„ˆ ê³„ì¸µ êµ¬ì¡°

### cAdvisor API

```bash
# ì „ì²´ ì»¨í…Œì´ë„ˆ ë©”íŠ¸ë¦­
curl http://localhost:8080/api/v2.0/stats?count=1

# íŠ¹ì • ì»¨í…Œì´ë„ˆ
curl http://localhost:8080/api/v2.0/docker/<container_id>

# Prometheus í˜•ì‹ ë©”íŠ¸ë¦­
curl http://localhost:8080/metrics
```

---

## Prometheus + Grafana ì—°ë™

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Grafana (ì‹œê°í™”)                 â”‚
â”‚            http://localhost:3000                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ ì¿¼ë¦¬
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Prometheus (ë©”íŠ¸ë¦­ ì €ì¥)             â”‚
â”‚            http://localhost:9090                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ ìŠ¤í¬ë© (ìˆ˜ì§‘)
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cAdvisor   â”‚      â”‚   Node      â”‚
â”‚  (ì»¨í…Œì´ë„ˆ)  â”‚      â”‚  Exporter   â”‚
â”‚             â”‚      â”‚  (í˜¸ìŠ¤íŠ¸)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Prometheus ì„¤ì •

```yaml
# docker-compose.monitoring.yml

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

volumes:
  prometheus-data:
```

```yaml
# prometheus/prometheus.yml

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # cAdvisor (ì»¨í…Œì´ë„ˆ ë©”íŠ¸ë¦­)
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  # Node Exporter (í˜¸ìŠ¤íŠ¸ ë©”íŠ¸ë¦­)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']

  # Spring Boot Actuator (ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­)
  - job_name: 'user-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['user-service:8080']

  - job_name: 'account-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['account-service:8080']

  - job_name: 'trade-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['trade-service:8080']
```

### Grafana ì„¤ì •

```yaml
# docker-compose.monitoring.yml

services:
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus

volumes:
  grafana-data:
```

### Grafana ë°ì´í„° ì†ŒìŠ¤ ìë™ ì„¤ì •

```yaml
# grafana/provisioning/datasources/prometheus.yml

apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
```

### ì „ì²´ ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ

```yaml
# docker-compose.monitoring.yml (ì™„ì „íŒ)

version: '3.8'

services:
  # cAdvisor (ì»¨í…Œì´ë„ˆ ë©”íŠ¸ë¦­)
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    privileged: true
    networks:
      - monitoring

  # Node Exporter (í˜¸ìŠ¤íŠ¸ ë©”íŠ¸ë¦­)
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - monitoring

  # Prometheus (ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì €ì¥)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - monitoring
    depends_on:
      - cadvisor
      - node-exporter

  # Grafana (ì‹œê°í™”)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - monitoring
    depends_on:
      - prometheus

  # Alertmanager (ì•Œë¦¼)
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
  alertmanager-data:
```

---

## ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ì„

### ì£¼ìš” PromQL ì¿¼ë¦¬

#### CPU ë©”íŠ¸ë¦­

```promql
# ì»¨í…Œì´ë„ˆë³„ CPU ì‚¬ìš©ë¥  (%)
rate(container_cpu_usage_seconds_total[5m]) * 100

# 5ë¶„ í‰ê·  CPU ì‚¬ìš©ë¥ 
avg(rate(container_cpu_usage_seconds_total[5m])) by (name) * 100

# CPU ì‚¬ìš©ë¥  ìƒìœ„ 5ê°œ ì»¨í…Œì´ë„ˆ
topk(5, rate(container_cpu_usage_seconds_total[5m])) * 100
```

#### ë©”ëª¨ë¦¬ ë©”íŠ¸ë¦­

```promql
# ì»¨í…Œì´ë„ˆë³„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (MB)
container_memory_usage_bytes / 1024 / 1024

# ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  (%)
(container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100

# ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  80% ì´ìƒ
(container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 80
```

#### ë„¤íŠ¸ì›Œí¬ ë©”íŠ¸ë¦­

```promql
# ë„¤íŠ¸ì›Œí¬ ìˆ˜ì‹  ì†ë„ (bytes/sec)
rate(container_network_receive_bytes_total[5m])

# ë„¤íŠ¸ì›Œí¬ ì†¡ì‹  ì†ë„ (bytes/sec)
rate(container_network_transmit_bytes_total[5m])

# ì´ ë„¤íŠ¸ì›Œí¬ I/O
rate(container_network_receive_bytes_total[5m]) + rate(container_network_transmit_bytes_total[5m])
```

#### ë””ìŠ¤í¬ I/O ë©”íŠ¸ë¦­

```promql
# ë””ìŠ¤í¬ ì½ê¸° ì†ë„ (bytes/sec)
rate(container_fs_reads_bytes_total[5m])

# ë””ìŠ¤í¬ ì“°ê¸° ì†ë„ (bytes/sec)
rate(container_fs_writes_bytes_total[5m])
```

### Grafana ëŒ€ì‹œë³´ë“œ JSON

```json
{
  "dashboard": {
    "title": "LK-Trade Docker ëª¨ë‹ˆí„°ë§",
    "panels": [
      {
        "title": "CPU ì‚¬ìš©ë¥ ",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(container_cpu_usage_seconds_total{name=~\".*-service\"}[5m]) * 100",
            "legendFormat": "{{name}}"
          }
        ],
        "yaxes": [
          {
            "format": "percent",
            "max": 100
          }
        ]
      },
      {
        "title": "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰",
        "type": "graph",
        "targets": [
          {
            "expr": "container_memory_usage_bytes{name=~\".*-service\"} / 1024 / 1024",
            "legendFormat": "{{name}}"
          }
        ],
        "yaxes": [
          {
            "format": "megabytes"
          }
        ]
      },
      {
        "title": "ë„¤íŠ¸ì›Œí¬ I/O",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(container_network_receive_bytes_total{name=~\".*-service\"}[5m])",
            "legendFormat": "{{name}} RX"
          },
          {
            "expr": "rate(container_network_transmit_bytes_total{name=~\".*-service\"}[5m])",
            "legendFormat": "{{name}} TX"
          }
        ],
        "yaxes": [
          {
            "format": "Bps"
          }
        ]
      },
      {
        "title": "ì»¨í…Œì´ë„ˆ ìƒíƒœ",
        "type": "stat",
        "targets": [
          {
            "expr": "count(container_last_seen{name=~\".*-service\"})"
          }
        ]
      }
    ]
  }
}
```

---

## ë³‘ëª© ì§€ì  ì°¾ê¸°

### 1. CPU ë³‘ëª©

**ì¦ìƒ**:
- API ì‘ë‹µ ì‹œê°„ ì¦ê°€
- docker statsì—ì„œ CPU 90% ì´ìƒ

**ì§„ë‹¨**:
```bash
# CPU ì‚¬ìš©ë¥  ë†’ì€ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}" | sort -k2 -rn | head -5

# ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í”„ë¡œì„¸ìŠ¤ í™•ì¸
docker exec container_id top -bn1

# JVM ìŠ¤ë ˆë“œ ë¤í”„
docker exec container_id jstack 1 > thread-dump.txt
```

**í•´ê²°**:
```yaml
# CPU ì¦ê°€
services:
  user-service:
    cpus: 2.0  # 1.0 â†’ 2.0

# ë˜ëŠ” ìŠ¤ì¼€ì¼ ì•„ì›ƒ
docker-compose up -d --scale user-service=3
```

### 2. ë©”ëª¨ë¦¬ ë³‘ëª©

**ì¦ìƒ**:
- OOM Killed (Exit Code 137)
- ìŠ¤ì™‘ ì‚¬ìš© ì¦ê°€

**ì§„ë‹¨**:
```bash
# ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  í™•ì¸
docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}\t{{.MemPerc}}"

# JVM í™ ë¤í”„
docker exec container_id jmap -dump:format=b,file=/tmp/heap.hprof 1
docker cp container_id:/tmp/heap.hprof ./heap.hprof
```

**í•´ê²°**:
```yaml
# ë©”ëª¨ë¦¬ ì¦ê°€
services:
  user-service:
    mem_limit: 2g  # 1g â†’ 2g
    environment:
      - JAVA_OPTS=-XX:MaxRAMPercentage=75.0
```

### 3. ë„¤íŠ¸ì›Œí¬ ë³‘ëª©

**ì¦ìƒ**:
- ë†’ì€ ë„¤íŠ¸ì›Œí¬ ì§€ì—°
- íŒ¨í‚· ì†ì‹¤

**ì§„ë‹¨**:
```bash
# ë„¤íŠ¸ì›Œí¬ I/O í™•ì¸
docker stats --no-stream --format "table {{.Name}}\t{{.NetIO}}"

# ë„¤íŠ¸ì›Œí¬ ì§€ì—° í…ŒìŠ¤íŠ¸
docker exec container_a ping -c 10 container_b

# ëŒ€ì—­í­ í…ŒìŠ¤íŠ¸
docker exec container_a iperf3 -c container_b
```

**í•´ê²°**:
- ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„ ë³€ê²½ (bridge â†’ host)
- ë„¤íŠ¸ì›Œí¬ ìµœì í™” ì„¤ì •

### 4. ë””ìŠ¤í¬ I/O ë³‘ëª©

**ì¦ìƒ**:
- ëŠë¦° ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬
- íŒŒì¼ ì½ê¸°/ì“°ê¸° ì§€ì—°

**ì§„ë‹¨**:
```bash
# ë””ìŠ¤í¬ I/O í™•ì¸
docker stats --no-stream --format "table {{.Name}}\t{{.BlockIO}}"

# ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
docker exec container_id df -h

# I/O ëŒ€ê¸° ì‹œê°„
docker exec container_id iostat -x 1 10
```

**í•´ê²°**:
```yaml
# SSD ì‚¬ìš©, I/O ì œí•œ í•´ì œ
services:
  postgres:
    volumes:
      - postgres-data:/var/lib/postgresql/data  # SSD ë³¼ë¥¨ ì‚¬ìš©
```

---

## ì•Œë¦¼ ì„¤ì •

### Prometheus Alert ê·œì¹™

```yaml
# prometheus/alerts.yml

groups:
  - name: container_alerts
    interval: 30s
    rules:
      # CPU ì‚¬ìš©ë¥  80% ì´ìƒ
      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ì»¨í…Œì´ë„ˆ CPU ì‚¬ìš©ë¥  ë†’ìŒ"
          description: "{{ $labels.name }} CPU ì‚¬ìš©ë¥ ì´ {{ $value }}% ì…ë‹ˆë‹¤."

      # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  90% ì´ìƒ
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ë†’ìŒ"
          description: "{{ $labels.name }} ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ {{ $value }}% ì…ë‹ˆë‹¤."

      # ì»¨í…Œì´ë„ˆ ë‹¤ìš´
      - alert: ContainerDown
        expr: up{job="cadvisor"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ì»¨í…Œì´ë„ˆ ë‹¤ìš´"
          description: "{{ $labels.instance }} ì»¨í…Œì´ë„ˆê°€ ë‹¤ìš´ë˜ì—ˆìŠµë‹ˆë‹¤."

      # ë””ìŠ¤í¬ ì‚¬ìš©ë¥  85% ì´ìƒ
      - alert: HighDiskUsage
        expr: (container_fs_usage_bytes / container_fs_limit_bytes) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ë””ìŠ¤í¬ ì‚¬ìš©ë¥  ë†’ìŒ"
          description: "{{ $labels.name }} ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ {{ $value }}% ì…ë‹ˆë‹¤."
```

### Alertmanager ì„¤ì •

```yaml
# alertmanager/alertmanager.yml

global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'slack'

receivers:
  # Slack ì•Œë¦¼
  - name: 'slack'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts'
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        send_resolved: true

  # ì´ë©”ì¼ ì•Œë¦¼
  - name: 'email'
    email_configs:
      - to: 'admin@lktrade.com'
        from: 'alertmanager@lktrade.com'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'alertmanager@lktrade.com'
        auth_password: 'password'
        headers:
          Subject: '[LK-Trade] {{ .GroupLabels.alertname }}'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname']
```

---

## ì‹¤ì „ ì˜ˆì œ: LK-Trade ëª¨ë‹ˆí„°ë§

### ëª¨ë‹ˆí„°ë§ ì‹œì‘

```bash
#!/bin/bash
# scripts/start-monitoring.sh

echo "ğŸ“Š LK-Trade ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì‹œì‘..."

# 1. ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì‹œì‘
docker-compose -f docker-compose.monitoring.yml up -d

# 2. ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸°
echo "â³ ì„œë¹„ìŠ¤ ì¤€ë¹„ ì¤‘..."
sleep 15

# 3. í—¬ìŠ¤ì²´í¬
echo "ğŸ¥ í—¬ìŠ¤ì²´í¬..."
curl -f http://localhost:8080/containers/ > /dev/null 2>&1 && echo "  âœ… cAdvisor" || echo "  âŒ cAdvisor"
curl -f http://localhost:9090/-/healthy > /dev/null 2>&1 && echo "  âœ… Prometheus" || echo "  âŒ Prometheus"
curl -f http://localhost:3000/api/health > /dev/null 2>&1 && echo "  âœ… Grafana" || echo "  âŒ Grafana"

echo ""
echo "âœ… ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì‹œì‘ ì™„ë£Œ!"
echo ""
echo "ğŸ“‹ ì ‘ì† ì •ë³´:"
echo "  - cAdvisor:    http://localhost:8080"
echo "  - Prometheus:  http://localhost:9090"
echo "  - Grafana:     http://localhost:3000 (admin/admin)"
echo "  - Alertmanager: http://localhost:9093"
```

### Makefile í†µí•©

```makefile
# Makefile

.PHONY: monitoring monitoring-stop monitoring-logs

# ëª¨ë‹ˆí„°ë§ ì‹œì‘
monitoring:
	@echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ ì‹œì‘..."
	@docker-compose -f docker-compose.monitoring.yml up -d
	@sleep 10
	@echo "âœ… ëª¨ë‹ˆí„°ë§ ì¤€ë¹„ ì™„ë£Œ"
	@echo ""
	@echo "ì ‘ì† URL:"
	@echo "  Grafana: http://localhost:3000"
	@echo "  Prometheus: http://localhost:9090"

# ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
monitoring-stop:
	@docker-compose -f docker-compose.monitoring.yml down

# ëª¨ë‹ˆí„°ë§ ë¡œê·¸
monitoring-logs:
	@docker-compose -f docker-compose.monitoring.yml logs -f
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: cAdvisorê°€ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŒ

**ì¦ìƒ**:
```
cAdvisor Web UIì—ì„œ ì»¨í…Œì´ë„ˆ ëª©ë¡ì´ ë¹„ì–´ìˆìŒ
```

**í•´ê²°**:
```yaml
# docker-compose.monitoring.yml
services:
  cadvisor:
    privileged: true  # ê¶Œí•œ ì¶”ê°€
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker ì†Œì¼“ ë§ˆìš´íŠ¸
```

### ë¬¸ì œ 2: Prometheusê°€ íƒ€ê²Ÿì„ ìŠ¤í¬ë©í•˜ì§€ ëª»í•¨

**ì§„ë‹¨**:
```bash
# Prometheus íƒ€ê²Ÿ ìƒíƒœ í™•ì¸
curl http://localhost:9090/api/v1/targets | jq
```

**í•´ê²°**:
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']  # ì»¨í…Œì´ë„ˆ ì´ë¦„ ì‚¬ìš©
```

### ë¬¸ì œ 3: Grafana ëŒ€ì‹œë³´ë“œì— ë°ì´í„°ê°€ ì—†ìŒ

**ì§„ë‹¨**:
1. Prometheusì—ì„œ ë°ì´í„° í™•ì¸: `http://localhost:9090/graph`
2. ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸: `up`

**í•´ê²°**:
- ë°ì´í„° ì†ŒìŠ¤ ì—°ê²° í™•ì¸
- PromQL ì¿¼ë¦¬ ìˆ˜ì •

---

## ë‹¤ìŒ ë‹¨ê³„

### 26. ë¡œê·¸ ê´€ë¦¬
- ë¡œê·¸ ë“œë¼ì´ë²„ ì¢…ë¥˜
- ì¤‘ì•™í™”ëœ ë¡œê·¸ ìˆ˜ì§‘
- ELK ìŠ¤íƒ

### í•™ìŠµ ìë£Œ

**ëª¨ë‹ˆí„°ë§**:
- [Prometheus ê³µì‹ ë¬¸ì„œ](https://prometheus.io/docs/introduction/overview/)
- [Grafana ê³µì‹ ë¬¸ì„œ](https://grafana.com/docs/)
- [cAdvisor GitHub](https://github.com/google/cadvisor)

---

**ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰** Docker ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì„ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤!