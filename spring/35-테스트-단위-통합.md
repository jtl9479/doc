# 35장: 테스트 (단위/통합) - 안전한 코드의 시작

> **"테스트는 선택이 아닌 필수입니다"**

---

## 📋 학습 목표

이 장을 학습하면 다음을 할 수 있습니다:

- 단위 테스트와 통합 테스트의 차이를 이해합니다
- JUnit 5와 AssertJ를 활용하여 테스트를 작성합니다
- Mockito로 의존성을 모킹할 수 있습니다
- @SpringBootTest로 통합 테스트를 구현합니다
- 테스트 커버리지를 높이고 TDD를 실천합니다

**예상 학습 시간**: 4-5시간
**난이도**: ⭐⭐⭐⭐ (중고급)

---

## 🤔 왜 테스트가 필요한가?

### 문제 상황: 테스트 없는 개발의 공포

#### 문제 1: 수정의 두려움

```java
// 기존 코드 수정
public double calculateDiscount(Order order) {
    // 로직 변경
    return order.getAmount() * 0.1;  // 10% → 15%로 변경하고 싶은데...
}

// 개발자의 고민
"이 코드를 수정하면 다른 곳이 망가지지 않을까?"
"어디서 이 메서드를 쓰는지 모르겠어..."
→ 수정 포기 또는 버그 발생
```

#### 문제 2: 회귀 버그

```java
// 버그 수정
public List<User> findActiveUsers() {
    return userRepository.findByStatus("ACTIVE");
}

// 2주 후 다른 개발자가 수정
public List<User> findActiveUsers() {
    return userRepository.findAll();  // 버그 재발!
}
```

#### 문제 3: 통합 시점의 충격

```
개발자 A: "내 코드는 잘 돌아가요"
개발자 B: "제 코드도 문제없어요"

통합 후...
→ 전체 시스템 다운
→ 원인 파악에 2일 소요
```

### 테스트의 해결책

```java
@Test
void calculateDiscount_should_return_10_percent() {
    // Given
    Order order = new Order(10000);

    // When
    double discount = calculator.calculateDiscount(order);

    // Then
    assertThat(discount).isEqualTo(1000);
}

// 로직 수정 후
public double calculateDiscount(Order order) {
    return order.getAmount() * 0.15;  // 변경
}

// 테스트 실패!
// Expected: 1000.0
// Actual: 1500.0
// → 즉시 발견, 즉시 수정
```

---

## 🌍 실생활 비유로 이해하는 테스트

### 비유 1: 자동차 안전 테스트

**테스트 없음:**
```
자동차 출시
→ 도로에서 바로 운행
→ 사고 발생
→ 리콜
```

**테스트 있음:**
```
[충돌 테스트]
- 정면 충돌: PASS
- 측면 충돌: PASS
- 전복 테스트: FAIL → 설계 수정
→ 안전한 차량 출시
```

### 비유 2: 건물 검사

**테스트 없음:**
```
건물 완공
→ 바로 입주
→ 붕괴 위험
```

**테스트 있음:**
```
[안전 검사]
- 구조 안전성: PASS
- 전기 안전: PASS
- 소방 시설: FAIL → 보완 후 통과
→ 안전한 건물 사용
```

### 비유 3: 신약 개발

**테스트 없음:**
```
약 개발 완료
→ 바로 판매
→ 부작용 발생
```

**테스트 있음:**
```
[임상 시험]
1차: 실험실 테스트 (단위 테스트)
2차: 동물 실험 (통합 테스트)
3차: 인체 임상 (E2E 테스트)
→ 안전한 약 출시
```

---

## 💡 테스트 핵심 개념

### 1️⃣ 초급: 단위 테스트 (Unit Test)

#### JUnit 5 기본

```java
class CalculatorTest {

    @Test
    @DisplayName("두 숫자를 더하면 합계가 반환된다")
    void add() {
        // Given
        Calculator calculator = new Calculator();

        // When
        int result = calculator.add(2, 3);

        // Then
        assertThat(result).isEqualTo(5);
    }

    @Test
    void divide_by_zero_should_throw_exception() {
        Calculator calculator = new Calculator();

        assertThatThrownBy(() -> calculator.divide(10, 0))
            .isInstanceOf(ArithmeticException.class)
            .hasMessage("/ by zero");
    }
}
```

#### AssertJ 활용

```java
@Test
void user_test() {
    User user = new User("홍길동", 30);

    // 기본 검증
    assertThat(user.getName()).isEqualTo("홍길동");
    assertThat(user.getAge()).isGreaterThan(18);

    // 컬렉션 검증
    List<String> hobbies = user.getHobbies();
    assertThat(hobbies)
        .hasSize(3)
        .contains("독서", "운동")
        .doesNotContain("게임");

    // 예외 검증
    assertThatThrownBy(() -> user.setAge(-1))
        .isInstanceOf(IllegalArgumentException.class)
        .hasMessageContaining("나이는 0 이상");
}
```

### 2️⃣ 중급: Mockito - 의존성 모킹

#### 기본 Mock

```java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {

    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private UserService userService;

    @Test
    void find_user_by_id() {
        // Given
        User mockUser = new User(1L, "홍길동");
        when(userRepository.findById(1L))
            .thenReturn(Optional.of(mockUser));

        // When
        User user = userService.findById(1L);

        // Then
        assertThat(user.getName()).isEqualTo("홍길동");
        verify(userRepository, times(1)).findById(1L);
    }

    @Test
    void user_not_found_should_throw_exception() {
        // Given
        when(userRepository.findById(999L))
            .thenReturn(Optional.empty());

        // When & Then
        assertThatThrownBy(() -> userService.findById(999L))
            .isInstanceOf(UserNotFoundException.class);
    }
}
```

#### ArgumentCaptor

```java
@Test
void save_user_should_set_created_date() {
    // Given
    UserRequest request = new UserRequest("홍길동", "hong@example.com");
    ArgumentCaptor<User> userCaptor = ArgumentCaptor.forClass(User.class);

    // When
    userService.createUser(request);

    // Then
    verify(userRepository).save(userCaptor.capture());
    User savedUser = userCaptor.getValue();
    assertThat(savedUser.getCreatedAt()).isNotNull();
    assertThat(savedUser.getName()).isEqualTo("홍길동");
}
```

### 3️⃣ 고급: 통합 테스트

#### @SpringBootTest

```java
@SpringBootTest
@Transactional
class UserIntegrationTest {

    @Autowired
    private UserService userService;

    @Autowired
    private UserRepository userRepository;

    @Test
    void user_crud_integration_test() {
        // Create
        User user = userService.createUser("홍길동", "hong@example.com");
        assertThat(user.getId()).isNotNull();

        // Read
        User found = userService.findById(user.getId());
        assertThat(found.getName()).isEqualTo("홍길동");

        // Update
        userService.updateName(user.getId(), "김철수");
        User updated = userService.findById(user.getId());
        assertThat(updated.getName()).isEqualTo("김철수");

        // Delete
        userService.delete(user.getId());
        assertThatThrownBy(() -> userService.findById(user.getId()))
            .isInstanceOf(UserNotFoundException.class);
    }
}
```

#### @WebMvcTest (Controller 테스트)

```java
@WebMvcTest(UserController.class)
class UserControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private UserService userService;

    @Test
    void get_user_api_test() throws Exception {
        // Given
        User user = new User(1L, "홍길동");
        when(userService.findById(1L)).thenReturn(user);

        // When & Then
        mockMvc.perform(get("/api/users/1"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.id").value(1))
            .andExpect(jsonPath("$.name").value("홍길동"))
            .andDo(print());
    }

    @Test
    void create_user_api_test() throws Exception {
        // Given
        UserRequest request = new UserRequest("홍길동", "hong@example.com");
        User createdUser = new User(1L, "홍길동");
        when(userService.createUser(any())).thenReturn(createdUser);

        // When & Then
        mockMvc.perform(post("/api/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content("""
                    {
                      "name": "홍길동",
                      "email": "hong@example.com"
                    }
                    """))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.id").value(1));
    }
}
```

---

## 🛠️ 기본 실습

### 실습 1: Service 계층 테스트

```java
@ExtendWith(MockitoExtension.class)
class OrderServiceTest {

    @Mock
    private OrderRepository orderRepository;

    @Mock
    private ProductRepository productRepository;

    @Mock
    private PaymentService paymentService;

    @InjectMocks
    private OrderService orderService;

    @Test
    @DisplayName("주문 생성 시 재고가 충분하면 성공한다")
    void create_order_with_sufficient_stock() {
        // Given
        Long productId = 1L;
        int quantity = 2;
        Product product = Product.builder()
            .id(productId)
            .name("상품A")
            .price(10000)
            .stock(10)
            .build();

        when(productRepository.findById(productId))
            .thenReturn(Optional.of(product));
        when(orderRepository.save(any(Order.class)))
            .thenAnswer(invocation -> invocation.getArgument(0));

        // When
        Order order = orderService.createOrder(productId, quantity);

        // Then
        assertThat(order).isNotNull();
        assertThat(order.getQuantity()).isEqualTo(2);
        assertThat(order.getTotalAmount()).isEqualTo(20000);

        verify(productRepository).findById(productId);
        verify(orderRepository).save(any(Order.class));
    }

    @Test
    @DisplayName("주문 생성 시 재고가 부족하면 예외가 발생한다")
    void create_order_with_insufficient_stock() {
        // Given
        Long productId = 1L;
        int quantity = 20;
        Product product = Product.builder()
            .id(productId)
            .stock(10)  // 재고 부족
            .build();

        when(productRepository.findById(productId))
            .thenReturn(Optional.of(product));

        // When & Then
        assertThatThrownBy(() -> orderService.createOrder(productId, quantity))
            .isInstanceOf(InsufficientStockException.class)
            .hasMessageContaining("재고가 부족합니다");

        verify(orderRepository, never()).save(any());
    }
}
```

### 실습 2: Repository 테스트

```java
@DataJpaTest
class UserRepositoryTest {

    @Autowired
    private UserRepository userRepository;

    @Test
    void find_by_email_test() {
        // Given
        User user = User.builder()
            .name("홍길동")
            .email("hong@example.com")
            .build();
        userRepository.save(user);

        // When
        Optional<User> found = userRepository.findByEmail("hong@example.com");

        // Then
        assertThat(found).isPresent();
        assertThat(found.get().getName()).isEqualTo("홍길동");
    }

    @Test
    void find_active_users_test() {
        // Given
        userRepository.save(User.builder().name("User1").status("ACTIVE").build());
        userRepository.save(User.builder().name("User2").status("ACTIVE").build());
        userRepository.save(User.builder().name("User3").status("INACTIVE").build());

        // When
        List<User> activeUsers = userRepository.findByStatus("ACTIVE");

        // Then
        assertThat(activeUsers).hasSize(2);
        assertThat(activeUsers).extracting("status").containsOnly("ACTIVE");
    }
}
```

### 실습 3: TestContainers

```gradle
dependencies {
    testImplementation 'org.testcontainers:testcontainers:1.19.3'
    testImplementation 'org.testcontainers:mysql:1.19.3'
    testImplementation 'org.testcontainers:junit-jupiter:1.19.3'
}
```

```java
@SpringBootTest
@Testcontainers
class UserIntegrationWithTestContainersTest {

    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
        .withDatabaseName("testdb")
        .withUsername("test")
        .withPassword("test");

    @DynamicPropertySource
    static void properties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword());
    }

    @Autowired
    private UserRepository userRepository;

    @Test
    void integration_test_with_real_database() {
        // Given
        User user = new User("홍길동", "hong@example.com");

        // When
        User saved = userRepository.save(user);

        // Then
        assertThat(saved.getId()).isNotNull();
        assertThat(userRepository.count()).isEqualTo(1);
    }
}
```

---

## 👨‍💻 주니어 개발자 실전 시나리오

### 시나리오: "TDD로 기능 개발"

**요구사항:**
```
사용자 등록 시 이메일 중복 체크 필요
```

**1단계: 테스트 작성 (Red)**

```java
@Test
void register_with_duplicate_email_should_fail() {
    // Given
    userService.register("hong@example.com", "password");

    // When & Then
    assertThatThrownBy(() ->
        userService.register("hong@example.com", "password2"))
        .isInstanceOf(DuplicateEmailException.class);
}
```

**실행 결과: 실패 (코드가 없음)**

**2단계: 최소 코드 작성 (Green)**

```java
public User register(String email, String password) {
    if (userRepository.existsByEmail(email)) {
        throw new DuplicateEmailException("이미 사용 중인 이메일입니다");
    }
    return userRepository.save(new User(email, password));
}
```

**실행 결과: 성공**

**3단계: 리팩토링 (Refactor)**

```java
public User register(String email, String password) {
    validateDuplicateEmail(email);
    return userRepository.save(new User(email, password));
}

private void validateDuplicateEmail(String email) {
    if (userRepository.existsByEmail(email)) {
        throw new DuplicateEmailException("이미 사용 중인 이메일입니다");
    }
}
```

---

## 🏢 기업 사례: Google

### 배경

Google은 "테스트 없는 코드는 레거시 코드"라는 철학을 가지고 있습니다.

**테스트 전략:**
- 70% 단위 테스트
- 20% 통합 테스트
- 10% E2E 테스트

```java
// Google의 테스트 가이드
@Test
public void shouldReturnTrueForEvenNumber() {
    // GIVEN
    int number = 4;

    // WHEN
    boolean result = MathUtils.isEven(number);

    // THEN
    assertThat(result).isTrue();
}
```

**효과:**
- 버그 발견 시간: 1주 → 1시간
- 코드 품질 향상
- 리팩토링 자신감

---

## ❓ FAQ

### Q1. 테스트 커버리지 목표는?

**A:**

```
일반적인 가이드:
- 라인 커버리지: 80% 이상
- 브랜치 커버리지: 70% 이상

하지만 중요한 것은 숫자가 아닌 품질!
```

```gradle
// JaCoCo 설정
plugins {
    id 'jacoco'
}

test {
    finalizedBy jacocoTestReport
}

jacocoTestReport {
    dependsOn test
    reports {
        html.required = true
    }
}
```

### Q2. Mock vs Spy 차이는?

**A:**

```java
// Mock: 완전히 가짜 객체
@Mock
private UserRepository userRepository;
// 모든 메서드가 기본값 반환 (null, 0 등)

// Spy: 실제 객체 기반
@Spy
private UserService userService;
// 실제 메서드 호출, 일부만 stubbing 가능

@Test
void spy_example() {
    // 일부만 모킹
    doReturn(mockUser).when(userService).findById(1L);

    // 나머지는 실제 메서드 실행
    userService.updateName(1L, "새이름");
}
```

### Q3. 통합 테스트는 느린데 어떻게 해야 하나요?

**A:** 프로파일과 태그 활용

```java
// 빠른 테스트
@Test
@Tag("fast")
void unit_test() {
    // 0.1초
}

// 느린 테스트
@Test
@Tag("slow")
@SpringBootTest
void integration_test() {
    // 5초
}
```

```bash
# 빠른 테스트만 실행
./gradlew test --tests "*" -Dgroups=fast

# CI/CD에서 모든 테스트
./gradlew test
```

### Q4. given-when-then 패턴이 뭔가요?

**A:**

```java
@Test
void test_pattern() {
    // Given (준비): 테스트 데이터 준비
    User user = new User("홍길동");

    // When (실행): 테스트할 동작 실행
    String name = user.getName();

    // Then (검증): 결과 검증
    assertThat(name).isEqualTo("홍길동");
}
```

### Q5. 테스트 작성 시간이 부족한데요?

**A:**

```
우선순위:
1. 핵심 비즈니스 로직 (필수)
2. 복잡한 알고리즘 (필수)
3. 버그 재현 테스트 (필수)
4. Controller (선택)
5. 단순 CRUD (선택)

시간 투자 = 미래 시간 절약
버그 수정 시간 >> 테스트 작성 시간
```

---

## 💼 면접 질문 TOP 5

### ⭐ 초급 1: 단위 테스트와 통합 테스트의 차이는?

**답변:**

| 구분 | 단위 테스트 | 통합 테스트 |
|-----|-----------|-----------|
| 범위 | 단일 클래스/메서드 | 여러 컴포넌트 |
| 의존성 | Mock | 실제 의존성 |
| 속도 | 빠름 (ms) | 느림 (초) |
| 예시 | `@Test` | `@SpringBootTest` |

### ⭐ 초급 2: Mock과 Stub의 차이는?

**답변:**

```java
// Mock: 호출 검증
@Mock
UserRepository repo;
verify(repo, times(1)).save(any());

// Stub: 반환값 설정
when(repo.findById(1L)).thenReturn(user);
```

### ⭐⭐ 중급 1: given-when-then 패턴이란?

**답변:**

```java
@Test
void pattern_example() {
    // Given: 테스트 준비
    User user = new User("홍길동");

    // When: 실행
    String name = user.getName();

    // Then: 검증
    assertThat(name).isEqualTo("홍길동");
}
```

### ⭐⭐ 중급 2: @WebMvcTest와 @SpringBootTest 차이는?

**답변:**

```java
// @WebMvcTest: Controller만 테스트
@WebMvcTest(UserController.class)
// - 빠름
// - MockMvc 사용
// - Service는 @MockBean

// @SpringBootTest: 전체 컨텍스트
@SpringBootTest
// - 느림
// - 실제 환경과 유사
// - 통합 테스트
```

### ⭐⭐ 중급 3: TDD의 장점은?

**답변:**

```
1. 요구사항 명확화
   - 테스트 = 명세서

2. 설계 개선
   - 테스트하기 쉬운 코드 = 좋은 설계

3. 리팩토링 자신감
   - 테스트가 안전망 역할

4. 버그 조기 발견
   - 개발 중 버그 발견

5. 문서화
   - 테스트 = 사용 예시
```

---

## 🎯 다음 단계

테스트를 마쳤다면:

1. **36장: 프로파일 관리** - 환경별 설정
2. **E2E 테스트** - Selenium, Cypress
3. **성능 테스트** - JMeter, Gatling

---

**🎓 학습 완료 체크리스트:**

- [ ] JUnit 5 기본 테스트 작성
- [ ] Mockito로 모킹
- [ ] @SpringBootTest 통합 테스트
- [ ] @WebMvcTest Controller 테스트
- [ ] given-when-then 패턴
- [ ] TDD 실습

**다음 장에서는 프로파일 관리를 마스터합니다!** 🚀
